import { MatchType, } from '../models';
/**
 * Higher order function that returns a function that extracts Match Intervals from a Result
 * @param type name of the match type to extract ( identical | minorChanges | relatedMeaning)
 * @param subject name of the subject to extract from ( source | suspected)
 */
export const createWordIntervalsFrom = (type, subject) => ({ result }) => {
    if (!result) {
        return [];
    }
    const { starts, lengths } = result.text.comparison[type][subject].words;
    return starts.map((start, i) => ({
        start,
        end: start + lengths[i] + 1,
        type: MatchType[type],
    }));
};
/**
 * merge consecutive intervals based on start and end index
 * while prioritizing type ( lower is better )
 * this function assumes all intervals are non-distinct (has no gaps)
 */
export const mergeWordIntervals = (matches) => matches.reduce((joined, next) => {
    if (joined.length === 0) {
        joined.push(next);
        return joined;
    }
    const prev = joined[joined.length - 1];
    // equal points
    // [---p---]
    // [---n---]
    if (prev.end === next.end && prev.start === next.start) {
        if (next.type < prev.type) {
            joined[joined.length - 1] = { ...prev, type: next.type };
        }
    }
    // same start inclusion
    // [---p---]  or
    // [--n--]
    else if (next.start === prev.start && next.end < prev.end) {
        if (next.type < prev.type) {
            joined[joined.length - 1] = next;
            joined.push({ ...prev, start: next.start });
        }
    }
    // same end inclusion
    // [---p---]
    // 	[--n--]
    else if (prev.end === next.end && prev.start < next.start) {
        if (next.type < prev.type) {
            joined[joined.length - 1] = { ...prev, end: next.start };
            joined.push(next);
        }
    }
    // complete inclusion
    // [---p---]
    // [--n--]
    else if (prev.start < next.start && next.end < prev.end) {
        if (next.type < prev.type) {
            joined[joined.length - 1] = { ...prev, end: next.start };
            joined.push(next);
            joined.push({ ...prev, start: next.end });
        }
    }
    // intersecting or adjacent
    // [---p---]      or [---p---]
    //     [---n---]              [---n---]
    else if (next.start > prev.start && next.end > prev.end) {
        if (next.type === prev.type) {
            joined[joined.length - 1] = { ...prev, end: next.end };
        }
        else if (next.type < prev.type) {
            joined[joined.length - 1] = { ...prev, end: next.start };
            joined.push(next);
        }
        else if (next.type > prev.type) {
            joined.push({ ...next, start: prev.end });
        }
    }
    // same start
    // [--p--]
    // [---n---]
    else if (prev.start === next.start && prev.end < next.end) {
        if (next.type <= prev.type) {
            joined[joined.length - 1] = next;
        }
        else {
            joined.push({ ...next, start: prev.end });
        }
    }
    else {
        joined.push(next);
    }
    return joined;
}, []);
/**
 * split an array of matches into nests where each nest is distinct and nested items are all overlapped
 * @param matches the matches to split
 */
export const findNests = (matches) => {
    if (matches.length === 0) {
        return [[]];
    }
    matches.sort((a, b) => a.start - b.start || a.end - b.end || a.type - b.type);
    const nests = [[matches[0]]];
    let nestFurthestEnd = matches[0].end;
    for (const interval of matches) {
        if (interval.start > nestFurthestEnd) {
            nests.push([interval]);
            nestFurthestEnd = interval.end;
        }
        else {
            nests[nests.length - 1].push(interval);
            nestFurthestEnd = Math.max(nestFurthestEnd, interval.end);
        }
    }
    return nests;
};
/**
 * merge overlapping matches in a list of matches
 * @param matches the list of matches
 */
export const mergeWords = (matches) => {
    return findNests(matches).reduce((all, nest) => all.concat(mergeWordIntervals(nest)), []);
};
/**
 * calculate statistics using the scan's `completeResult` and a list of `results`
 * @param completeResult the report's complete result
 * @param results the results to calculate statistics from
 */
export const calculateStatistics = (completeResult, results, options) => {
    const { totalWords, totalExcluded } = completeResult.scannedDocument;
    const identical = options.showIdentical ? results.flatMap(createWordIntervalsFrom('identical', 'source')) : [];
    const minorChanges = options.showMinorChanges
        ? results.flatMap(createWordIntervalsFrom('minorChanges', 'source'))
        : [];
    const relatedMeaning = options.showRelated
        ? results.flatMap(createWordIntervalsFrom('relatedMeaning', 'source'))
        : [];
    const withOutoverlaps = mergeWords([...relatedMeaning, ...minorChanges, ...identical]);
    const identicalCount = withOutoverlaps
        .filter(match => match.type === MatchType.identical)
        .reduce((total, elem) => total + (elem.end - elem.start), 0);
    const minorChangesCount = withOutoverlaps
        .filter(match => match.type === MatchType.minorChanges)
        .reduce((total, elem) => total + (elem.end - elem.start), 0);
    const relatedMeaningCount = withOutoverlaps
        .filter(match => match.type === MatchType.relatedMeaning)
        .reduce((total, elem) => total + (elem.end - elem.start), 0);
    let aggregatedScore = Math.min(1, (identicalCount + relatedMeaningCount + minorChangesCount) / (totalWords - totalExcluded));
    aggregatedScore = isNaN(aggregatedScore) ? 0 : aggregatedScore;
    return {
        aggregatedScore,
        identical: identicalCount,
        relatedMeaning: relatedMeaningCount,
        minorChanges: minorChangesCount,
        omittedWords: totalExcluded,
        total: totalWords,
    };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGlzdGljcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3BsYWdpYXJpc20tcmVwb3J0L3NyYy9saWIvcGxhZ2lhcmlzbS1yZXBvcnQvdXRpbHMvc3RhdGlzdGljcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBS04sU0FBUyxHQUlULE1BQU0sV0FBVyxDQUFDO0FBRW5COzs7O0dBSUc7QUFDSCxNQUFNLENBQUMsTUFBTSx1QkFBdUIsR0FDbkMsQ0FBQyxJQUFtQixFQUFFLE9BQXlCLEVBQUUsRUFBRSxDQUNuRCxDQUFDLEVBQUUsTUFBTSxFQUFjLEVBQUUsRUFBRTtJQUMxQixJQUFJLENBQUMsTUFBTSxFQUFFO1FBQ1osT0FBTyxFQUFFLENBQUM7S0FDVjtJQUNELE1BQU0sRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsS0FBSyxDQUFDO0lBQ3hFLE9BQU8sTUFBTSxDQUFDLEdBQUcsQ0FDaEIsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxFQUFTLEVBQUUsQ0FBQyxDQUFDO1FBQ3JCLEtBQUs7UUFDTCxHQUFHLEVBQUUsS0FBSyxHQUFHLE9BQU8sQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDO1FBQzNCLElBQUksRUFBRSxTQUFTLENBQUMsSUFBSSxDQUFDO0tBQ3JCLENBQUMsQ0FDRixDQUFDO0FBQ0gsQ0FBQyxDQUFDO0FBRUg7Ozs7R0FJRztBQUNILE1BQU0sQ0FBQyxNQUFNLGtCQUFrQixHQUFHLENBQUMsT0FBZ0IsRUFBVyxFQUFFLENBQy9ELE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFlLEVBQUUsSUFBVyxFQUFFLEVBQUU7SUFDL0MsSUFBSSxNQUFNLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtRQUN4QixNQUFNLENBQUMsSUFBSSxDQUFDLElBQUks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ZTtTQUN2QyxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsSUFBSSxLQUFLLFNBQVMsQ0FBQyxZQUFZLENBQUM7U0FDdEQsTUFBTSxDQUFDLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxFQUFFLENBQUMsS0FBSyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDOUQsTUFBTSxtQkFBbUIsR0FBRyxlQUFlO1NBQ3pDLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxJQUFJLEtBQUssU0FBUyxDQUFDLGNBQWMsQ0FBQztTQUN4RCxNQUFNLENBQUMsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUU5RCxJQUFJLGVBQWUsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUM3QixDQUFDLEVBQ0QsQ0FBQyxjQUFjLEdBQUcsbUJBQW1CLEdBQUcsaUJBQWlCLENBQUMsR0FBRyxDQUFDLFVBQVUsR0FBRyxhQUFhLENBQUMsQ0FDekYsQ0FBQztJQUNGLGVBQWUsR0FBRyxLQUFLLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsZUFBZSxDQUFDO0lBRS9ELE9BQU87UUFDTixlQUFlO1FBQ2YsU0FBUyxFQUFFLGNBQWM7UUFDekIsY0FBYyxFQUFFLG1CQUFtQjtRQUNuQyxZQUFZLEVBQUUsaUJBQWlCO1FBQy9CLFlBQVksRUFBRSxhQUFhO1FBQzNCLEtBQUssRUFBRSxVQUFVO0tBQ2pCLENBQUM7QUFDSCxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuXHRNYXRjaCxcblx0Q29tcGFyaXNvbktleSxcblx0U3ViamVjdFJlc3VsdEtleSxcblx0UmVzdWx0SXRlbSxcblx0TWF0Y2hUeXBlLFxuXHRDb21wbGV0ZVJlc3VsdCxcblx0UmVwb3J0U3RhdGlzdGljcyxcblx0Q29weWxlYWtzUmVwb3J0T3B0aW9ucyxcbn0gZnJvbSAnLi4vbW9kZWxzJztcblxuLyoqXG4gKiBIaWdoZXIgb3JkZXIgZnVuY3Rpb24gdGhhdCByZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCBleHRyYWN0cyBNYXRjaCBJbnRlcnZhbHMgZnJvbSBhIFJlc3VsdFxuICogQHBhcmFtIHR5cGUgbmFtZSBvZiB0aGUgbWF0Y2ggdHlwZSB0byBleHRyYWN0ICggaWRlbnRpY2FsIHwgbWlub3JDaGFuZ2VzIHwgcmVsYXRlZE1lYW5pbmcpXG4gKiBAcGFyYW0gc3ViamVjdCBuYW1lIG9mIHRoZSBzdWJqZWN0IHRvIGV4dHJhY3QgZnJvbSAoIHNvdXJjZSB8IHN1c3BlY3RlZClcbiAqL1xuZXhwb3J0IGNvbnN0IGNyZWF0ZVdvcmRJbnRlcnZhbHNGcm9tID1cblx0KHR5cGU6IENvbXBhcmlzb25LZXksIHN1YmplY3Q6IFN1YmplY3RSZXN1bHRLZXkpID0+XG5cdCh7IHJlc3VsdCB9OiBSZXN1bHRJdGVtKSA9PiB7XG5cdFx0aWYgKCFyZXN1bHQpIHtcblx0XHRcdHJldHVybiBbXTtcblx0XHR9XG5cdFx0Y29uc3QgeyBzdGFydHMsIGxlbmd0aHMgfSA9IHJlc3VsdC50ZXh0LmNvbXBhcmlzb25bdHlwZV1bc3ViamVjdF0ud29yZHM7XG5cdFx0cmV0dXJuIHN0YXJ0cy5tYXAoXG5cdFx0XHQoc3RhcnQsIGkpOiBNYXRjaCA9PiAoe1xuXHRcdFx0XHRzdGFydCxcblx0XHRcdFx0ZW5kOiBzdGFydCArIGxlbmd0aHNbaV0gKyAxLFxuXHRcdFx0XHR0eXBlOiBNYXRjaFR5cGVbdHlwZV0sXG5cdFx0XHR9KVxuXHRcdCk7XG5cdH07XG5cbi8qKlxuICogbWVyZ2UgY29uc2VjdXRpdmUgaW50ZXJ2YWxzIGJhc2VkIG9uIHN0YXJ0IGFuZCBlbmQgaW5kZXhcbiAqIHdoaWxlIHByaW9yaXRpemluZyB0eXBlICggbG93ZXIgaXMgYmV0dGVyIClcbiAqIHRoaXMgZnVuY3Rpb24gYXNzdW1lcyBhbGwgaW50ZXJ2YWxzIGFyZSBub24tZGlzdGluY3QgKGhhcyBubyBnYXBzKVxuICovXG5leHBvcnQgY29uc3QgbWVyZ2VXb3JkSW50ZXJ2YWxzID0gKG1hdGNoZXM6IE1hdGNoW10pOiBNYXRjaFtdID0+XG5cdG1hdGNoZXMucmVkdWNlKChqb2luZWQ6IE1hdGNoW10sIG5leHQ6IE1hdGNoKSA9PiB7XG5cdFx0aWYgKGpvaW5lZC5sZW5ndGggPT09IDApIHtcblx0XHRcdGpvaW5lZC5wdXNoKG5leHQpO1xuXHRcdFx0cmV0dXJuIGpvaW5lZDtcblx0XHR9XG5cdFx0Y29uc3QgcHJldiA9IGpvaW5lZFtqb2luZWQubGVuZ3RoIC0gMV07XG5cblx0XHQvLyBlcXVhbCBwb2ludHNcblx0XHQvLyBbLS0tcC0tLV1cblx0XHQvLyBbLS0tbi0tLV1cblx0XHRpZiAocHJldi5lbmQgPT09IG5leHQuZW5kICYmIHByZXYuc3RhcnQgPT09IG5leHQuc3RhcnQpIHtcblx0XHRcdGlmIChuZXh0LnR5cGUgPCBwcmV2LnR5cGUpIHtcblx0XHRcdFx0am9pbmVkW2pvaW5lZC5sZW5ndGggLSAxXSA9IHsgLi4ucHJldiwgdHlwZTogbmV4dC50eXBlIH07XG5cdFx0XHR9XG5cdFx0fVxuXHRcdC8vIHNhbWUgc3RhcnQgaW5jbHVzaW9uXG5cdFx0Ly8gWy0tLXAtLS1dICBvclxuXHRcdC8vIFstLW4tLV1cblx0XHRlbHNlIGlmIChuZXh0LnN0YXJ0ID09PSBwcmV2LnN0YXJ0ICYmIG5leHQuZW5kIDwgcHJldi5lbmQpIHtcblx0XHRcdGlmIChuZXh0LnR5cGUgPCBwcmV2LnR5cGUpIHtcblx0XHRcdFx0am9pbmVkW2pvaW5lZC5sZW5ndGggLSAxXSA9IG5leHQ7XG5cdFx0XHRcdGpvaW5lZC5wdXNoKHsgLi4ucHJldiwgc3RhcnQ6IG5leHQuc3RhcnQgfSk7XG5cdFx0XHR9XG5cdFx0fVxuXHRcdC8vIHNhbWUgZW5kIGluY2x1c2lvblxuXHRcdC8vIFstLS1wLS0tXVxuXHRcdC8vIFx0Wy0tbi0tXVxuXHRcdGVsc2UgaWYgKHByZXYuZW5kID09PSBuZXh0LmVuZCAmJiBwcmV2LnN0YXJ0IDwgbmV4dC5zdGFydCkge1xuXHRcdFx0aWYgKG5leHQudHlwZSA8IHByZXYudHlwZSkge1xuXHRcdFx0XHRqb2luZWRbam9pbmVkLmxlbmd0aCAtIDFdID0geyAuLi5wcmV2LCBlbmQ6IG5leHQuc3RhcnQgfTtcblx0XHRcdFx0am9pbmVkLnB1c2gobmV4dCk7XG5cdFx0XHR9XG5cdFx0fVxuXHRcdC8vIGNvbXBsZXRlIGluY2x1c2lvblxuXHRcdC8vIFstLS1wLS0tXVxuXHRcdC8vIFstLW4tLV1cblx0XHRlbHNlIGlmIChwcmV2LnN0YXJ0IDwgbmV4dC5zdGFydCAmJiBuZXh0LmVuZCA8IHByZXYuZW5kKSB7XG5cdFx0XHRpZiAobmV4dC50eXBlIDwgcHJldi50eXBlKSB7XG5cdFx0XHRcdGpvaW5lZFtqb2luZWQubGVuZ3RoIC0gMV0gPSB7IC4uLnByZXYsIGVuZDogbmV4dC5zdGFydCB9O1xuXHRcdFx0XHRqb2luZWQucHVzaChuZXh0KTtcblx0XHRcdFx0am9pbmVkLnB1c2goeyAuLi5wcmV2LCBzdGFydDogbmV4dC5lbmQgfSk7XG5cdFx0XHR9XG5cdFx0fVxuXHRcdC8vIGludGVyc2VjdGluZyBvciBhZGphY2VudFxuXHRcdC8vIFstLS1wLS0tXSAgICAgIG9yIFstLS1wLS0tXVxuXHRcdC8vICAgICBbLS0tbi0tLV0gICAgICAgICAgICAgIFstLS1uLS0tXVxuXHRcdGVsc2UgaWYgKG5leHQuc3RhcnQgPiBwcmV2LnN0YXJ0ICYmIG5leHQuZW5kID4gcHJldi5lbmQpIHtcblx0XHRcdGlmIChuZXh0LnR5cGUgPT09IHByZXYudHlwZSkge1xuXHRcdFx0XHRqb2luZWRbam9pbmVkLmxlbmd0aCAtIDFdID0geyAuLi5wcmV2LCBlbmQ6IG5leHQuZW5kIH07XG5cdFx0XHR9IGVsc2UgaWYgKG5leHQudHlwZSA8IHByZXYudHlwZSkge1xuXHRcdFx0XHRqb2luZWRbam9pbmVkLmxlbmd0aCAtIDFdID0geyAuLi5wcmV2LCBlbmQ6IG5leHQuc3RhcnQgfTtcblx0XHRcdFx0am9pbmVkLnB1c2gobmV4dCk7XG5cdFx0XHR9IGVsc2UgaWYgKG5leHQudHlwZSA+IHByZXYudHlwZSkge1xuXHRcdFx0XHRqb2luZWQucHVzaCh7IC4uLm5leHQsIHN0YXJ0OiBwcmV2LmVuZCB9KTtcblx0XHRcdH1cblx0XHR9XG5cdFx0Ly8gc2FtZSBzdGFydFxuXHRcdC8vIFstLXAtLV1cblx0XHQvLyBbLS0tbi0tLV1cblx0XHRlbHNlIGlmIChwcmV2LnN0YXJ0ID09PSBuZXh0LnN0YXJ0ICYmIHByZXYuZW5kIDwgbmV4dC5lbmQpIHtcblx0XHRcdGlmIChuZXh0LnR5cGUgPD0gcHJldi50eXBlKSB7XG5cdFx0XHRcdGpvaW5lZFtqb2luZWQubGVuZ3RoIC0gMV0gPSBuZXh0O1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0am9pbmVkLnB1c2goeyAuLi5uZXh0LCBzdGFydDogcHJldi5lbmQgfSk7XG5cdFx0XHR9XG5cdFx0fSBlbHNlIHtcblx0XHRcdGpvaW5lZC5wdXNoKG5leHQpO1xuXHRcdH1cblx0XHRyZXR1cm4gam9pbmVkO1xuXHR9LCBbXSk7XG5cbi8qKlxuICogc3BsaXQgYW4gYXJyYXkgb2YgbWF0Y2hlcyBpbnRvIG5lc3RzIHdoZXJlIGVhY2ggbmVzdCBpcyBkaXN0aW5jdCBhbmQgbmVzdGVkIGl0ZW1zIGFyZSBhbGwgb3ZlcmxhcHBlZFxuICogQHBhcmFtIG1hdGNoZXMgdGhlIG1hdGNoZXMgdG8gc3BsaXRcbiAqL1xuZXhwb3J0IGNvbnN0IGZpbmROZXN0cyA9IChtYXRjaGVzOiBNYXRjaFtdKTogTWF0Y2hbXVtdID0+IHtcblx0aWYgKG1hdGNoZXMubGVuZ3RoID09PSAwKSB7XG5cdFx0cmV0dXJuIFtbXV07XG5cdH1cblx0bWF0Y2hlcy5zb3J0KChhLCBiKSA9PiBhLnN0YXJ0IC0gYi5zdGFydCB8fCBhLmVuZCAtIGIuZW5kIHx8IGEudHlwZSAtIGIudHlwZSk7XG5cdGNvbnN0IG5lc3RzOiBNYXRjaFtdW10gPSBbW21hdGNoZXNbMF1dXTtcblx0bGV0IG5lc3RGdXJ0aGVzdEVuZCA9IG1hdGNoZXNbMF0uZW5kO1xuXHRmb3IgKGNvbnN0IGludGVydmFsIG9mIG1hdGNoZXMpIHtcblx0XHRpZiAoaW50ZXJ2YWwuc3RhcnQgPiBuZXN0RnVydGhlc3RFbmQpIHtcblx0XHRcdG5lc3RzLnB1c2goW2ludGVydmFsXSk7XG5cdFx0XHRuZXN0RnVydGhlc3RFbmQgPSBpbnRlcnZhbC5lbmQ7XG5cdFx0fSBlbHNlIHtcblx0XHRcdG5lc3RzW25lc3RzLmxlbmd0aCAtIDFdLnB1c2goaW50ZXJ2YWwpO1xuXHRcdFx0bmVzdEZ1cnRoZXN0RW5kID0gTWF0aC5tYXgobmVzdEZ1cnRoZXN0RW5kLCBpbnRlcnZhbC5lbmQpO1xuXHRcdH1cblx0fVxuXHRyZXR1cm4gbmVzdHM7XG59O1xuXG4vKipcbiAqIG1lcmdlIG92ZXJsYXBwaW5nIG1hdGNoZXMgaW4gYSBsaXN0IG9mIG1hdGNoZXNcbiAqIEBwYXJhbSBtYXRjaGVzIHRoZSBsaXN0IG9mIG1hdGNoZXNcbiAqL1xuZXhwb3J0IGNvbnN0IG1lcmdlV29yZHMgPSAobWF0Y2hlczogTWF0Y2hbXSk6IE1hdGNoW10gPT4ge1xuXHRyZXR1cm4gZmluZE5lc3RzKG1hdGNoZXMpLnJlZHVjZSgoYWxsLCBuZXN0KSA9PiBhbGwuY29uY2F0KG1lcmdlV29yZEludGVydmFscyhuZXN0KSksIFtdKTtcbn07XG5cbi8qKlxuICogY2FsY3VsYXRlIHN0YXRpc3RpY3MgdXNpbmcgdGhlIHNjYW4ncyBgY29tcGxldGVSZXN1bHRgIGFuZCBhIGxpc3Qgb2YgYHJlc3VsdHNgXG4gKiBAcGFyYW0gY29tcGxldGVSZXN1bHQgdGhlIHJlcG9ydCdzIGNvbXBsZXRlIHJlc3VsdFxuICogQHBhcmFtIHJlc3VsdHMgdGhlIHJlc3VsdHMgdG8gY2FsY3VsYXRlIHN0YXRpc3RpY3MgZnJvbVxuICovXG5leHBvcnQgY29uc3QgY2FsY3VsYXRlU3RhdGlzdGljcyA9IChcblx0Y29tcGxldGVSZXN1bHQ6IENvbXBsZXRlUmVzdWx0LFxuXHRyZXN1bHRzOiBSZXN1bHRJdGVtW10sXG5cdG9wdGlvbnM6IENvcHlsZWFrc1JlcG9ydE9wdGlvbnNcbik6IFJlcG9ydFN0YXRpc3RpY3MgPT4ge1xuXHRjb25zdCB7IHRvdGFsV29yZHMsIHRvdGFsRXhjbHVkZWQgfSA9IGNvbXBsZXRlUmVzdWx0LnNjYW5uZWREb2N1bWVudDtcblx0Y29uc3QgaWRlbnRpY2FsID0gb3B0aW9ucy5zaG93SWRlbnRpY2FsID8gcmVzdWx0cy5mbGF0TWFwKGNyZWF0ZVdvcmRJbnRlcnZhbHNGcm9tKCdpZGVudGljYWwnLCAnc291cmNlJykpIDogW107XG5cdGNvbnN0IG1pbm9yQ2hhbmdlcyA9IG9wdGlvbnMuc2hvd01pbm9yQ2hhbmdlc1xuXHRcdD8gcmVzdWx0cy5mbGF0TWFwKGNyZWF0ZVdvcmRJbnRlcnZhbHNGcm9tKCdtaW5vckNoYW5nZXMnLCAnc291cmNlJykpXG5cdFx0OiBbXTtcblx0Y29uc3QgcmVsYXRlZE1lYW5pbmcgPSBvcHRpb25zLnNob3dSZWxhdGVkXG5cdFx0PyByZXN1bHRzLmZsYXRNYXAoY3JlYXRlV29yZEludGVydmFsc0Zyb20oJ3JlbGF0ZWRNZWFuaW5nJywgJ3NvdXJjZScpKVxuXHRcdDogW107XG5cdGNvbnN0IHdpdGhPdXRvdmVybGFwcyA9IG1lcmdlV29yZHMoWy4uLnJlbGF0ZWRNZWFuaW5nLCAuLi5taW5vckNoYW5nZXMsIC4uLmlkZW50aWNhbF0pO1xuXHRjb25zdCBpZGVudGljYWxDb3VudCA9IHdpdGhPdXRvdmVybGFwc1xuXHRcdC5maWx0ZXIobWF0Y2ggPT4gbWF0Y2gudHlwZSA9PT0gTWF0Y2hUeXBlLmlkZW50aWNhbClcblx0XHQucmVkdWNlKCh0b3RhbCwgZWxlbSkgPT4gdG90YWwgKyAoZWxlbS5lbmQgLSBlbGVtLnN0YXJ0KSwgMCk7XG5cdGNvbnN0IG1pbm9yQ2hhbmdlc0NvdW50ID0gd2l0aE91dG92ZXJsYXBzXG5cdFx0LmZpbHRlcihtYXRjaCA9PiBtYXRjaC50eXBlID09PSBNYXRjaFR5cGUubWlub3JDaGFuZ2VzKVxuXHRcdC5yZWR1Y2UoKHRvdGFsLCBlbGVtKSA9PiB0b3RhbCArIChlbGVtLmVuZCAtIGVsZW0uc3RhcnQpLCAwKTtcblx0Y29uc3QgcmVsYXRlZE1lYW5pbmdDb3VudCA9IHdpdGhPdXRvdmVybGFwc1xuXHRcdC5maWx0ZXIobWF0Y2ggPT4gbWF0Y2gudHlwZSA9PT0gTWF0Y2hUeXBlLnJlbGF0ZWRNZWFuaW5nKVxuXHRcdC5yZWR1Y2UoKHRvdGFsLCBlbGVtKSA9PiB0b3RhbCArIChlbGVtLmVuZCAtIGVsZW0uc3RhcnQpLCAwKTtcblxuXHRsZXQgYWdncmVnYXRlZFNjb3JlID0gTWF0aC5taW4oXG5cdFx0MSxcblx0XHQoaWRlbnRpY2FsQ291bnQgKyByZWxhdGVkTWVhbmluZ0NvdW50ICsgbWlub3JDaGFuZ2VzQ291bnQpIC8gKHRvdGFsV29yZHMgLSB0b3RhbEV4Y2x1ZGVkKVxuXHQpO1xuXHRhZ2dyZWdhdGVkU2NvcmUgPSBpc05hTihhZ2dyZWdhdGVkU2NvcmUpID8gMCA6IGFnZ3JlZ2F0ZWRTY29yZTtcblxuXHRyZXR1cm4ge1xuXHRcdGFnZ3JlZ2F0ZWRTY29yZSxcblx0XHRpZGVudGljYWw6IGlkZW50aWNhbENvdW50LFxuXHRcdHJlbGF0ZWRNZWFuaW5nOiByZWxhdGVkTWVhbmluZ0NvdW50LFxuXHRcdG1pbm9yQ2hhbmdlczogbWlub3JDaGFuZ2VzQ291bnQsXG5cdFx0b21pdHRlZFdvcmRzOiB0b3RhbEV4Y2x1ZGVkLFxuXHRcdHRvdGFsOiB0b3RhbFdvcmRzLFxuXHR9O1xufTtcbiJdfQ==