import { Injectable } from '@angular/core';
import { COMPLETE_RESULT_VALIDATION_ERROR, DEFAULT_REPORT_CONFIG, NEW_RESULT_VALIDATION_ERROR, SCAN_RESULT_VALIDATION_ERROR, 
// SCAN_RESULT_VALIDATION_ERROR,
SCAN_SOURCE_VALIDATION_ERROR, VERSION_VALIDATION_ERROR, } from '../utils/constants';
import { BehaviorSubject, Subject } from 'rxjs';
import { take } from 'rxjs/operators';
import * as i0 from "@angular/core";
//import { exit } from 'process';
export class CopyleaksService {
    constructor() {
        this._complete$ = new Subject();
        this._preview$ = new Subject();
        this._source$ = new Subject();
        this._results$ = new Subject();
        this._progress$ = new Subject();
        this._config$ = new BehaviorSubject({ ...DEFAULT_REPORT_CONFIG });
        this._destroy$ = new Subject();
        this._filteredResultsIds$ = new Subject();
        this._scoreUpdate$ = new Subject();
        this._totalResults$ = new Subject();
        this.onCompleteResult$ = this._complete$.asObservable();
        this.onResultPreview$ = this._preview$.asObservable();
        this.onScanSource$ = this._source$.asObservable();
        this.onResultItems$ = this._results$.asObservable();
        this.onProgress$ = this._progress$.asObservable();
        this.onReportConfig$ = this._config$.asObservable();
        this.onTotalResultsChange$ = this._totalResults$.asObservable();
        this.filteredResultsIds$ = this._filteredResultsIds$.asObservable();
        this.scoreUpdate$ = this._scoreUpdate$.asObservable();
        // Delete result by Id
        this.onDeleteResultById$ = new Subject();
        this.onDeleteProccessFinish$ = new Subject();
        this.onDestroy$ = this._destroy$.asObservable();
        // Simple object validation
        this.isCompleteResult = (o) => o && !!o.scannedDocument && !!o.results;
        this.isScanSource = (o) => o && !!o.metadata && !!o.text && !!o.version;
        this.isScanResult = (o) => o && !!o.text && !!o.statistics && !!o.version;
        this.isNewResult = (o) => o && !!o.internet && !!o.database && !!o.batch;
        this.isCorrectVersion = (o) => o && o.version === 3;
    }
    //private readonly cssError = 'font-weight: bold;color:blue;';
    /**
     * set total results (optional)
     * @param totalResults scan total results amount
     */
    setTotalResults(totalResults) {
        this._totalResults$.next(totalResults);
    }
    /**
     * Init/Set the filtered results.
     * @param ids a list of results ids to be filtered.
     * @param newAggregatedScore updated score after filter.
     */
    setFilteredResultsIds(ids, newAggregatedScore) {
        this._filteredResultsIds$.next(ids);
        this._scoreUpdate$.next(newAggregatedScore);
    }
    /**
     * Delete result by id.
     * @param resultId deleted result id
     * @returns updated complete result after deletion
     */
    async deleteResultById(resultId) {
        return new Promise((resolve, reject) => {
            this.onDeleteProccessFinish$.pipe(take(1)).subscribe(res => resolve(res), err => reject(err));
            this.onDeleteResultById$.next(resultId);
        });
    }
    /**
     * Insert the completion result of a scan to the report.
     * @see https://api.copyleaks.com/documentation/v3/webhooks/completed
     * @param result the completed result
     */
    pushCompletedResult(result) {
        if (!this.isCompleteResult(result)) {
            this.showExtendedError(COMPLETE_RESULT_VALIDATION_ERROR, result);
            return;
        }
        this._complete$.next(result);
    }
    showExtendedError(type, userResult) {
        console.error(type.errorText, '\nActual supplied argument:\n', userResult, '\nExpected argument should look like:\n', type.result, '\nFor more info, visit ' + type.visitUrl);
    }
    /**
     * Insert an incoming new scan result to the report.
     * @see https://api.copyleaks.com/documentation/v3/webhooks/new-result
     * @param result the new result
     */
    pushNewResult(result) {
        if (!this.isNewResult(result)) {
            this.showExtendedError(NEW_RESULT_VALIDATION_ERROR, result);
            return;
        }
        [...result.internet, ...result.database, ...result.batch, ...result.repositories].forEach(prev => {
            this._preview$.next(prev);
        });
    }
    /**
     * Insert the downloaded source you scanned to the report.
     * @see https://api.copyleaks.com/documentation/v3/downloads/source
     * @param source the downloaded source
     */
    pushDownloadedSource(source) {
        if (!this.isCorrectVersion(source)) {
            this.showExtendedError(VERSION_VALIDATION_ERROR, source);
            return;
        }
        if (!this.isScanSource(source)) {
            this.showExtendedError(SCAN_SOURCE_VALIDATION_ERROR, source);
            return;
        }
        this._source$.next(source);
    }
    /**
     * Insert one or more downloaded scan result to the report.
     * @see https://api.copyleaks.com/documentation/v3/downloads/result
     * @param results one or more ResultItem object containing the result and the id of the result
     */
    pushScanResult(results) {
        results = [].concat(results);
        for (const { id, result } of results) {
            if (typeof id !== 'string') {
                throw new Error(`Argument "id" must be a string`);
            }
            if (result != null && !this.isScanResult(result)) {
                this.showExtendedError(SCAN_RESULT_VALIDATION_ERROR, result);
                return;
            }
        }
        this._results$.next(results);
    }
    /**
     * Change the progress percentage in the report manualy
     * @param progress an integer between 0 ~ 100
     */
    setProgress(progress) {
        this._progress$.next(progress);
    }
    /**
     * change the report's configuration
     * This function is used to sort the displayed results, you can add your own custom sort by overriding this function
     * @param previews the displayed results
     */
    sortScanResults(previews) {
        return previews.sort((a, b) => b.matchedWords - a.matchedWords);
    }
    /**
     * change the report's configuration
     * allows passing partial configuration that will be complemented by the default configuration
     * @param config the complete/partial configuration object
     */
    setConfig(config) {
        this._config$.next({ ...config });
    }
    /**
     * This method will cause the `destroy$` observable to emit
     */
    notifyDestroy() {
        this._destroy$.next();
        this.setFilteredResultsIds([], null);
    }
}
CopyleaksService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.3.3", ngImport: i0, type: CopyleaksService, deps: [], target: i0.ɵɵFactoryTarget.Injectable });
CopyleaksService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.3.3", ngImport: i0, type: CopyleaksService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.3.3", ngImport: i0, type: CopyleaksService, decorators: [{
            type: Injectable
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29weWxlYWtzLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9wbGFnaWFyaXNtLXJlcG9ydC9zcmMvbGliL3BsYWdpYXJpc20tcmVwb3J0L3NlcnZpY2VzL2NvcHlsZWFrcy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFVM0MsT0FBTyxFQUNOLGdDQUFnQyxFQUNoQyxxQkFBcUIsRUFDckIsMkJBQTJCLEVBQzNCLDRCQUE0QjtBQUM1QixnQ0FBZ0M7QUFDaEMsNEJBQTRCLEVBQzVCLHdCQUF3QixHQUN4QixNQUFNLG9CQUFvQixDQUFDO0FBRTVCLE9BQU8sRUFBRSxlQUFlLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2hELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7QUFDdEMsaUNBQWlDO0FBR2pDLE1BQU0sT0FBTyxnQkFBZ0I7SUFEN0I7UUFFa0IsZUFBVSxHQUFHLElBQUksT0FBTyxFQUFrQixDQUFDO1FBQzNDLGNBQVMsR0FBRyxJQUFJLE9BQU8sRUFBaUIsQ0FBQztRQUN6QyxhQUFRLEdBQUcsSUFBSSxPQUFPLEVBQWMsQ0FBQztRQUNyQyxjQUFTLEdBQUcsSUFBSSxPQUFPLEVBQWdCLENBQUM7UUFDeEMsZUFBVSxHQUFHLElBQUksT0FBTyxFQUFVLENBQUM7UUFDbkMsYUFBUSxHQUFHLElBQUksZUFBZSxDQUF3QixFQUFFLEdBQUcscUJBQXFCLEVBQUUsQ0FBQyxDQUFDO1FBQ3BGLGNBQVMsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBQzFCLHlCQUFvQixHQUFHLElBQUksT0FBTyxFQUFZLENBQUM7UUFDL0Msa0JBQWEsR0FBRyxJQUFJLE9BQU8sRUFBVSxDQUFDO1FBQ3RDLG1CQUFjLEdBQUcsSUFBSSxPQUFPLEVBQVUsQ0FBQztRQUV4Qyxz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Q0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxZQUFZLEdBQUcsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBQ2pFLENBQUM7SUFFRDs7OztPQUlHO0lBQ0ksU0FBUyxDQUFDLE1BQTZCO1FBQzdDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUUsR0FBRyxNQUFNLEVBQUUsQ0FBQyxDQUFDO0lBQ25DLENBQUM7SUFFRDs7T0FFRztJQUNJLGFBQWE7UUFDbkIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUN0QixJQUFJLENBQUMscUJBQXFCLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ3RDLENBQUM7OzZHQXZLVyxnQkFBZ0I7aUhBQWhCLGdCQUFnQjsyRkFBaEIsZ0JBQWdCO2tCQUQ1QixVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcblx0Q29tcGxldGVSZXN1bHQsXG5cdENvcHlsZWFrc1JlcG9ydENvbmZpZyxcblx0TmV3UmVzdWx0LFxuXHRSZXN1bHRJdGVtLFxuXHRSZXN1bHRQcmV2aWV3LFxuXHRTY2FuUmVzdWx0LFxuXHRTY2FuU291cmNlLFxufSBmcm9tICcuLi9tb2RlbHMnO1xuaW1wb3J0IHtcblx0Q09NUExFVEVfUkVTVUxUX1ZBTElEQVRJT05fRVJST1IsXG5cdERFRkFVTFRfUkVQT1JUX0NPTkZJRyxcblx0TkVXX1JFU1VMVF9WQUxJREFUSU9OX0VSUk9SLFxuXHRTQ0FOX1JFU1VMVF9WQUxJREFUSU9OX0VSUk9SLFxuXHQvLyBTQ0FOX1JFU1VMVF9WQUxJREFUSU9OX0VSUk9SLFxuXHRTQ0FOX1NPVVJDRV9WQUxJREFUSU9OX0VSUk9SLFxuXHRWRVJTSU9OX1ZBTElEQVRJT05fRVJST1IsXG59IGZyb20gJy4uL3V0aWxzL2NvbnN0YW50cyc7XG5cbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgdGFrZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbi8vaW1wb3J0IHsgZXhpdCB9IGZyb20gJ3Byb2Nlc3MnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQ29weWxlYWtzU2VydmljZSB7XG5cdHByaXZhdGUgcmVhZG9ubHkgX2NvbXBsZXRlJCA9IG5ldyBTdWJqZWN0PENvbXBsZXRlUmVzdWx0PigpO1xuXHRwcml2YXRlIHJlYWRvbmx5IF9wcmV2aWV3JCA9IG5ldyBTdWJqZWN0PFJlc3VsdFByZXZpZXc+KCk7XG5cdHByaXZhdGUgcmVhZG9ubHkgX3NvdXJjZSQgPSBuZXcgU3ViamVjdDxTY2FuU291cmNlPigpO1xuXHRwcml2YXRlIHJlYWRvbmx5IF9yZXN1bHRzJCA9IG5ldyBTdWJqZWN0PFJlc3VsdEl0ZW1bXT4oKTtcblx0cHJpdmF0ZSByZWFkb25seSBfcHJvZ3Jlc3MkID0gbmV3IFN1YmplY3Q8bnVtYmVyPigpO1xuXHRwcml2YXRlIHJlYWRvbmx5IF9jb25maWckID0gbmV3IEJlaGF2aW9yU3ViamVjdDxDb3B5bGVha3NSZXBvcnRDb25maWc+KHsgLi4uREVGQVVMVF9SRVBPUlRfQ09ORklHIH0pO1xuXHRwcml2YXRlIHJlYWRvbmx5IF9kZXN0cm95JCA9IG5ldyBTdWJqZWN0KCk7XG5cdHByaXZhdGUgcmVhZG9ubHkgX2ZpbHRlcmVkUmVzdWx0c0lkcyQgPSBuZXcgU3ViamVjdDxzdHJpbmdbXT4oKTtcblx0cHJpdmF0ZSByZWFkb25seSBfc2NvcmVVcGRhdGUkID0gbmV3IFN1YmplY3Q8bnVtYmVyPigpO1xuXHRwcml2YXRlIHJlYWRvbmx5IF90b3RhbFJlc3VsdHMkID0gbmV3IFN1YmplY3Q8bnVtYmVyPigpO1xuXG5cdHB1YmxpYyByZWFkb25seSBvbkNvbXBsZXRlUmVzdWx0JCA9IHRoaXMuX2NvbXBsZXRlJC5hc09ic2VydmFibGUoKTtcblx0cHVibGljIHJlYWRvbmx5IG9uUmVzdWx0UHJldmlldyQgPSB0aGlzLl9wcmV2aWV3JC5hc09ic2VydmFibGUoKTtcblx0cHVibGljIHJlYWRvbmx5IG9uU2NhblNvdXJjZSQgPSB0aGlzLl9zb3VyY2UkLmFzT2JzZXJ2YWJsZSgpO1xuXHRwdWJsaWMgcmVhZG9ubHkgb25SZXN1bHRJdGVtcyQgPSB0aGlzLl9yZXN1bHRzJC5hc09ic2VydmFibGUoKTtcblx0cHVibGljIHJlYWRvbmx5IG9uUHJvZ3Jlc3MkID0gdGhpcy5fcHJvZ3Jlc3MkLmFzT2JzZXJ2YWJsZSgpO1xuXHRwdWJsaWMgcmVhZG9ubHkgb25SZXBvcnRDb25maWckID0gdGhpcy5fY29uZmlnJC5hc09ic2VydmFibGUoKTtcblx0cHVibGljIHJlYWRvbmx5IG9uVG90YWxSZXN1bHRzQ2hhbmdlJCA9IHRoaXMuX3RvdGFsUmVzdWx0cyQuYXNPYnNlcnZhYmxlKCk7XG5cdHB1YmxpYyByZWFkb25seSBmaWx0ZXJlZFJlc3VsdHNJZHMkID0gdGhpcy5fZmlsdGVyZWRSZXN1bHRzSWRzJC5hc09ic2VydmFibGUoKTtcblx0cHVibGljIHJlYWRvbmx5IHNjb3JlVXBkYXRlJCA9IHRoaXMuX3Njb3JlVXBkYXRlJC5hc09ic2VydmFibGUoKTtcblxuXHQvLyBEZWxldGUgcmVzdWx0IGJ5IElkXG5cdHB1YmxpYyByZWFkb25seSBvbkRlbGV0ZVJlc3VsdEJ5SWQkID0gbmV3IFN1YmplY3Q8c3RyaW5nPigpO1xuXHRwdWJsaWMgcmVhZG9ubHkgb25EZWxldGVQcm9jY2Vzc0ZpbmlzaCQgPSBuZXcgU3ViamVjdDxDb21wbGV0ZVJlc3VsdD4oKTtcblxuXHRwdWJsaWMgcmVhZG9ubHkgb25EZXN0cm95JCA9IHRoaXMuX2Rlc3Ryb3kkLmFzT2JzZXJ2YWJsZSgpO1xuXHQvL3ByaXZhdGUgcmVhZG9ubHkgY3NzRXJyb3IgPSAnZm9udC13ZWlnaHQ6IGJvbGQ7Y29sb3I6Ymx1ZTsnO1xuXHQvKipcblx0ICogc2V0IHRvdGFsIHJlc3VsdHMgKG9wdGlvbmFsKVxuXHQgKiBAcGFyYW0gdG90YWxSZXN1bHRzIHNjYW4gdG90YWwgcmVzdWx0cyBhbW91bnRcblx0ICovXG5cdHB1YmxpYyBzZXRUb3RhbFJlc3VsdHModG90YWxSZXN1bHRzOiBudW1iZXIpIHtcblx0XHR0aGlzLl90b3RhbFJlc3VsdHMkLm5leHQodG90YWxSZXN1bHRzKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBJbml0L1NldCB0aGUgZmlsdGVyZWQgcmVzdWx0cy5cblx0ICogQHBhcmFtIGlkcyBhIGxpc3Qgb2YgcmVzdWx0cyBpZHMgdG8gYmUgZmlsdGVyZWQuXG5cdCAqIEBwYXJhbSBuZXdBZ2dyZWdhdGVkU2NvcmUgdXBkYXRlZCBzY29yZSBhZnRlciBmaWx0ZXIuXG5cdCAqL1xuXHRwdWJsaWMgc2V0RmlsdGVyZWRSZXN1bHRzSWRzKGlkczogc3RyaW5nW10sIG5ld0FnZ3JlZ2F0ZWRTY29yZTogbnVtYmVyKSB7XG5cdFx0dGhpcy5fZmlsdGVyZWRSZXN1bHRzSWRzJC5uZXh0KGlkcyk7XG5cdFx0dGhpcy5fc2NvcmVVcGRhdGUkLm5leHQobmV3QWdncmVnYXRlZFNjb3JlKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBEZWxldGUgcmVzdWx0IGJ5IGlkLlxuXHQgKiBAcGFyYW0gcmVzdWx0SWQgZGVsZXRlZCByZXN1bHQgaWRcblx0ICogQHJldHVybnMgdXBkYXRlZCBjb21wbGV0ZSByZXN1bHQgYWZ0ZXIgZGVsZXRpb25cblx0ICovXG5cdHB1YmxpYyBhc3luYyBkZWxldGVSZXN1bHRCeUlkKHJlc3VsdElkOiBzdHJpbmcpIHtcblx0XHRyZXR1cm4gbmV3IFByb21pc2U8Q29tcGxldGVSZXN1bHQ+KChyZXNvbHZlLCByZWplY3QpID0+IHtcblx0XHRcdHRoaXMub25EZWxldGVQcm9jY2Vzc0ZpbmlzaCQucGlwZSh0YWtlKDEpKS5zdWJzY3JpYmUoXG5cdFx0XHRcdHJlcyA9PiByZXNvbHZlKHJlcyksXG5cdFx0XHRcdGVyciA9PiByZWplY3QoZXJyKVxuXHRcdFx0KTtcblx0XHRcdHRoaXMub25EZWxldGVSZXN1bHRCeUlkJC5uZXh0KHJlc3VsdElkKTtcblx0XHR9KTtcblx0fVxuXG5cdC8qKlxuXHQgKiBJbnNlcnQgdGhlIGNvbXBsZXRpb24gcmVzdWx0IG9mIGEgc2NhbiB0byB0aGUgcmVwb3J0LlxuXHQgKiBAc2VlIGh0dHBzOi8vYXBpLmNvcHlsZWFrcy5jb20vZG9jdW1lbnRhdGlvbi92My93ZWJob29rcy9jb21wbGV0ZWRcblx0ICogQHBhcmFtIHJlc3VsdCB0aGUgY29tcGxldGVkIHJlc3VsdFxuXHQgKi9cblx0cHVibGljIHB1c2hDb21wbGV0ZWRSZXN1bHQocmVzdWx0OiBDb21wbGV0ZVJlc3VsdCkge1xuXHRcdGlmICghdGhpcy5pc0NvbXBsZXRlUmVzdWx0KHJlc3VsdCkpIHtcblx0XHRcdHRoaXMuc2hvd0V4dGVuZGVkRXJyb3IoQ09NUExFVEVfUkVTVUxUX1ZBTElEQVRJT05fRVJST1IsIHJlc3VsdCk7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXHRcdHRoaXMuX2NvbXBsZXRlJC5uZXh0KHJlc3VsdCk7XG5cdH1cblxuXHRwcml2YXRlIHNob3dFeHRlbmRlZEVycm9yKHR5cGU6IGFueSwgdXNlclJlc3VsdDogYW55KSB7XG5cdFx0Y29uc29sZS5lcnJvcihcblx0XHRcdHR5cGUuZXJyb3JUZXh0LFxuXHRcdFx0J1xcbkFjdHVhbCBzdXBwbGllZCBhcmd1bWVudDpcXG4nLFxuXHRcdFx0dXNlclJlc3VsdCxcblx0XHRcdCdcXG5FeHBlY3RlZCBhcmd1bWVudCBzaG91bGQgbG9vayBsaWtlOlxcbicsXG5cdFx0XHR0eXBlLnJlc3VsdCxcblx0XHRcdCdcXG5Gb3IgbW9yZSBpbmZvLCB2aXNpdCAnICsgdHlwZS52aXNpdFVybFxuXHRcdCk7XG5cdH1cblx0LyoqXG5cdCAqIEluc2VydCBhbiBpbmNvbWluZyBuZXcgc2NhbiByZXN1bHQgdG8gdGhlIHJlcG9ydC5cblx0ICogQHNlZSBodHRwczovL2FwaS5jb3B5bGVha3MuY29tL2RvY3VtZW50YXRpb24vdjMvd2ViaG9va3MvbmV3LXJlc3VsdFxuXHQgKiBAcGFyYW0gcmVzdWx0IHRoZSBuZXcgcmVzdWx0XG5cdCAqL1xuXHRwdWJsaWMgcHVzaE5ld1Jlc3VsdChyZXN1bHQ6IE5ld1Jlc3VsdCkge1xuXHRcdGlmICghdGhpcy5pc05ld1Jlc3VsdChyZXN1bHQpKSB7XG5cdFx0XHR0aGlzLnNob3dFeHRlbmRlZEVycm9yKE5FV19SRVNVTFRfVkFMSURBVElPTl9FUlJPUiwgcmVzdWx0KTtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cdFx0Wy4uLnJlc3VsdC5pbnRlcm5ldCwgLi4ucmVzdWx0LmRhdGFiYXNlLCAuLi5yZXN1bHQuYmF0Y2gsIC4uLnJlc3VsdC5yZXBvc2l0b3JpZXNdLmZvckVhY2gocHJldiA9PiB7XG5cdFx0XHR0aGlzLl9wcmV2aWV3JC5uZXh0KHByZXYpO1xuXHRcdH0pO1xuXHR9XG5cblx0LyoqXG5cdCAqIEluc2VydCB0aGUgZG93bmxvYWRlZCBzb3VyY2UgeW91IHNjYW5uZWQgdG8gdGhlIHJlcG9ydC5cblx0ICogQHNlZSBodHRwczovL2FwaS5jb3B5bGVha3MuY29tL2RvY3VtZW50YXRpb24vdjMvZG93bmxvYWRzL3NvdXJjZVxuXHQgKiBAcGFyYW0gc291cmNlIHRoZSBkb3dubG9hZGVkIHNvdXJjZVxuXHQgKi9cblx0cHVibGljIHB1c2hEb3dubG9hZGVkU291cmNlKHNvdXJjZTogU2NhblNvdXJjZSkge1xuXHRcdGlmICghdGhpcy5pc0NvcnJlY3RWZXJzaW9uKHNvdXJjZSkpIHtcblx0XHRcdHRoaXMuc2hvd0V4dGVuZGVkRXJyb3IoVkVSU0lPTl9WQUxJREFUSU9OX0VSUk9SLCBzb3VyY2UpO1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblx0XHRpZiAoIXRoaXMuaXNTY2FuU291cmNlKHNvdXJjZSkpIHtcblx0XHRcdHRoaXMuc2hvd0V4dGVuZGVkRXJyb3IoU0NBTl9TT1VSQ0VfVkFMSURBVElPTl9FUlJPUiwgc291cmNlKTtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cdFx0dGhpcy5fc291cmNlJC5uZXh0KHNvdXJjZSk7XG5cdH1cblxuXHQvKipcblx0ICogSW5zZXJ0IG9uZSBvciBtb3JlIGRvd25sb2FkZWQgc2NhbiByZXN1bHQgdG8gdGhlIHJlcG9ydC5cblx0ICogQHNlZSBodHRwczovL2FwaS5jb3B5bGVha3MuY29tL2RvY3VtZW50YXRpb24vdjMvZG93bmxvYWRzL3Jlc3VsdFxuXHQgKiBAcGFyYW0gcmVzdWx0cyBvbmUgb3IgbW9yZSBSZXN1bHRJdGVtIG9iamVjdCBjb250YWluaW5nIHRoZSByZXN1bHQgYW5kIHRoZSBpZCBvZiB0aGUgcmVzdWx0XG5cdCAqL1xuXHRwdWJsaWMgcHVzaFNjYW5SZXN1bHQocmVzdWx0czogUmVzdWx0SXRlbVtdIHwgUmVzdWx0SXRlbSkge1xuXHRcdHJlc3VsdHMgPSBbXS5jb25jYXQocmVzdWx0cyk7XG5cdFx0Zm9yIChjb25zdCB7IGlkLCByZXN1bHQgfSBvZiByZXN1bHRzKSB7XG5cdFx0XHRpZiAodHlwZW9mIGlkICE9PSAnc3RyaW5nJykge1xuXHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoYEFyZ3VtZW50IFwiaWRcIiBtdXN0IGJlIGEgc3RyaW5nYCk7XG5cdFx0XHR9XG5cdFx0XHRpZiAocmVzdWx0ICE9IG51bGwgJiYgIXRoaXMuaXNTY2FuUmVzdWx0KHJlc3VsdCkpIHtcblx0XHRcdFx0dGhpcy5zaG93RXh0ZW5kZWRFcnJvcihTQ0FOX1JFU1VMVF9WQUxJREFUSU9OX0VSUk9SLCByZXN1bHQpO1xuXHRcdFx0XHRyZXR1cm47XG5cdFx0XHR9XG5cdFx0fVxuXHRcdHRoaXMuX3Jlc3VsdHMkLm5leHQocmVzdWx0cyk7XG5cdH1cblxuXHQvKipcblx0ICogQ2hhbmdlIHRoZSBwcm9ncmVzcyBwZXJjZW50YWdlIGluIHRoZSByZXBvcnQgbWFudWFseVxuXHQgKiBAcGFyYW0gcHJvZ3Jlc3MgYW4gaW50ZWdlciBiZXR3ZWVuIDAgfiAxMDBcblx0ICovXG5cdHB1YmxpYyBzZXRQcm9ncmVzcyhwcm9ncmVzczogbnVtYmVyKSB7XG5cdFx0dGhpcy5fcHJvZ3Jlc3MkLm5leHQocHJvZ3Jlc3MpO1xuXHR9XG5cblx0LyoqXG5cdCAqIGNoYW5nZSB0aGUgcmVwb3J0J3MgY29uZmlndXJhdGlvblxuXHQgKiBUaGlzIGZ1bmN0aW9uIGlzIHVzZWQgdG8gc29ydCB0aGUgZGlzcGxheWVkIHJlc3VsdHMsIHlvdSBjYW4gYWRkIHlvdXIgb3duIGN1c3RvbSBzb3J0IGJ5IG92ZXJyaWRpbmcgdGhpcyBmdW5jdGlvblxuXHQgKiBAcGFyYW0gcHJldmlld3MgdGhlIGRpc3BsYXllZCByZXN1bHRzXG5cdCAqL1xuXHRwdWJsaWMgc29ydFNjYW5SZXN1bHRzKHByZXZpZXdzOiBSZXN1bHRQcmV2aWV3W10pOiBSZXN1bHRQcmV2aWV3W10ge1xuXHRcdHJldHVybiBwcmV2aWV3cy5zb3J0KChhLCBiKSA9PiBiLm1hdGNoZWRXb3JkcyAtIGEubWF0Y2hlZFdvcmRzKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBjaGFuZ2UgdGhlIHJlcG9ydCdzIGNvbmZpZ3VyYXRpb25cblx0ICogYWxsb3dzIHBhc3NpbmcgcGFydGlhbCBjb25maWd1cmF0aW9uIHRoYXQgd2lsbCBiZSBjb21wbGVtZW50ZWQgYnkgdGhlIGRlZmF1bHQgY29uZmlndXJhdGlvblxuXHQgKiBAcGFyYW0gY29uZmlnIHRoZSBjb21wbGV0ZS9wYXJ0aWFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0XG5cdCAqL1xuXHRwdWJsaWMgc2V0Q29uZmlnKGNvbmZpZzogQ29weWxlYWtzUmVwb3J0Q29uZmlnKSB7XG5cdFx0dGhpcy5fY29uZmlnJC5uZXh0KHsgLi4uY29uZmlnIH0pO1xuXHR9XG5cblx0LyoqXG5cdCAqIFRoaXMgbWV0aG9kIHdpbGwgY2F1c2UgdGhlIGBkZXN0cm95JGAgb2JzZXJ2YWJsZSB0byBlbWl0XG5cdCAqL1xuXHRwdWJsaWMgbm90aWZ5RGVzdHJveSgpIHtcblx0XHR0aGlzLl9kZXN0cm95JC5uZXh0KCk7XG5cdFx0dGhpcy5zZXRGaWx0ZXJlZFJlc3VsdHNJZHMoW10sIG51bGwpO1xuXHR9XG5cblx0Ly8gU2ltcGxlIG9iamVjdCB2YWxpZGF0aW9uXG5cdHByaXZhdGUgaXNDb21wbGV0ZVJlc3VsdCA9IChvOiBDb21wbGV0ZVJlc3VsdCkgPT4gbyAmJiAhIW8uc2Nhbm5lZERvY3VtZW50ICYmICEhby5yZXN1bHRzO1xuXHRwcml2YXRlIGlzU2NhblNvdXJjZSA9IChvOiBTY2FuU291cmNlKSA9PiBvICYmICEhby5tZXRhZGF0YSAmJiAhIW8udGV4dCAmJiAhIW8udmVyc2lvbjtcblx0cHJpdmF0ZSBpc1NjYW5SZXN1bHQgPSAobzogU2NhblJlc3VsdCkgPT4gbyAmJiAhIW8udGV4dCAmJiAhIW8uc3RhdGlzdGljcyAmJiAhIW8udmVyc2lvbjtcblx0cHJpdmF0ZSBpc05ld1Jlc3VsdCA9IChvOiBOZXdSZXN1bHQpID0+IG8gJiYgISFvLmludGVybmV0ICYmICEhby5kYXRhYmFzZSAmJiAhIW8uYmF0Y2g7XG5cdHByaXZhdGUgaXNDb3JyZWN0VmVyc2lvbiA9IChvOiBTY2FuUmVzdWx0IHwgU2NhblNvdXJjZSkgPT4gbyAmJiBvLnZlcnNpb24gPT09IDM7XG59XG4iXX0=