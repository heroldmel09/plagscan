import { Injectable } from '@angular/core';
import { BehaviorSubject, combineLatest } from 'rxjs';
import { distinctUntilChanged, filter, map, skip, take, takeUntil } from 'rxjs/operators';
import { untilDestroy } from '../../shared/operators/untilDestroy';
import { ALERTS } from '../utils/constants';
import * as helpers from '../utils/match-helpers';
import { truthy } from '../utils/operators';
import { EReportViewModel } from './view-mode.service';
import * as i0 from "@angular/core";
import * as i1 from "./report.service";
import * as i2 from "./view-mode.service";
/**
 * Service that calculates the matches highlight positions with respect to the view and content mode.
 * It exposes some observable streams that you can subscribe to and get the newest relevant calculations.
 */
export class MatchService {
    constructor(reportService, viewModeService) {
        this.reportService = reportService;
        this.viewModeService = viewModeService;
        this._sourceTextMatches = new BehaviorSubject(null);
        this._sourceHtmlMatches = new BehaviorSubject(null);
        this._suspectTextMatches = new BehaviorSubject(null);
        this._suspectHtmlMatches = new BehaviorSubject(null);
        this._originalTextMatches = new BehaviorSubject(null);
        this._originalHtmlMatches = new BehaviorSubject(null);
        const { source$, filteredResults$, options$, previews$, hiddenResults$ } = this.reportService;
        const { reportViewMode$ } = this.viewModeService;
        // listen to suspect changes and process one-to-one matches
        combineLatest([this.onSuspectChange$, options$.pipe(distinctUntilChanged()), source$])
            .pipe(untilDestroy(this))
            .subscribe(([result, options, source]) => this.processOneToOneMatches(result, options, source));
        // this.onSuspectChange$.pipe(take(1),untilDestroy(this))
        // listen to changes in settings and filtered results
        // const throttledResults$ = filteredResults$.pipe(
        // 	untilDestroy(this),
        // 	throttleTime(5000, asyncScheduler, { leading: false, trailing: true })
        // );
        let _timeout;
        /**
         * We want to process oneToMany results when:
         * * once the source is ready
         * * every time the filteredResults$ observable updates
         * * every time the options object has changed
         * * report view mode change
         */
        combineLatest([filteredResults$, previews$, hiddenResults$, options$, source$, reportViewMode$])
            .pipe(untilDestroy(this))
            .subscribe(([results, previews, hiddenResults, options, source, viewMode]) => {
            if (_timeout) {
                clearTimeout(_timeout);
            }
            if (viewMode === EReportViewModel.Alerts || viewMode === EReportViewModel.AIView) {
                this.processAlertMatches(options, source);
            }
            else {
                _timeout = setTimeout(() => {
                    this.processOneToManyMatches(results, options, source);
                }, results.length === previews.length - hiddenResults.length ? 0 : 5000);
            }
        });
    }
    get onSourceFirstTextMode$() {
        return this.reportService.contentMode$.pipe(untilDestroy(this), filter(content => content === 'text'), take(1));
    }
    get onSourceFirstHtmlMode$() {
        const { contentMode$, source$ } = this.reportService;
        return combineLatest([contentMode$, source$]).pipe(untilDestroy(this), filter(([content, source]) => content === 'html' && source.html && !!source.html.value), take(1));
    }
    get onSourceContentModeChange$() {
        return this.reportService.contentMode$.pipe(untilDestroy(this), map(content => content), distinctUntilChanged());
    }
    get onSuspectContentModeChange$() {
        return this.reportService.contentMode$.pipe(untilDestroy(this), map(content => content), distinctUntilChanged());
    }
    get onSuspectFirstTextMode$() {
        return this.reportService.contentMode$.pipe(untilDestroy(this), filter(content => content === 'text'), take(1));
    }
    get onSuspectFirstHtmlMode$() {
        const { contentMode$, suspectResult$: suspect$ } = this.reportService;
        return combineLatest([contentMode$, suspect$]).pipe(untilDestroy(this), filter(([content, suspect]) => content === 'html' && suspect && suspect.result && !!suspect.result.html.value), take(1));
    }
    get onSuspectChange$() {
        return this.reportService.suspectResult$.pipe(untilDestroy(this), truthy(), distinctUntilChanged());
    }
    get onNewSuspect$() {
        return this.onSuspectChange$.pipe(untilDestroy(this), skip(1));
    }
    /** Emits matches that are relevant to source text one-to-one mode */
    get sourceTextMatches$() {
        return this._sourceTextMatches.asObservable().pipe(truthy());
    }
    /** Emits matches that are relevant to source html one-to-one mode */
    get sourceHtmlMatches$() {
        return this._sourceHtmlMatches.asObservable().pipe(untilDestroy(this), truthy());
    }
    /** Emits matches that are relevant to suspect text one-to-one mode */
    get suspectTextMatches$() {
        return this._suspectTextMatches.asObservable().pipe(untilDestroy(this), truthy());
    }
    /** Emits matches that are relevant to suspect html one-to-one mode */
    get suspectHtmlMatches$() {
        return this._suspectHtmlMatches.asObservable().pipe(untilDestroy(this), truthy());
    }
    /** Emits matches that are relevant to source text one-to-many mode */
    get originalTextMatches$() {
        return this._originalTextMatches.asObservable().pipe(untilDestroy(this), truthy());
    }
    /** Emits matches that are relevant to source html one-to-many mode */
    get originalHtmlMatches$() {
        return this._originalHtmlMatches.asObservable().pipe(untilDestroy(this), truthy());
    }
    /**
     * Process matches on the `one-to-one` view mode
     * will calculate the matches when showing `text` or `html` for the first time
     * @param item the result to calculate matches from
     * @param settings the report settings
     * @param source  the scan source
     */
    processOneToOneMatches(item, settings, source) {
        if (source.html && source.html.value && !(item.result.html && item.result.html.value)) {
            // case where source has html but suspect doesnt
            this.onSourceFirstTextMode$.pipe(takeUntil(this.onNewSuspect$)).subscribe(() => {
                const text = helpers.processSourceText(item, settings, source);
                this._sourceTextMatches.next(text);
            });
            this.onSourceFirstHtmlMode$.pipe(takeUntil(this.onNewSuspect$)).subscribe(() => {
                const html = helpers.processSourceHtml(item, settings, source);
                this._sourceHtmlMatches.next(html);
            });
            this.onSuspectContentModeChange$.pipe(takeUntil(this.onNewSuspect$)).subscribe(mode => {
                const text = helpers.processSuspectText(item, settings, mode === 'text');
                this._suspectTextMatches.next(text);
            });
        }
        else if (!(source.html && source.html.value) && item.result.html && item.result.html.value) {
            // case where suspect has html but source doesnt
            this.onSuspectFirstTextMode$.pipe(takeUntil(this.onNewSuspect$)).subscribe(() => {
                const text = helpers.processSuspectText(item, settings);
                this._suspectTextMatches.next(text);
            });
            this.onSuspectFirstHtmlMode$.pipe(takeUntil(this.onNewSuspect$)).subscribe(() => {
                const html = helpers.processSuspectHtml(item, settings);
                this._suspectHtmlMatches.next(html);
            });
            this.onSourceContentModeChange$.pipe(takeUntil(this.onNewSuspect$)).subscribe(mode => {
                const text = helpers.processSourceText(item, settings, source, mode === 'text');
                this._sourceTextMatches.next(text);
            });
        }
        else {
            this.onSourceFirstTextMode$.pipe(takeUntil(this.onNewSuspect$)).subscribe(() => {
                setTimeout(() => {
                    const text = helpers.processSourceText(item, settings, source);
                    this._sourceTextMatches.next(text);
                });
                setTimeout(() => {
                    const text = helpers.processSuspectText(item, settings);
                    this._suspectTextMatches.next(text);
                });
            });
            this.onSourceFirstHtmlMode$.pipe(takeUntil(this.onNewSuspect$)).subscribe(() => {
                setTimeout(() => {
                    const html = helpers.processSourceHtml(item, settings, source);
                    this._sourceHtmlMatches.next(html);
                });
                setTimeout(() => {
                    const html = helpers.processSuspectHtml(item, settings);
                    this._suspectHtmlMatches.next(html);
                });
            });
        }
    }
    /**
     * Process matches on the `one-to-many` view mode
     * will calculate the matches when showing `text` or `html` for the first time
     * @param results the results to calculate matches from
     * @param settings the report settings
     * @param source  the scan source
     */
    processOneToManyMatches(results, settings, source) {
        this.onSourceFirstTextMode$.subscribe(() => {
            const text = helpers.processSourceText(results, settings, source);
            if (text) {
                this._originalTextMatches.next(text);
            }
        });
        this.onSourceFirstHtmlMode$.subscribe(() => {
            const html = helpers.processSourceHtml(results, settings, source);
            if (html) {
                this._originalHtmlMatches.next(html);
            }
        });
    }
    /**
     * Process matches on the `suspected-character-replacement` view mode
     * will calculate the matches when showing `text` or `html` for the first time
     * @param settings the report settings
     * @param source  the scan source
     */
    processAlertMatches(settings, source) {
        this.onSourceFirstTextMode$.subscribe(() => {
            let text;
            if (this.viewModeService?.selectedAlert?.code === ALERTS.SUSPECTED_CHARACTER_REPLACEMENT_CODE) {
                text = helpers.processSuspectedCharacterMatches(source, this.viewModeService.selectedAlert);
            }
            else if (this.viewModeService?.selectedAlert?.code === ALERTS.SUSPECTED_AI_TEXT_DETECTED) {
                text = helpers.processAICheatingMatches(source, this.viewModeService.selectedAlert);
            }
            else {
                text = helpers.processSourceText([], settings, source);
            }
            if (text) {
                this._originalTextMatches.next(text);
            }
        });
        this.onSourceFirstHtmlMode$.subscribe(() => {
            const html = helpers.processSourceHtml([], settings, source);
            if (html) {
                this._originalHtmlMatches.next(html);
            }
        });
    }
    /**
     * dtor
     */
    ngOnDestroy() {
        this._sourceTextMatches && this._sourceTextMatches.complete();
        this._sourceHtmlMatches && this._sourceHtmlMatches.complete();
        this._suspectTextMatches && this._suspectTextMatches.complete();
        this._suspectHtmlMatches && this._suspectHtmlMatches.complete();
        this._originalTextMatches && this._originalTextMatches.complete();
        this._originalHtmlMatches && this._originalHtmlMatches.complete();
    }
}
MatchService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.3.3", ngImport: i0, type: MatchService, deps: [{ token: i1.ReportService }, { token: i2.ViewModeService }], target: i0.ɵɵFactoryTarget.Injectable });
MatchService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.3.3", ngImport: i0, type: MatchService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.3.3", ngImport: i0, type: MatchService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.ReportService }, { type: i2.ViewModeService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWF0Y2guc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3BsYWdpYXJpc20tcmVwb3J0L3NyYy9saWIvcGxhZ2lhcmlzbS1yZXBvcnQvc2VydmljZXMvbWF0Y2guc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFhLE1BQU0sZUFBZSxDQUFDO0FBQ3RELE9BQU8sRUFBRSxlQUFlLEVBQUUsYUFBYSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RELE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDMUYsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBRW5FLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUM1QyxPQUFPLEtBQUssT0FBTyxNQUFNLHdCQUF3QixDQUFDO0FBQ2xELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUU1QyxPQUFPLEVBQUUsZ0JBQWdCLEVBQW1CLE1BQU0scUJBQXFCLENBQUM7Ozs7QUFFeEU7OztHQUdHO0FBRUgsTUFBTSxPQUFPLFlBQVk7SUFReEIsWUFBb0IsYUFBNEIsRUFBVSxlQUFnQztRQUF0RSxrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUFVLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQVBsRix1QkFBa0IsR0FBRyxJQUFJLGVBQWUsQ0FBa0IsSUFBSSxDQUFDLENBQUM7UUFDaEUsdUJBQWtCLEdBQUcsSUFBSSxlQUFlLENBQVUsSUFBSSxDQUFDLENBQUM7UUFDeEQsd0JBQW1CLEdBQUcsSUFBSSxlQUFlLENBQWtCLElBQUksQ0FBQyxDQUFDO1FBQ2pFLHdCQUFtQixHQUFHLElBQUksZUFBZSxDQUFVLElBQUksQ0FBQyxDQUFD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QyxDQUFDO2FBQ3JDO1FBQ0YsQ0FBQyxDQUFDLENBQUM7SUFDSixDQUFDO0lBRUQ7O09BRUc7SUFDSCxXQUFXO1FBQ1YsSUFBSSxDQUFDLGtCQUFrQixJQUFJLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUM5RCxJQUFJLENBQUMsa0JBQWtCLElBQUksSUFBSSxDQUFDLGtCQUFrQixDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQzlELElBQUksQ0FBQyxtQkFBbUIsSUFBSSxJQUFJLENBQUMsbUJBQW1CLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDaEUsSUFBSSxDQUFDLG1CQUFtQixJQUFJLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNoRSxJQUFJLENBQUMsb0JBQW9CLElBQUksSUFBSSxDQUFDLG9CQUFvQixDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ2xFLElBQUksQ0FBQyxvQkFBb0IsSUFBSSxJQUFJLENBQUMsb0JBQW9CLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDbkUsQ0FBQzs7eUdBL1BXLFlBQVk7NkdBQVosWUFBWTsyRkFBWixZQUFZO2tCQUR4QixVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgT25EZXN0cm95IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIGNvbWJpbmVMYXRlc3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGRpc3RpbmN0VW50aWxDaGFuZ2VkLCBmaWx0ZXIsIG1hcCwgc2tpcCwgdGFrZSwgdGFrZVVudGlsIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgdW50aWxEZXN0cm95IH0gZnJvbSAnLi4vLi4vc2hhcmVkL29wZXJhdG9ycy91bnRpbERlc3Ryb3knO1xuaW1wb3J0IHsgQ29weWxlYWtzUmVwb3J0T3B0aW9ucywgTWF0Y2gsIFJlc3VsdEl0ZW0sIFNjYW5Tb3VyY2UsIFNsaWNlZE1hdGNoIH0gZnJvbSAnLi4vbW9kZWxzJztcbmltcG9ydCB7IEFMRVJUUyB9IGZyb20gJy4uL3V0aWxzL2NvbnN0YW50cyc7XG5pbXBvcnQgKiBhcyBoZWxwZXJzIGZyb20gJy4uL3V0aWxzL21hdGNoLWhlbHBlcnMnO1xuaW1wb3J0IHsgdHJ1dGh5IH0gZnJvbSAnLi4vdXRpbHMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFJlcG9ydFNlcnZpY2UgfSBmcm9tICcuL3JlcG9ydC5zZXJ2aWNlJztcbmltcG9ydCB7IEVSZXBvcnRWaWV3TW9kZWwsIFZpZXdNb2RlU2VydmljZSB9IGZyb20gJy4vdmlldy1tb2RlLnNlcnZpY2UnO1xuXG4vKipcbiAqIFNlcnZpY2UgdGhhdCBjYWxjdWxhdGVzIHRoZSBtYXRjaGVzIGhpZ2hsaWdodCBwb3NpdGlvbnMgd2l0aCByZXNwZWN0IHRvIHRoZSB2aWV3IGFuZCBjb250ZW50IG1vZGUuXG4gKiBJdCBleHBvc2VzIHNvbWUgb2JzZXJ2YWJsZSBzdHJlYW1zIHRoYXQgeW91IGNhbiBzdWJzY3JpYmUgdG8gYW5kIGdldCB0aGUgbmV3ZXN0IHJlbGV2YW50IGNhbGN1bGF0aW9ucy5cbiAqL1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE1hdGNoU2VydmljZSBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG5cdHByaXZhdGUgX3NvdXJjZVRleHRNYXRjaGVzID0gbmV3IEJlaGF2aW9yU3ViamVjdDxTbGljZWRNYXRjaFtdW10+KG51bGwpO1xuXHRwcml2YXRlIF9zb3VyY2VIdG1sTWF0Y2hlcyA9IG5ldyBCZWhhdmlvclN1YmplY3Q8TWF0Y2hbXT4obnVsbCk7XG5cdHByaXZhdGUgX3N1c3BlY3RUZXh0TWF0Y2hlcyA9IG5ldyBCZWhhdmlvclN1YmplY3Q8U2xpY2VkTWF0Y2hbXVtdPihudWxsKTtcblx0cHJpdmF0ZSBfc3VzcGVjdEh0bWxNYXRjaGVzID0gbmV3IEJlaGF2aW9yU3ViamVjdDxNYXRjaFtdPihudWxsKTtcblx0cHJpdmF0ZSBfb3JpZ2luYWxUZXh0TWF0Y2hlcyA9IG5ldyBCZWhhdmlvclN1YmplY3Q8U2xpY2VkTWF0Y2hbXVtdPihudWxsKTtcblx0cHJpdmF0ZSBfb3JpZ2luYWxIdG1sTWF0Y2hlcyA9IG5ldyBCZWhhdmlvclN1YmplY3Q8TWF0Y2hbXT4obnVsbCk7XG5cblx0Y29uc3RydWN0b3IocHJpdmF0ZSByZXBvcnRTZXJ2aWNlOiBSZXBvcnRTZXJ2aWNlLCBwcml2YXRlIHZpZXdNb2RlU2VydmljZTogVmlld01vZGVTZXJ2aWNlKSB7XG5cdFx0Y29uc3QgeyBzb3VyY2UkLCBmaWx0ZXJlZFJlc3VsdHMkLCBvcHRpb25zJCwgcHJldmlld3MkLCBoaWRkZW5SZXN1bHRzJCB9ID0gdGhpcy5yZXBvcnRTZXJ2aWNlO1xuXHRcdGNvbnN0IHsgcmVwb3J0Vmlld01vZGUkIH0gPSB0aGlzLnZpZXdNb2RlU2VydmljZTtcblxuXHRcdC8vIGxpc3RlbiB0byBzdXNwZWN0IGNoYW5nZXMgYW5kIHByb2Nlc3Mgb25lLXRvLW9uZSBtYXRjaGVzXG5cdFx0Y29tYmluZUxhdGVzdChbdGhpcy5vblN1c3BlY3RDaGFuZ2UkLCBvcHRpb25zJC5waXBlKGRpc3RpbmN0VW50aWxDaGFuZ2VkKCkpLCBzb3VyY2UkXSlcblx0XHRcdC5waXBlKHVudGlsRGVzdHJveSh0aGlzKSlcblx0XHRcdC5zdWJzY3JpYmUoKFtyZXN1bHQsIG9wdGlvbnMsIHNvdXJjZV0pID0+IHRoaXMucHJvY2Vzc09uZVRvT25lTWF0Y2hlcyhyZXN1bHQsIG9wdGlvbnMsIHNvdXJjZSkpO1xuXG5cdFx0Ly8gdGhpcy5vblN1c3BlY3RDaGFuZ2UkLnBpcGUodGFrZSgxKSx1bnRpbERlc3Ryb3kodGhpcykpXG5cblx0XHQvLyBsaXN0ZW4gdG8gY2hhbmdlcyBpbiBzZXR0aW5ncyBhbmQgZmlsdGVyZWQgcmVzdWx0c1xuXHRcdC8vIGNvbnN0IHRocm90dGxlZFJlc3VsdHMkID0gZmlsdGVyZWRSZXN1bHRzJC5waXBlKFxuXHRcdC8vIFx0dW50aWxEZXN0cm95KHRoaXMpLFxuXHRcdC8vIFx0dGhyb3R0bGVUaW1lKDUwMDAsIGFzeW5jU2NoZWR1bGVyLCB7IGxlYWRpbmc6IGZhbHNlLCB0cmFpbGluZzogdHJ1ZSB9KVxuXHRcdC8vICk7XG5cdFx0bGV0IF90aW1lb3V0O1xuXHRcdC8qKlxuXHRcdCAqIFdlIHdhbnQgdG8gcHJvY2VzcyBvbmVUb01hbnkgcmVzdWx0cyB3aGVuOlxuXHRcdCAqICogb25jZSB0aGUgc291cmNlIGlzIHJlYWR5XG5cdFx0ICogKiBldmVyeSB0aW1lIHRoZSBmaWx0ZXJlZFJlc3VsdHMkIG9ic2VydmFibGUgdXBkYXRlc1xuXHRcdCAqICogZXZlcnkgdGltZSB0aGUgb3B0aW9ucyBvYmplY3QgaGFzIGNoYW5nZWRcblx0XHQgKiAqIHJlcG9ydCB2aWV3IG1vZGUgY2hhbmdlXG5cdFx0ICovXG5cdFx0Y29tYmluZUxhdGVzdChbZmlsdGVyZWRSZXN1bHRzJCwgcHJldmlld3MkLCBoaWRkZW5SZXN1bHRzJCwgb3B0aW9ucyQsIHNvdXJjZSQsIHJlcG9ydFZpZXdNb2RlJF0pXG5cdFx0XHQucGlwZSh1bnRpbERlc3Ryb3kodGhpcykpXG5cdFx0XHQuc3Vic2NyaWJlKChbcmVzdWx0cywgcHJldmlld3MsIGhpZGRlblJlc3VsdHMsIG9wdGlvbnMsIHNvdXJjZSwgdmlld01vZGVdKSA9PiB7XG5cdFx0XHRcdGlmIChfdGltZW91dCkge1xuXHRcdFx0XHRcdGNsZWFyVGltZW91dChfdGltZW91dCk7XG5cdFx0XHRcdH1cblx0XHRcdFx0aWYgKHZpZXdNb2RlID09PSBFUmVwb3J0Vmlld01vZGVsLkFsZXJ0cyB8fCB2aWV3TW9kZSA9PT0gRVJlcG9ydFZpZXdNb2RlbC5BSVZpZXcpIHtcblx0XHRcdFx0XHR0aGlzLnByb2Nlc3NBbGVydE1hdGNoZXMob3B0aW9ucywgc291cmNlKTtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRfdGltZW91dCA9IHNldFRpbWVvdXQoXG5cdFx0XHRcdFx0XHQoKSA9PiB7XG5cdFx0XHRcdFx0XHRcdHRoaXMucHJvY2Vzc09uZVRvTWFueU1hdGNoZXMocmVzdWx0cywgb3B0aW9ucywgc291cmNlKTtcblx0XHRcdFx0XHRcdH0sXG5cdFx0XHRcdFx0XHRyZXN1bHRzLmxlbmd0aCA9PT0gcHJldmlld3MubGVuZ3RoIC0gaGlkZGVuUmVzdWx0cy5sZW5ndGggPyAwIDogNTAwMFxuXHRcdFx0XHRcdCk7XG5cdFx0XHRcdH1cblx0XHRcdH0pO1xuXHR9XG5cblx0cHJpdmF0ZSBnZXQgb25Tb3VyY2VGaXJzdFRleHRNb2RlJCgpIHtcblx0XHRyZXR1cm4gdGhpcy5yZXBvcnRTZXJ2aWNlLmNvbnRlbnRNb2RlJC5waXBlKFxuXHRcdFx0dW50aWxEZXN0cm95KHRoaXMpLFxuXHRcdFx0ZmlsdGVyKGNvbnRlbnQgPT4gY29udGVudCA9PT0gJ3RleHQnKSxcblx0XHRcdHRha2UoMSlcblx0XHQpO1xuXHR9XG5cblx0cHJpdmF0ZSBnZXQgb25Tb3VyY2VGaXJzdEh0bWxNb2RlJCgpIHtcblx0XHRjb25zdCB7IGNvbnRlbnRNb2RlJCwgc291cmNlJCB9ID0gdGhpcy5yZXBvcnRTZXJ2aWNlO1xuXHRcdHJldHVybiBjb21iaW5lTGF0ZXN0KFtjb250ZW50TW9kZSQsIHNvdXJjZSRdKS5waXBlKFxuXHRcdFx0dW50aWxEZXN0cm95KHRoaXMpLFxuXHRcdFx0ZmlsdGVyKChbY29udGVudCwgc291cmNlXSkgPT4gY29udGVudCA9PT0gJ2h0bWwnICYmIHNvdXJjZS5odG1sICYmICEhc291cmNlLmh0bWwudmFsdWUpLFxuXHRcdFx0dGFrZSgxKVxuXHRcdCk7XG5cdH1cblx0cHJpdmF0ZSBnZXQgb25Tb3VyY2VDb250ZW50TW9kZUNoYW5nZSQoKSB7XG5cdFx0cmV0dXJuIHRoaXMucmVwb3J0U2VydmljZS5jb250ZW50TW9kZSQucGlwZShcblx0XHRcdHVudGlsRGVzdHJveSh0aGlzKSxcblx0XHRcdG1hcChjb250ZW50ID0+IGNvbnRlbnQpLFxuXHRcdFx0ZGlzdGluY3RVbnRpbENoYW5nZWQoKVxuXHRcdCk7XG5cdH1cblx0cHJpdmF0ZSBnZXQgb25TdXNwZWN0Q29udGVudE1vZGVDaGFuZ2UkKCkge1xuXHRcdHJldHVybiB0aGlzLnJlcG9ydFNlcnZpY2UuY29udGVudE1vZGUkLnBpcGUoXG5cdFx0XHR1bnRpbERlc3Ryb3kodGhpcyksXG5cdFx0XHRtYXAoY29udGVudCA9PiBjb250ZW50KSxcblx0XHRcdGRpc3RpbmN0VW50aWxDaGFuZ2VkKClcblx0XHQpO1xuXHR9XG5cdHByaXZhdGUgZ2V0IG9uU3VzcGVjdEZpcnN0VGV4dE1vZGUkKCkge1xuXHRcdHJldHVybiB0aGlzLnJlcG9ydFNlcnZpY2UuY29udGVudE1vZGUkLnBpcGUoXG5cdFx0XHR1bnRpbERlc3Ryb3kodGhpcyksXG5cdFx0XHRmaWx0ZXIoY29udGVudCA9PiBjb250ZW50ID09PSAndGV4dCcpLFxuXHRcdFx0dGFrZSgxKVxuXHRcdCk7XG5cdH1cblx0cHJpdmF0ZSBnZXQgb25TdXNwZWN0Rmlyc3RIdG1sTW9kZSQoKSB7XG5cdFx0Y29uc3QgeyBjb250ZW50TW9kZSQsIHN1c3BlY3RSZXN1bHQkOiBzdXNwZWN0JCB9ID0gdGhpcy5yZXBvcnRTZXJ2aWNlO1xuXHRcdHJldHVybiBjb21iaW5lTGF0ZXN0KFtjb250ZW50TW9kZSQsIHN1c3BlY3QkXSkucGlwZShcblx0XHRcdHVudGlsRGVzdHJveSh0aGlzKSxcblx0XHRcdGZpbHRlcigoW2NvbnRlbnQsIHN1c3BlY3RdKSA9PiBjb250ZW50ID09PSAnaHRtbCcgJiYgc3VzcGVjdCAmJiBzdXNwZWN0LnJlc3VsdCAmJiAhIXN1c3BlY3QucmVzdWx0Lmh0bWwudmFsdWUpLFxuXHRcdFx0dGFrZSgxKVxuXHRcdCk7XG5cdH1cblx0cHJpdmF0ZSBnZXQgb25TdXNwZWN0Q2hhbmdlJCgpIHtcblx0XHRyZXR1cm4gdGhpcy5yZXBvcnRTZXJ2aWNlLnN1c3BlY3RSZXN1bHQkLnBpcGUodW50aWxEZXN0cm95KHRoaXMpLCB0cnV0aHkoKSwgZGlzdGluY3RVbnRpbENoYW5nZWQoKSk7XG5cdH1cblxuXHRwcml2YXRlIGdldCBvbk5ld1N1c3BlY3QkKCkge1xuXHRcdHJldHVybiB0aGlzLm9uU3VzcGVjdENoYW5nZSQucGlwZSh1bnRpbERlc3Ryb3kodGhpcyksIHNraXAoMSkpO1xuXHR9XG5cblx0LyoqIEVtaXRzIG1hdGNoZXMgdGhhdCBhcmUgcmVsZXZhbnQgdG8gc291cmNlIHRleHQgb25lLXRvLW9uZSBtb2RlICovXG5cdHB1YmxpYyBnZXQgc291cmNlVGV4dE1hdGNoZXMkKCkge1xuXHRcdHJldHVybiB0aGlzLl9zb3VyY2VUZXh0TWF0Y2hlcy5hc09ic2VydmFibGUoKS5waXBlKHRydXRoeSgpKTtcblx0fVxuXG5cdC8qKiBFbWl0cyBtYXRjaGVzIHRoYXQgYXJlIHJlbGV2YW50IHRvIHNvdXJjZSBodG1sIG9uZS10by1vbmUgbW9kZSAqL1xuXHRwdWJsaWMgZ2V0IHNvdXJjZUh0bWxNYXRjaGVzJCgpIHtcblx0XHRyZXR1cm4gdGhpcy5fc291cmNlSHRtbE1hdGNoZXMuYXNPYnNlcnZhYmxlKCkucGlwZSh1bnRpbERlc3Ryb3kodGhpcyksIHRydXRoeSgpKTtcblx0fVxuXG5cdC8qKiBFbWl0cyBtYXRjaGVzIHRoYXQgYXJlIHJlbGV2YW50IHRvIHN1c3BlY3QgdGV4dCBvbmUtdG8tb25lIG1vZGUgKi9cblx0cHVibGljIGdldCBzdXNwZWN0VGV4dE1hdGNoZXMkKCkge1xuXHRcdHJldHVybiB0aGlzLl9zdXNwZWN0VGV4dE1hdGNoZXMuYXNPYnNlcnZhYmxlKCkucGlwZSh1bnRpbERlc3Ryb3kodGhpcyksIHRydXRoeSgpKTtcblx0fVxuXG5cdC8qKiBFbWl0cyBtYXRjaGVzIHRoYXQgYXJlIHJlbGV2YW50IHRvIHN1c3BlY3QgaHRtbCBvbmUtdG8tb25lIG1vZGUgKi9cblx0cHVibGljIGdldCBzdXNwZWN0SHRtbE1hdGNoZXMkKCkge1xuXHRcdHJldHVybiB0aGlzLl9zdXNwZWN0SHRtbE1hdGNoZXMuYXNPYnNlcnZhYmxlKCkucGlwZSh1bnRpbERlc3Ryb3kodGhpcyksIHRydXRoeSgpKTtcblx0fVxuXG5cdC8qKiBFbWl0cyBtYXRjaGVzIHRoYXQgYXJlIHJlbGV2YW50IHRvIHNvdXJjZSB0ZXh0IG9uZS10by1tYW55IG1vZGUgKi9cblx0cHVibGljIGdldCBvcmlnaW5hbFRleHRNYXRjaGVzJCgpIHtcblx0XHRyZXR1cm4gdGhpcy5fb3JpZ2luYWxUZXh0TWF0Y2hlcy5hc09ic2VydmFibGUoKS5waXBlKHVudGlsRGVzdHJveSh0aGlzKSwgdHJ1dGh5KCkpO1xuXHR9XG5cblx0LyoqIEVtaXRzIG1hdGNoZXMgdGhhdCBhcmUgcmVsZXZhbnQgdG8gc291cmNlIGh0bWwgb25lLXRvLW1hbnkgbW9kZSAqL1xuXHRwdWJsaWMgZ2V0IG9yaWdpbmFsSHRtbE1hdGNoZXMkKCkge1xuXHRcdHJldHVybiB0aGlzLl9vcmlnaW5hbEh0bWxNYXRjaGVzLmFzT2JzZXJ2YWJsZSgpLnBpcGUodW50aWxEZXN0cm95KHRoaXMpLCB0cnV0aHkoKSk7XG5cdH1cblxuXHQvKipcblx0ICogUHJvY2VzcyBtYXRjaGVzIG9uIHRoZSBgb25lLXRvLW9uZWAgdmlldyBtb2RlXG5cdCAqIHdpbGwgY2FsY3VsYXRlIHRoZSBtYXRjaGVzIHdoZW4gc2hvd2luZyBgdGV4dGAgb3IgYGh0bWxgIGZvciB0aGUgZmlyc3QgdGltZVxuXHQgKiBAcGFyYW0gaXRlbSB0aGUgcmVzdWx0IHRvIGNhbGN1bGF0ZSBtYXRjaGVzIGZyb21cblx0ICogQHBhcmFtIHNldHRpbmdzIHRoZSByZXBvcnQgc2V0dGluZ3Ncblx0ICogQHBhcmFtIHNvdXJjZSAgdGhlIHNjYW4gc291cmNlXG5cdCAqL1xuXHRwcml2YXRlIHByb2Nlc3NPbmVUb09uZU1hdGNoZXMoaXRlbTogUmVzdWx0SXRlbSwgc2V0dGluZ3M6IENvcHlsZWFrc1JlcG9ydE9wdGlvbnMsIHNvdXJjZTogU2NhblNvdXJjZSkge1xuXHRcdGlmIChzb3VyY2UuaHRtbCAmJiBzb3VyY2UuaHRtbC52YWx1ZSAmJiAhKGl0ZW0ucmVzdWx0Lmh0bWwgJiYgaXRlbS5yZXN1bHQuaHRtbC52YWx1ZSkpIHtcblx0XHRcdC8vIGNhc2Ugd2hlcmUgc291cmNlIGhhcyBodG1sIGJ1dCBzdXNwZWN0IGRvZXNudFxuXHRcdFx0dGhpcy5vblNvdXJjZUZpcnN0VGV4dE1vZGUkLnBpcGUodGFrZVVudGlsKHRoaXMub25OZXdTdXNwZWN0JCkpLnN1YnNjcmliZSgoKSA9PiB7XG5cdFx0XHRcdGNvbnN0IHRleHQgPSBoZWxwZXJzLnByb2Nlc3NTb3VyY2VUZXh0KGl0ZW0sIHNldHRpbmdzLCBzb3VyY2UpO1xuXHRcdFx0XHR0aGlzLl9zb3VyY2VUZXh0TWF0Y2hlcy5uZXh0KHRleHQpO1xuXHRcdFx0fSk7XG5cdFx0XHR0aGlzLm9uU291cmNlRmlyc3RIdG1sTW9kZSQucGlwZSh0YWtlVW50aWwodGhpcy5vbk5ld1N1c3BlY3QkKSkuc3Vic2NyaWJlKCgpID0+IHtcblx0XHRcdFx0Y29uc3QgaHRtbCA9IGhlbHBlcnMucHJvY2Vzc1NvdXJjZUh0bWwoaXRlbSwgc2V0dGluZ3MsIHNvdXJjZSk7XG5cdFx0XHRcdHRoaXMuX3NvdXJjZUh0bWxNYXRjaGVzLm5leHQoaHRtbCk7XG5cdFx0XHR9KTtcblxuXHRcdFx0dGhpcy5vblN1c3BlY3RDb250ZW50TW9kZUNoYW5nZSQucGlwZSh0YWtlVW50aWwodGhpcy5vbk5ld1N1c3BlY3QkKSkuc3Vic2NyaWJlKG1vZGUgPT4ge1xuXHRcdFx0XHRjb25zdCB0ZXh0ID0gaGVscGVycy5wcm9jZXNzU3VzcGVjdFRleHQoaXRlbSwgc2V0dGluZ3MsIG1vZGUgPT09ICd0ZXh0Jyk7XG5cdFx0XHRcdHRoaXMuX3N1c3BlY3RUZXh0TWF0Y2hlcy5uZXh0KHRleHQpO1xuXHRcdFx0fSk7XG5cdFx0fSBlbHNlIGlmICghKHNvdXJjZS5odG1sICYmIHNvdXJjZS5odG1sLnZhbHVlKSAmJiBpdGVtLnJlc3VsdC5odG1sICYmIGl0ZW0ucmVzdWx0Lmh0bWwudmFsdWUpIHtcblx0XHRcdC8vIGNhc2Ugd2hlcmUgc3VzcGVjdCBoYXMgaHRtbCBidXQgc291cmNlIGRvZXNudFxuXHRcdFx0dGhpcy5vblN1c3BlY3RGaXJzdFRleHRNb2RlJC5waXBlKHRha2VVbnRpbCh0aGlzLm9uTmV3U3VzcGVjdCQpKS5zdWJzY3JpYmUoKCkgPT4ge1xuXHRcdFx0XHRjb25zdCB0ZXh0ID0gaGVscGVycy5wcm9jZXNzU3VzcGVjdFRleHQoaXRlbSwgc2V0dGluZ3MpO1xuXHRcdFx0XHR0aGlzLl9zdXNwZWN0VGV4dE1hdGNoZXMubmV4dCh0ZXh0KTtcblx0XHRcdH0pO1xuXHRcdFx0dGhpcy5vblN1c3BlY3RGaXJzdEh0bWxNb2RlJC5waXBlKHRha2VVbnRpbCh0aGlzLm9uTmV3U3VzcGVjdCQpKS5zdWJzY3JpYmUoKCkgPT4ge1xuXHRcdFx0XHRjb25zdCBodG1sID0gaGVscGVycy5wcm9jZXNzU3VzcGVjdEh0bWwoaXRlbSwgc2V0dGluZ3MpO1xuXHRcdFx0XHR0aGlzLl9zdXNwZWN0SHRtbE1hdGNoZXMubmV4dChodG1sKTtcblx0XHRcdH0pO1xuXHRcdFx0dGhpcy5vblNvdXJjZUNvbnRlbnRNb2RlQ2hhbmdlJC5waXBlKHRha2VVbnRpbCh0aGlzLm9uTmV3U3VzcGVjdCQpKS5zdWJzY3JpYmUobW9kZSA9PiB7XG5cdFx0XHRcdGNvbnN0IHRleHQgPSBoZWxwZXJzLnByb2Nlc3NTb3VyY2VUZXh0KGl0ZW0sIHNldHRpbmdzLCBzb3VyY2UsIG1vZGUgPT09ICd0ZXh0Jyk7XG5cdFx0XHRcdHRoaXMuX3NvdXJjZVRleHRNYXRjaGVzLm5leHQodGV4dCk7XG5cdFx0XHR9KTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhpcy5vblNvdXJjZUZpcnN0VGV4dE1vZGUkLnBpcGUodGFrZVVudGlsKHRoaXMub25OZXdTdXNwZWN0JCkpLnN1YnNjcmliZSgoKSA9PiB7XG5cdFx0XHRcdHNldFRpbWVvdXQoKCkgPT4ge1xuXHRcdFx0XHRcdGNvbnN0IHRleHQgPSBoZWxwZXJzLnByb2Nlc3NTb3VyY2VUZXh0KGl0ZW0sIHNldHRpbmdzLCBzb3VyY2UpO1xuXHRcdFx0XHRcdHRoaXMuX3NvdXJjZVRleHRNYXRjaGVzLm5leHQodGV4dCk7XG5cdFx0XHRcdH0pO1xuXHRcdFx0XHRzZXRUaW1lb3V0KCgpID0+IHtcblx0XHRcdFx0XHRjb25zdCB0ZXh0ID0gaGVscGVycy5wcm9jZXNzU3VzcGVjdFRleHQoaXRlbSwgc2V0dGluZ3MpO1xuXHRcdFx0XHRcdHRoaXMuX3N1c3BlY3RUZXh0TWF0Y2hlcy5uZXh0KHRleHQpO1xuXHRcdFx0XHR9KTtcblx0XHRcdH0pO1xuXHRcdFx0dGhpcy5vblNvdXJjZUZpcnN0SHRtbE1vZGUkLnBpcGUodGFrZVVudGlsKHRoaXMub25OZXdTdXNwZWN0JCkpLnN1YnNjcmliZSgoKSA9PiB7XG5cdFx0XHRcdHNldFRpbWVvdXQoKCkgPT4ge1xuXHRcdFx0XHRcdGNvbnN0IGh0bWwgPSBoZWxwZXJzLnByb2Nlc3NTb3VyY2VIdG1sKGl0ZW0sIHNldHRpbmdzLCBzb3VyY2UpO1xuXHRcdFx0XHRcdHRoaXMuX3NvdXJjZUh0bWxNYXRjaGVzLm5leHQoaHRtbCk7XG5cdFx0XHRcdH0pO1xuXHRcdFx0XHRzZXRUaW1lb3V0KCgpID0+IHtcblx0XHRcdFx0XHRjb25zdCBodG1sID0gaGVscGVycy5wcm9jZXNzU3VzcGVjdEh0bWwoaXRlbSwgc2V0dGluZ3MpO1xuXHRcdFx0XHRcdHRoaXMuX3N1c3BlY3RIdG1sTWF0Y2hlcy5uZXh0KGh0bWwpO1xuXHRcdFx0XHR9KTtcblx0XHRcdH0pO1xuXHRcdH1cblx0fVxuXG5cdC8qKlxuXHQgKiBQcm9jZXNzIG1hdGNoZXMgb24gdGhlIGBvbmUtdG8tbWFueWAgdmlldyBtb2RlXG5cdCAqIHdpbGwgY2FsY3VsYXRlIHRoZSBtYXRjaGVzIHdoZW4gc2hvd2luZyBgdGV4dGAgb3IgYGh0bWxgIGZvciB0aGUgZmlyc3QgdGltZVxuXHQgKiBAcGFyYW0gcmVzdWx0cyB0aGUgcmVzdWx0cyB0byBjYWxjdWxhdGUgbWF0Y2hlcyBmcm9tXG5cdCAqIEBwYXJhbSBzZXR0aW5ncyB0aGUgcmVwb3J0IHNldHRpbmdzXG5cdCAqIEBwYXJhbSBzb3VyY2UgIHRoZSBzY2FuIHNvdXJjZVxuXHQgKi9cblx0cHJpdmF0ZSBwcm9jZXNzT25lVG9NYW55TWF0Y2hlcyhyZXN1bHRzOiBSZXN1bHRJdGVtW10sIHNldHRpbmdzOiBDb3B5bGVha3NSZXBvcnRPcHRpb25zLCBzb3VyY2U6IFNjYW5Tb3VyY2UpIHtcblx0XHR0aGlzLm9uU291cmNlRmlyc3RUZXh0TW9kZSQuc3Vic2NyaWJlKCgpID0+IHtcblx0XHRcdGNvbnN0IHRleHQgPSBoZWxwZXJzLnByb2Nlc3NTb3VyY2VUZXh0KHJlc3VsdHMsIHNldHRpbmdzLCBzb3VyY2UpO1xuXHRcdFx0aWYgKHRleHQpIHtcblx0XHRcdFx0dGhpcy5fb3JpZ2luYWxUZXh0TWF0Y2hlcy5uZXh0KHRleHQpO1xuXHRcdFx0fVxuXHRcdH0pO1xuXHRcdHRoaXMub25Tb3VyY2VGaXJzdEh0bWxNb2RlJC5zdWJzY3JpYmUoKCkgPT4ge1xuXHRcdFx0Y29uc3QgaHRtbCA9IGhlbHBlcnMucHJvY2Vzc1NvdXJjZUh0bWwocmVzdWx0cywgc2V0dGluZ3MsIHNvdXJjZSk7XG5cdFx0XHRpZiAoaHRtbCkge1xuXHRcdFx0XHR0aGlzLl9vcmlnaW5hbEh0bWxNYXRjaGVzLm5leHQoaHRtbCk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdH1cblxuXHQvKipcblx0ICogUHJvY2VzcyBtYXRjaGVzIG9uIHRoZSBgc3VzcGVjdGVkLWNoYXJhY3Rlci1yZXBsYWNlbWVudGAgdmlldyBtb2RlXG5cdCAqIHdpbGwgY2FsY3VsYXRlIHRoZSBtYXRjaGVzIHdoZW4gc2hvd2luZyBgdGV4dGAgb3IgYGh0bWxgIGZvciB0aGUgZmlyc3QgdGltZVxuXHQgKiBAcGFyYW0gc2V0dGluZ3MgdGhlIHJlcG9ydCBzZXR0aW5nc1xuXHQgKiBAcGFyYW0gc291cmNlICB0aGUgc2NhbiBzb3VyY2Vcblx0ICovXG5cdHByaXZhdGUgcHJvY2Vzc0FsZXJ0TWF0Y2hlcyhzZXR0aW5nczogQ29weWxlYWtzUmVwb3J0T3B0aW9ucywgc291cmNlOiBTY2FuU291cmNlKSB7XG5cdFx0dGhpcy5vblNvdXJjZUZpcnN0VGV4dE1vZGUkLnN1YnNjcmliZSgoKSA9PiB7XG5cdFx0XHRsZXQgdGV4dDogU2xpY2VkTWF0Y2hbXVtdO1xuXHRcdFx0aWYgKHRoaXMudmlld01vZGVTZXJ2aWNlPy5zZWxlY3RlZEFsZXJ0Py5jb2RlID09PSBBTEVSVFMuU1VTUEVDVEVEX0NIQVJBQ1RFUl9SRVBMQUNFTUVOVF9DT0RFKSB7XG5cdFx0XHRcdHRleHQgPSBoZWxwZXJzLnByb2Nlc3NTdXNwZWN0ZWRDaGFyYWN0ZXJNYXRjaGVzKHNvdXJjZSwgdGhpcy52aWV3TW9kZVNlcnZpY2Uuc2VsZWN0ZWRBbGVydCk7XG5cdFx0XHR9IGVsc2UgaWYgKHRoaXMudmlld01vZGVTZXJ2aWNlPy5zZWxlY3RlZEFsZXJ0Py5jb2RlID09PSBBTEVSVFMuU1VTUEVDVEVEX0FJX1RFWFRfREVURUNURUQpIHtcblx0XHRcdFx0dGV4dCA9IGhlbHBlcnMucHJvY2Vzc0FJQ2hlYXRpbmdNYXRjaGVzKHNvdXJjZSwgdGhpcy52aWV3TW9kZVNlcnZpY2Uuc2VsZWN0ZWRBbGVydCk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHR0ZXh0ID0gaGVscGVycy5wcm9jZXNzU291cmNlVGV4dChbXSwgc2V0dGluZ3MsIHNvdXJjZSk7XG5cdFx0XHR9XG5cdFx0XHRpZiAodGV4dCkge1xuXHRcdFx0XHR0aGlzLl9vcmlnaW5hbFRleHRNYXRjaGVzLm5leHQodGV4dCk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdFx0dGhpcy5vblNvdXJjZUZpcnN0SHRtbE1vZGUkLnN1YnNjcmliZSgoKSA9PiB7XG5cdFx0XHRjb25zdCBodG1sID0gaGVscGVycy5wcm9jZXNzU291cmNlSHRtbChbXSwgc2V0dGluZ3MsIHNvdXJjZSk7XG5cdFx0XHRpZiAoaHRtbCkge1xuXHRcdFx0XHR0aGlzLl9vcmlnaW5hbEh0bWxNYXRjaGVzLm5leHQoaHRtbCk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdH1cblxuXHQvKipcblx0ICogZHRvclxuXHQgKi9cblx0bmdPbkRlc3Ryb3koKSB7XG5cdFx0dGhpcy5fc291cmNlVGV4dE1hdGNoZXMgJiYgdGhpcy5fc291cmNlVGV4dE1hdGNoZXMuY29tcGxldGUoKTtcblx0XHR0aGlzLl9zb3VyY2VIdG1sTWF0Y2hlcyAmJiB0aGlzLl9zb3VyY2VIdG1sTWF0Y2hlcy5jb21wbGV0ZSgpO1xuXHRcdHRoaXMuX3N1c3BlY3RUZXh0TWF0Y2hlcyAmJiB0aGlzLl9zdXNwZWN0VGV4dE1hdGNoZXMuY29tcGxldGUoKTtcblx0XHR0aGlzLl9zdXNwZWN0SHRtbE1hdGNoZXMgJiYgdGhpcy5fc3VzcGVjdEh0bWxNYXRjaGVzLmNvbXBsZXRlKCk7XG5cdFx0dGhpcy5fb3JpZ2luYWxUZXh0TWF0Y2hlcyAmJiB0aGlzLl9vcmlnaW5hbFRleHRNYXRjaGVzLmNvbXBsZXRlKCk7XG5cdFx0dGhpcy5fb3JpZ2luYWxIdG1sTWF0Y2hlcyAmJiB0aGlzLl9vcmlnaW5hbEh0bWxNYXRjaGVzLmNvbXBsZXRlKCk7XG5cdH1cbn1cbiJdfQ==