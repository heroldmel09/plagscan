/**
 * document ready event handler
 * @param fn the callback to execute when the document is ready
 */
function onDocumentReady(fn) {
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        setTimeout(fn, 1);
    }
    else {
        document.addEventListener('DOMContentLoaded', fn);
    }
}
function ready() {
    let current;
    let matches;
    let groups;
    let isPdf = document.querySelector('meta[content="pdf2htmlEX"]') !== null;
    window.addEventListener('message', handleMessageFromParent);
    init();
    /**
     * Initialization code, will execute before emitting iframe-ready event
     */
    function init() {
        Array.from(document.links).forEach(x => (x.href = 'javascript:void(0)')); // disable links
        matches = Array.from(document.querySelectorAll('span[match]'));
        groups = matches.reduce((prev, curr) => {
            prev[curr.dataset.gid] = prev[curr.dataset.gid] || [];
            prev[curr.dataset.gid].push(curr);
            return prev;
        }, {});
        matches.forEach(elem => {
            elem.addEventListener('click', onMatchClick);
            elem.addEventListener('mouseenter', onMatchHover);
            elem.addEventListener('mouseleave', onMatchHover);
        });
        document.querySelectorAll('span[exclude-partial-scan]').forEach(elem => {
            elem.addEventListener('click', () => messageParent({ type: 'upgrade-plan' }));
        });
    }
    function handleMessageFromParent(nativeEvent) {
        if (nativeEvent.source !== window.parent) {
            return;
        }
        const event = nativeEvent.data;
        switch (event.type) {
            case 'match-select':
                handleBroadcastMatchSelect(event);
                break;
            case 'match-jump':
                handleMatchJump(event);
                break;
            default:
                console.error('unknown event in source frame', nativeEvent);
        }
    }
    /**
     * Handle a match-jump event
     * @param event the match-jump event object
     */
    function handleMatchJump(event) {
        // cases:
        // nothing is marked - force the start
        if (!current) {
            handleMatchSelect(matches[0], true);
            return;
        }
        // start is marked and backward  -  do nothing
        // end is marked and forward - do nothing
        const oldGid = current.dataset.gid;
        const firstGid = matches[0].dataset.gid;
        const lastGid = matches[matches.length - 1].dataset.gid;
        if ((oldGid === firstGid && !event.forward) || (oldGid === lastGid && event.forward)) {
            return;
        }
        // middle is marked - just go next/prev
        let currentIndex = matches.indexOf(current);
        const step = event.forward ? 1 : -1;
        while (0 <= currentIndex && currentIndex < matches.length) {
            currentIndex += step;
            if (matches[currentIndex].dataset.gid !== oldGid) {
                break;
            }
        }
        const nextGid = matches[currentIndex].dataset.gid;
        handleMatchSelect(groups[nextGid][0], true);
    }
    /**
     * Emit events to parent using postMessage API
     * @param event the event to emit
     */
    function messageParent(event) {
        window.parent.postMessage(event, '*');
    }
    /**
     * Handle a click on a match element
     * @param event the default mouse event
     */
    function onMatchClick(event) {
        const elem = event.target;
        handleMatchSelect(elem, true);
    }
    /**
     * handle a broadcasted `match-select` event
     * @param event the match select event
     */
    function handleBroadcastMatchSelect(event) {
        const elem = document.querySelector(`span[match][data-index='${event.index}']`);
        if (!elem && event.index !== -1) {
            messageParent({ type: 'match-warn' });
        }
        handleMatchSelect(elem || current, false); // should not rebroadcast
    }
    /**
     * Handles match selection that was requested programmatically or by user click
     * @param elem the element that was selected
     * @param broadcast a flag indicating wether to message the suspect frame about this element being selected
     */
    function handleMatchSelect(elem, broadcast = false) {
        if (current && current.dataset.gid === elem.dataset.gid) {
            groups[current.dataset.gid].forEach(el => el.toggleAttribute('on', false));
            current = null;
            if (broadcast) {
                messageParent({ type: 'match-select', index: -1 });
            }
            return;
        }
        if (current) {
            groups[current.dataset.gid].forEach(el => el.toggleAttribute('on', false));
        }
        if (elem) {
            groups[elem.dataset.gid].forEach(el => el.toggleAttribute('on', true));
            if (isPdf) {
                elem.closest('.pc').classList.add('opened');
            }
            elem.scrollIntoView();
        }
        current = elem;
        if (broadcast) {
            messageParent({ type: 'match-select', index: +current.dataset.index });
        }
    }
    /**
     * Handle match hover event
     * @param event the default mouse event
     */
    function onMatchHover(event) {
        const elem = event?.target;
        groups[elem?.dataset?.gid]?.forEach(el => el?.classList?.toggle('hover'));
    }
}
export default `(${onDocumentReady.toString()})(${ready.toString()})`;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib25lLXRvLW9uZS1pZnJhbWUtbG9naWMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9wbGFnaWFyaXNtLXJlcG9ydC9zcmMvbGliL3BsYWdpYXJpc20tcmVwb3J0L2NvbXBvbmVudHMvaHRtbC1oZWxwZXJzL29uZS10by1vbmUtaWZyYW1lLWxvZ2ljLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUdBOzs7R0FHRztBQUNILFNBQVMsZUFBZSxDQUFDLEVBQU87SUFDL0IsSUFBSSxRQUFRLENBQUMsVUFBVSxLQUFLLFVBQVUsSUFBSSxRQUFRLENBQUMsVUFBVSxLQUFLLGFBQWEsRUFBRTtRQUNoRixVQUFVLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO0tBQ2xCO1NBQU07UUFDTixRQUFRLENBQUMsZ0JBQWdCLENBQUMsa0JBQWtCLEVBQUUsRUFBRSxDQUFDLENBQUM7S0FDbEQ7QUFDRixDQUFDO0FBRUQsU0FBUyxLQUFLO0lBQ2IsSUFBSSxPQUF3QixDQUFDO0lBQzdCLElBQUksT0FBMEIsQ0FBQztJQUMvQixJQUFJLE1BQTRDLENBQUM7SUFDakQsSUFBSSxLQUFLLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyw0QkFBNEIsQ0FBQyxLQUFLLElBQUksQ0FBQztJQUN6RSxNQUFjLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxFQUFFLHVCQUF1QixDQUFDLENBQUM7SUFDckUsSUFBSSxFQUFFLENBQUM7SUFFUDs7T0FFRztJQUNILFNBQVMsSUFBSTtRQUNaLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksR0FBRyxvQkFBb0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxnQkFBZ0I7UUFDMUYsT0FBTyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLGdCQUFnQixD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QUUsS0FBSyxFQUFFLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO1NBQ3ZFO0lBQ0YsQ0FBQztJQUVEOzs7T0FHRztJQUNILFNBQVMsWUFBWSxDQUFDLEtBQWlCO1FBQ3RDLE1BQU0sSUFBSSxHQUFHLEtBQUssRUFBRSxNQUF5QixDQUFDO1FBQzlDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsT0FBTyxFQUFFLEdBQUcsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxTQUFTLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7SUFDM0UsQ0FBQztBQUNGLENBQUM7QUFFRCxlQUFlLElBQUksZUFBZSxDQUFDLFFBQVEsRUFBRSxLQUFLLEtBQUssQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyogdHNsaW50OmRpc2FibGUgKi9cbmltcG9ydCB7IFBvc3RNZXNzYWdlRXZlbnQsIE1hdGNoSnVtcEV2ZW50LCBNYXRjaFNlbGVjdEV2ZW50IH0gZnJvbSAnLi4vLi4vbW9kZWxzJztcblxuLyoqXG4gKiBkb2N1bWVudCByZWFkeSBldmVudCBoYW5kbGVyXG4gKiBAcGFyYW0gZm4gdGhlIGNhbGxiYWNrIHRvIGV4ZWN1dGUgd2hlbiB0aGUgZG9jdW1lbnQgaXMgcmVhZHlcbiAqL1xuZnVuY3Rpb24gb25Eb2N1bWVudFJlYWR5KGZuOiBhbnkpIHtcblx0aWYgKGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICdjb21wbGV0ZScgfHwgZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gJ2ludGVyYWN0aXZlJykge1xuXHRcdHNldFRpbWVvdXQoZm4sIDEpO1xuXHR9IGVsc2Uge1xuXHRcdGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBmbik7XG5cdH1cbn1cblxuZnVuY3Rpb24gcmVhZHkoKSB7XG5cdGxldCBjdXJyZW50OiBIVE1MU3BhbkVsZW1lbnQ7XG5cdGxldCBtYXRjaGVzOiBIVE1MU3BhbkVsZW1lbnRbXTtcblx0bGV0IGdyb3VwczogeyBbZ2lkOiBzdHJpbmddOiBIVE1MU3BhbkVsZW1lbnRbXSB9O1xuXHRsZXQgaXNQZGYgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdtZXRhW2NvbnRlbnQ9XCJwZGYyaHRtbEVYXCJdJykgIT09IG51bGw7XG5cdCh3aW5kb3cgYXMgYW55KS5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgaGFuZGxlTWVzc2FnZUZyb21QYXJlbnQpO1xuXHRpbml0KCk7XG5cblx0LyoqXG5cdCAqIEluaXRpYWxpemF0aW9uIGNvZGUsIHdpbGwgZXhlY3V0ZSBiZWZvcmUgZW1pdHRpbmcgaWZyYW1lLXJlYWR5IGV2ZW50XG5cdCAqL1xuXHRmdW5jdGlvbiBpbml0KCkge1xuXHRcdEFycmF5LmZyb20oZG9jdW1lbnQubGlua3MpLmZvckVhY2goeCA9PiAoeC5ocmVmID0gJ2phdmFzY3JpcHQ6dm9pZCgwKScpKTsgLy8gZGlzYWJsZSBsaW5rc1xuXHRcdG1hdGNoZXMgPSBBcnJheS5mcm9tKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ3NwYW5bbWF0Y2hdJykpO1xuXHRcdGdyb3VwcyA9IG1hdGNoZXMucmVkdWNlKChwcmV2LCBjdXJyKSA9PiB7XG5cdFx0XHRwcmV2W2N1cnIuZGF0YXNldC5naWRdID0gcHJldltjdXJyLmRhdGFzZXQuZ2lkXSB8fCBbXTtcblx0XHRcdHByZXZbY3Vyci5kYXRhc2V0LmdpZF0ucHVzaChjdXJyKTtcblx0XHRcdHJldHVybiBwcmV2O1xuXHRcdH0sIHt9KTtcblxuXHRcdG1hdGNoZXMuZm9yRWFjaChlbGVtID0+IHtcblx0XHRcdGVsZW0uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBvbk1hdGNoQ2xpY2spO1xuXHRcdFx0ZWxlbS5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWVudGVyJywgb25NYXRjaEhvdmVyKTtcblx0XHRcdGVsZW0uYWRkRXZlbnRMaXN0ZW5lcignbW91c2VsZWF2ZScsIG9uTWF0Y2hIb3Zlcik7XG5cdFx0fSk7XG5cblx0XHRkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdzcGFuW2V4Y2x1ZGUtcGFydGlhbC1zY2FuXScpLmZvckVhY2goZWxlbSA9PiB7XG5cdFx0XHRlbGVtLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gbWVzc2FnZVBhcmVudCh7IHR5cGU6ICd1cGdyYWRlLXBsYW4nIH0pKTtcblx0XHR9KTtcblx0fVxuXG5cdGZ1bmN0aW9uIGhhbmRsZU1lc3NhZ2VGcm9tUGFyZW50KG5hdGl2ZUV2ZW50KSB7XG5cdFx0aWYgKG5hdGl2ZUV2ZW50LnNvdXJjZSAhPT0gKHdpbmRvdyBhcyBhbnkpLnBhcmVudCkge1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblx0XHRjb25zdCBldmVudCA9IG5hdGl2ZUV2ZW50LmRhdGEgYXMgUG9zdE1lc3NhZ2VFdmVudDtcblx0XHRzd2l0Y2ggKGV2ZW50LnR5cGUpIHtcblx0XHRcdGNhc2UgJ21hdGNoLXNlbGVjdCc6XG5cdFx0XHRcdGhhbmRsZUJyb2FkY2FzdE1hdGNoU2VsZWN0KGV2ZW50KTtcblx0XHRcdFx0YnJlYWs7XG5cdFx0XHRjYXNlICdtYXRjaC1qdW1wJzpcblx0XHRcdFx0aGFuZGxlTWF0Y2hKdW1wKGV2ZW50KTtcblx0XHRcdFx0YnJlYWs7XG5cdFx0XHRkZWZhdWx0OlxuXHRcdFx0XHRjb25zb2xlLmVycm9yKCd1bmtub3duIGV2ZW50IGluIHNvdXJjZSBmcmFtZScsIG5hdGl2ZUV2ZW50KTtcblx0XHR9XG5cdH1cblxuXHQvKipcblx0ICogSGFuZGxlIGEgbWF0Y2gtanVtcCBldmVudFxuXHQgKiBAcGFyYW0gZXZlbnQgdGhlIG1hdGNoLWp1bXAgZXZlbnQgb2JqZWN0XG5cdCAqL1xuXHRmdW5jdGlvbiBoYW5kbGVNYXRjaEp1bXAoZXZlbnQ6IE1hdGNoSnVtcEV2ZW50KSB7XG5cdFx0Ly8gY2FzZXM6XG5cdFx0Ly8gbm90aGluZyBpcyBtYXJrZWQgLSBmb3JjZSB0aGUgc3RhcnRcblxuXHRcdGlmICghY3VycmVudCkge1xuXHRcdFx0aGFuZGxlTWF0Y2hTZWxlY3QobWF0Y2hlc1swXSwgdHJ1ZSk7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0Ly8gc3RhcnQgaXMgbWFya2VkIGFuZCBiYWNrd2FyZCAgLSAgZG8gbm90aGluZ1xuXHRcdC8vIGVuZCBpcyBtYXJrZWQgYW5kIGZvcndhcmQgLSBkbyBub3RoaW5nXG5cdFx0Y29uc3Qgb2xkR2lkID0gY3VycmVudC5kYXRhc2V0LmdpZDtcblx0XHRjb25zdCBmaXJzdEdpZCA9IG1hdGNoZXNbMF0uZGF0YXNldC5naWQ7XG5cdFx0Y29uc3QgbGFzdEdpZCA9IG1hdGNoZXNbbWF0Y2hlcy5sZW5ndGggLSAxXS5kYXRhc2V0LmdpZDtcblx0XHRpZiAoKG9sZEdpZCA9PT0gZmlyc3RHaWQgJiYgIWV2ZW50LmZvcndhcmQpIHx8IChvbGRHaWQgPT09IGxhc3RHaWQgJiYgZXZlbnQuZm9yd2FyZCkpIHtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHQvLyBtaWRkbGUgaXMgbWFya2VkIC0ganVzdCBnbyBuZXh0L3ByZXZcblx0XHRsZXQgY3VycmVudEluZGV4ID0gbWF0Y2hlcy5pbmRleE9mKGN1cnJlbnQpO1xuXHRcdGNvbnN0IHN0ZXAgPSBldmVudC5mb3J3YXJkID8gMSA6IC0xO1xuXHRcdHdoaWxlICgwIDw9IGN1cnJlbnRJbmRleCAmJiBjdXJyZW50SW5kZXggPCBtYXRjaGVzLmxlbmd0aCkge1xuXHRcdFx0Y3VycmVudEluZGV4ICs9IHN0ZXA7XG5cdFx0XHRpZiAobWF0Y2hlc1tjdXJyZW50SW5kZXhdLmRhdGFzZXQuZ2lkICE9PSBvbGRHaWQpIHtcblx0XHRcdFx0YnJlYWs7XG5cdFx0XHR9XG5cdFx0fVxuXHRcdGNvbnN0IG5leHRHaWQgPSBtYXRjaGVzW2N1cnJlbnRJbmRleF0uZGF0YXNldC5naWQ7XG5cdFx0aGFuZGxlTWF0Y2hTZWxlY3QoZ3JvdXBzW25leHRHaWRdWzBdLCB0cnVlKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBFbWl0IGV2ZW50cyB0byBwYXJlbnQgdXNpbmcgcG9zdE1lc3NhZ2UgQVBJXG5cdCAqIEBwYXJhbSBldmVudCB0aGUgZXZlbnQgdG8gZW1pdFxuXHQgKi9cblx0ZnVuY3Rpb24gbWVzc2FnZVBhcmVudChldmVudDogUG9zdE1lc3NhZ2VFdmVudCkge1xuXHRcdCh3aW5kb3cgYXMgYW55KS5wYXJlbnQucG9zdE1lc3NhZ2UoZXZlbnQsICcqJyk7XG5cdH1cblxuXHQvKipcblx0ICogSGFuZGxlIGEgY2xpY2sgb24gYSBtYXRjaCBlbGVtZW50XG5cdCAqIEBwYXJhbSBldmVudCB0aGUgZGVmYXVsdCBtb3VzZSBldmVudFxuXHQgKi9cblx0ZnVuY3Rpb24gb25NYXRjaENsaWNrKGV2ZW50OiBNb3VzZUV2ZW50KSB7XG5cdFx0Y29uc3QgZWxlbSA9IGV2ZW50LnRhcmdldCBhcyBIVE1MU3BhbkVsZW1lbnQ7XG5cdFx0aGFuZGxlTWF0Y2hTZWxlY3QoZWxlbSwgdHJ1ZSk7XG5cdH1cblxuXHQvKipcblx0ICogaGFuZGxlIGEgYnJvYWRjYXN0ZWQgYG1hdGNoLXNlbGVjdGAgZXZlbnRcblx0ICogQHBhcmFtIGV2ZW50IHRoZSBtYXRjaCBzZWxlY3QgZXZlbnRcblx0ICovXG5cdGZ1bmN0aW9uIGhhbmRsZUJyb2FkY2FzdE1hdGNoU2VsZWN0KGV2ZW50OiBNYXRjaFNlbGVjdEV2ZW50KSB7XG5cdFx0Y29uc3QgZWxlbSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3I8SFRNTFNwYW5FbGVtZW50Pihgc3BhblttYXRjaF1bZGF0YS1pbmRleD0nJHtldmVudC5pbmRleH0nXWApO1xuXHRcdGlmICghZWxlbSAmJiBldmVudC5pbmRleCAhPT0gLTEpIHtcblx0XHRcdG1lc3NhZ2VQYXJlbnQoeyB0eXBlOiAnbWF0Y2gtd2FybicgfSk7XG5cdFx0fVxuXHRcdGhhbmRsZU1hdGNoU2VsZWN0KGVsZW0gfHwgY3VycmVudCwgZmFsc2UpOyAvLyBzaG91bGQgbm90IHJlYnJvYWRjYXN0XG5cdH1cblxuXHQvKipcblx0ICogSGFuZGxlcyBtYXRjaCBzZWxlY3Rpb24gdGhhdCB3YXMgcmVxdWVzdGVkIHByb2dyYW1tYXRpY2FsbHkgb3IgYnkgdXNlciBjbGlja1xuXHQgKiBAcGFyYW0gZWxlbSB0aGUgZWxlbWVudCB0aGF0IHdhcyBzZWxlY3RlZFxuXHQgKiBAcGFyYW0gYnJvYWRjYXN0IGEgZmxhZyBpbmRpY2F0aW5nIHdldGhlciB0byBtZXNzYWdlIHRoZSBzdXNwZWN0IGZyYW1lIGFib3V0IHRoaXMgZWxlbWVudCBiZWluZyBzZWxlY3RlZFxuXHQgKi9cblx0ZnVuY3Rpb24gaGFuZGxlTWF0Y2hTZWxlY3QoZWxlbTogSFRNTFNwYW5FbGVtZW50LCBicm9hZGNhc3Q6IGJvb2xlYW4gPSBmYWxzZSk6IHZvaWQge1xuXHRcdGlmIChjdXJyZW50ICYmIGN1cnJlbnQuZGF0YXNldC5naWQgPT09IGVsZW0uZGF0YXNldC5naWQpIHtcblx0XHRcdGdyb3Vwc1tjdXJyZW50LmRhdGFzZXQuZ2lkXS5mb3JFYWNoKGVsID0+IGVsLnRvZ2dsZUF0dHJpYnV0ZSgnb24nLCBmYWxzZSkpO1xuXHRcdFx0Y3VycmVudCA9IG51bGw7XG5cdFx0XHRpZiAoYnJvYWRjYXN0KSB7XG5cdFx0XHRcdG1lc3NhZ2VQYXJlbnQoeyB0eXBlOiAnbWF0Y2gtc2VsZWN0JywgaW5kZXg6IC0xIH0pO1xuXHRcdFx0fVxuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblx0XHRpZiAoY3VycmVudCkge1xuXHRcdFx0Z3JvdXBzW2N1cnJlbnQuZGF0YXNldC5naWRdLmZvckVhY2goZWwgPT4gZWwudG9nZ2xlQXR0cmlidXRlKCdvbicsIGZhbHNlKSk7XG5cdFx0fVxuXHRcdGlmIChlbGVtKSB7XG5cdFx0XHRncm91cHNbZWxlbS5kYXRhc2V0LmdpZF0uZm9yRWFjaChlbCA9PiBlbC50b2dnbGVBdHRyaWJ1dGUoJ29uJywgdHJ1ZSkpO1xuXHRcdFx0aWYgKGlzUGRmKSB7XG5cdFx0XHRcdGVsZW0uY2xvc2VzdCgnLnBjJykuY2xhc3NMaXN0LmFkZCgnb3BlbmVkJyk7XG5cdFx0XHR9XG5cdFx0XHRlbGVtLnNjcm9sbEludG9WaWV3KCk7XG5cdFx0fVxuXHRcdGN1cnJlbnQgPSBlbGVtO1xuXHRcdGlmIChicm9hZGNhc3QpIHtcblx0XHRcdG1lc3NhZ2VQYXJlbnQoeyB0eXBlOiAnbWF0Y2gtc2VsZWN0JywgaW5kZXg6ICtjdXJyZW50LmRhdGFzZXQuaW5kZXggfSk7XG5cdFx0fVxuXHR9XG5cblx0LyoqXG5cdCAqIEhhbmRsZSBtYXRjaCBob3ZlciBldmVudFxuXHQgKiBAcGFyYW0gZXZlbnQgdGhlIGRlZmF1bHQgbW91c2UgZXZlbnRcblx0ICovXG5cdGZ1bmN0aW9uIG9uTWF0Y2hIb3ZlcihldmVudDogTW91c2VFdmVudCkge1xuXHRcdGNvbnN0IGVsZW0gPSBldmVudD8udGFyZ2V0IGFzIEhUTUxTcGFuRWxlbWVudDtcblx0XHRncm91cHNbZWxlbT8uZGF0YXNldD8uZ2lkXT8uZm9yRWFjaChlbCA9PiBlbD8uY2xhc3NMaXN0Py50b2dnbGUoJ2hvdmVyJykpO1xuXHR9XG59XG5cbmV4cG9ydCBkZWZhdWx0IGAoJHtvbkRvY3VtZW50UmVhZHkudG9TdHJpbmcoKX0pKCR7cmVhZHkudG9TdHJpbmcoKX0pYDtcbiJdfQ==