import { ContentChildren, Directive, Input } from '@angular/core';
import { filter, take, withLatestFrom } from 'rxjs/operators';
import { untilDestroy } from '../../../shared/operators/untilDestroy';
import * as helpers from '../../utils/highlight-helpers';
import { MatchComponent } from '../match/match.component';
import * as i0 from "@angular/core";
import * as i1 from "../../services/highlight.service";
import * as i2 from "../../services/report.service";
export class SourceTextHelperDirective {
    constructor(highlightService, reportService) {
        this.highlightService = highlightService;
        this.reportService = reportService;
    }
    /**
     * Life-cycle method
     * - subscribe to text match clicks from suspect
     * - subscribe to jump events
     * - subscribe to the source text selected match
     */
    ngAfterContentInit() {
        const { contentMode$, viewMode$, source$, suspectResult$: suspect$ } = this.reportService;
        const { textMatchClick$, jump$, sourceText$, suspectHtml$ } = this.highlightService;
        sourceText$.pipe(untilDestroy(this)).subscribe(value => (this.current = value));
        textMatchClick$
            .pipe(untilDestroy(this), filter(ev => ev.origin === 'suspect' && ev.broadcast), withLatestFrom(source$, suspect$, contentMode$), filter(([, , , content]) => content === 'text'))
            .subscribe(([{ elem }, source, suspect]) => {
            if (elem) {
                this.handleBroadcast(elem.match, source, suspect.result, 'text');
            }
        });
        jump$
            .pipe(untilDestroy(this), withLatestFrom(viewMode$, contentMode$), filter(([, view, content]) => view === 'one-to-one' && content === 'text'))
            .subscribe(([forward]) => this.handleJump(forward));
        suspectHtml$
            .pipe(withLatestFrom(source$, suspect$, contentMode$), filter(([, , , content]) => content === 'html'), filter(([, source]) => !source.html || !source.html.value))
            .subscribe(([match, source, suspect]) => this.handleBroadcast(match, source, suspect.result, 'html'));
    }
    /**
     * Handle a match click that was broadcasted by the suspect text helper
     * @param elem the broadcasted element
     * @param suspect the suspected scan result
     */
    handleBroadcast(match, source, suspect, contentMode) {
        const [, start] = helpers.findRespectiveMatch(match, suspect[contentMode].comparison, false);
        const page = helpers.findRespectivePage(start, source.text.pages.startPosition);
        if (page === this.host.currentPage) {
            const comp = this.children.find(item => item.match.start === start);
            if (comp === null) {
                throw new Error('Match component was not found in view');
            }
            this.highlightService.textMatchClicked({ elem: comp, broadcast: false, origin: 'source' });
        }
        else {
            this.children.changes.pipe(take(1)).subscribe(() => {
                const comp = this.children.find(item => item.match.start === start);
                if (comp === null) {
                    throw new Error('Match component was not found in view');
                }
                this.highlightService.textMatchClicked({ elem: comp, broadcast: false, origin: 'source' });
            });
            this.host.currentPage = page;
        }
    }
    /**
     * Handles the jump logic
     * @param forward the direction of the jump
     */
    handleJump(forward) {
        if (this.canJumpInCurrentPage(forward)) {
            const components = this.children.toArray();
            const nextIndex = this.current ? components.indexOf(this.current) + (forward ? 1 : -1) : 0;
            this.highlightService.textMatchClicked({ elem: components[nextIndex], broadcast: true, origin: 'source' });
        }
        else {
            const page = forward
                ? helpers.findNextPageWithMatch(this.host.textMatches, this.host.currentPage)
                : helpers.findPrevPageWithMatch(this.host.textMatches, this.host.currentPage);
            if (this.host.currentPage !== page) {
                this.highlightService.textMatchClicked({ elem: this.current, broadcast: true, origin: 'source' });
                this.children.changes.pipe(take(1)).subscribe(() => {
                    const comp = forward ? this.children.first : this.children.last;
                    this.highlightService.textMatchClicked({ elem: comp, broadcast: true, origin: 'source' });
                });
                this.host.currentPage = page;
            }
        }
    }
    /**
     * Checks whether it is possible to jump forward/backward in the current page
     * @param forward the direction of the jump
     */
    canJumpInCurrentPage(forward) {
        if (this.current) {
            return forward ? this.current !== this.children.last : this.current !== this.children.first;
        }
        else {
            return this.children.length > 0;
        }
    }
    /**
     * Life-cycle method
     * empty for `untilDestroy` rxjs operator
     */
    ngOnDestroy() { }
}
SourceTextHelperDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.3.3", ngImport: i0, type: SourceTextHelperDirective, deps: [{ token: i1.HighlightService }, { token: i2.ReportService }], target: i0.ɵɵFactoryTarget.Directive });
SourceTextHelperDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "13.3.3", type: SourceTextHelperDirective, selector: "[crSourceTextHelper]", inputs: { host: "host" }, queries: [{ propertyName: "children", predicate: MatchComponent }], ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.3.3", ngImport: i0, type: SourceTextHelperDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: '[crSourceTextHelper]',
                }]
        }], ctorParameters: function () { return [{ type: i1.HighlightService }, { type: i2.ReportService }]; }, propDecorators: { host: [{
                type: Input
            }], children: [{
                type: ContentChildren,
                args: [MatchComponent]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic291cmNlLXRleHQtaGVscGVyLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3BsYWdpYXJpc20tcmVwb3J0L3NyYy9saWIvcGxhZ2lhcmlzbS1yZXBvcnQvY29tcG9uZW50cy90ZXh0LWhlbHBlcnMvc291cmNlLXRleHQtaGVscGVyLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQW9CLGVBQWUsRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUF3QixNQUFNLGVBQWUsQ0FBQztBQUMxRyxPQUFPLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxjQUFjLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM5RCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sd0NBQXdDLENBQUM7QUFJdEUsT0FBTyxLQUFLLE9BQU8sTUFBTSwrQkFBK0IsQ0FBQztBQUN6RCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sMEJBQTBCLENBQUM7Ozs7QUFJMUQsTUFBTSxPQUFPLHlCQUF5QjtJQUVyQyxZQUFvQixnQkFBa0MsRUFBVSxhQUE0QjtRQUF4RSxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQVUsa0JBQWEsR0FBYixhQUFhLENBQWU7SUFBRyxDQUFDO0lBTWhHOzs7OztPQUtHO0lBQ0gsa0JBQWtCO1FBQ2pCLE1BQU0sRUFBRSxZQUFZLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxjQUFjLEVBQUUsUUFBUSxFQUFFLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQztRQUMxRixNQUFNLEVBQUUsZUFBZSxFQUFFLEtBQUssRUFBRSxXQUFXLEVBQUUsWUFBWSxFQUFFLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDO1FBQ3BGLFdBQVcsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FB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QkFDM0YsQ0FBQyxDQUFDLENBQUM7Z0JBQ0gsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO2FBQzdCO1NBQ0Q7SUFDRixDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsb0JBQW9CLENBQUMsT0FBZ0I7UUFDcEMsSUFBSSxJQUFJLENBQUMsT0FBTyxFQUFFO1lBQ2pCLE9BQU8sT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxLQUFLLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxLQUFLLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDO1NBQzVGO2FBQU07WUFDTixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztTQUNoQztJQUNGLENBQUM7SUFFRDs7O09BR0c7SUFDSCxXQUFXLEtBQUksQ0FBQzs7c0hBaEhKLHlCQUF5QjswR0FBekIseUJBQXlCLCtHQUlwQixjQUFjOzJGQUpuQix5QkFBeUI7a0JBSHJDLFNBQVM7bUJBQUM7b0JBQ1YsUUFBUSxFQUFFLHNCQUFzQjtpQkFDaEM7bUlBRWdCLElBQUk7c0JBQW5CLEtBQUs7Z0JBSUUsUUFBUTtzQkFEZixlQUFlO3VCQUFDLGNBQWMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBZnRlckNvbnRlbnRJbml0LCBDb250ZW50Q2hpbGRyZW4sIERpcmVjdGl2ZSwgSW5wdXQsIE9uRGVzdHJveSwgUXVlcnlMaXN0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBmaWx0ZXIsIHRha2UsIHdpdGhMYXRlc3RGcm9tIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgdW50aWxEZXN0cm95IH0gZnJvbSAnLi4vLi4vLi4vc2hhcmVkL29wZXJhdG9ycy91bnRpbERlc3Ryb3knO1xuaW1wb3J0IHsgQ29udGVudE1vZGUsIE1hdGNoLCBTY2FuUmVzdWx0LCBTY2FuU291cmNlIH0gZnJvbSAnLi4vLi4vbW9kZWxzJztcbmltcG9ydCB7IEhpZ2hsaWdodFNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9oaWdobGlnaHQuc2VydmljZSc7XG5pbXBvcnQgeyBSZXBvcnRTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvcmVwb3J0LnNlcnZpY2UnO1xuaW1wb3J0ICogYXMgaGVscGVycyBmcm9tICcuLi8uLi91dGlscy9oaWdobGlnaHQtaGVscGVycyc7XG5pbXBvcnQgeyBNYXRjaENvbXBvbmVudCB9IGZyb20gJy4uL21hdGNoL21hdGNoLmNvbXBvbmVudCc7XG5ARGlyZWN0aXZlKHtcblx0c2VsZWN0b3I6ICdbY3JTb3VyY2VUZXh0SGVscGVyXScsXG59KVxuZXhwb3J0IGNsYXNzIFNvdXJjZVRleHRIZWxwZXJEaXJlY3RpdmUgaW1wbGVtZW50cyBBZnRlckNvbnRlbnRJbml0LCBPbkRlc3Ryb3kge1xuXHRASW5wdXQoKSBwdWJsaWMgaG9zdDogeyBjdXJyZW50UGFnZTogbnVtYmVyOyB0ZXh0TWF0Y2hlczogYW55IH07XG5cdGNvbnN0cnVjdG9yKHByaXZhdGUgaGlnaGxpZ2h0U2VydmljZTogSGlnaGxpZ2h0U2VydmljZSwgcHJpdmF0ZSByZXBvcnRTZXJ2aWNlOiBSZXBvcnRTZXJ2aWNlKSB7fVxuXG5cdEBDb250ZW50Q2hpbGRyZW4oTWF0Y2hDb21wb25lbnQpXG5cdHByaXZhdGUgY2hpbGRyZW46IFF1ZXJ5TGlzdDxNYXRjaENvbXBvbmVudD47XG5cdHByaXZhdGUgY3VycmVudDogTWF0Y2hDb21wb25lbnQ7XG5cblx0LyoqXG5cdCAqIExpZmUtY3ljbGUgbWV0aG9kXG5cdCAqIC0gc3Vic2NyaWJlIHRvIHRleHQgbWF0Y2ggY2xpY2tzIGZyb20gc3VzcGVjdFxuXHQgKiAtIHN1YnNjcmliZSB0byBqdW1wIGV2ZW50c1xuXHQgKiAtIHN1YnNjcmliZSB0byB0aGUgc291cmNlIHRleHQgc2VsZWN0ZWQgbWF0Y2hcblx0ICovXG5cdG5nQWZ0ZXJDb250ZW50SW5pdCgpIHtcblx0XHRjb25zdCB7IGNvbnRlbnRNb2RlJCwgdmlld01vZGUkLCBzb3VyY2UkLCBzdXNwZWN0UmVzdWx0JDogc3VzcGVjdCQgfSA9IHRoaXMucmVwb3J0U2VydmljZTtcblx0XHRjb25zdCB7IHRleHRNYXRjaENsaWNrJCwganVtcCQsIHNvdXJjZVRleHQkLCBzdXNwZWN0SHRtbCQgfSA9IHRoaXMuaGlnaGxpZ2h0U2VydmljZTtcblx0XHRzb3VyY2VUZXh0JC5waXBlKHVudGlsRGVzdHJveSh0aGlzKSkuc3Vic2NyaWJlKHZhbHVlID0+ICh0aGlzLmN1cnJlbnQgPSB2YWx1ZSkpO1xuXHRcdHRleHRNYXRjaENsaWNrJFxuXHRcdFx0LnBpcGUoXG5cdFx0XHRcdHVudGlsRGVzdHJveSh0aGlzKSxcblx0XHRcdFx0ZmlsdGVyKGV2ID0+IGV2Lm9yaWdpbiA9PT0gJ3N1c3BlY3QnICYmIGV2LmJyb2FkY2FzdCksXG5cdFx0XHRcdHdpdGhMYXRlc3RGcm9tKHNvdXJjZSQsIHN1c3BlY3QkLCBjb250ZW50TW9kZSQpLFxuXHRcdFx0XHRmaWx0ZXIoKFssICwgLCBjb250ZW50XSkgPT4gY29udGVudCA9PT0gJ3RleHQnKVxuXHRcdFx0KVxuXHRcdFx0LnN1YnNjcmliZSgoW3sgZWxlbSB9LCBzb3VyY2UsIHN1c3BlY3RdKSA9PiB7XG5cdFx0XHRcdGlmIChlbGVtKSB7XG5cdFx0XHRcdFx0dGhpcy5oYW5kbGVCcm9hZGNhc3QoZWxlbS5tYXRjaCwgc291cmNlLCBzdXNwZWN0LnJlc3VsdCwgJ3RleHQnKTtcblx0XHRcdFx0fVxuXHRcdFx0fSk7XG5cblx0XHRqdW1wJFxuXHRcdFx0LnBpcGUoXG5cdFx0XHRcdHVudGlsRGVzdHJveSh0aGlzKSxcblx0XHRcdFx0d2l0aExhdGVzdEZyb20odmlld01vZGUkLCBjb250ZW50TW9kZSQpLFxuXHRcdFx0XHRmaWx0ZXIoKFssIHZpZXcsIGNvbnRlbnRdKSA9PiB2aWV3ID09PSAnb25lLXRvLW9uZScgJiYgY29udGVudCA9PT0gJ3RleHQnKVxuXHRcdFx0KVxuXHRcdFx0LnN1YnNjcmliZSgoW2ZvcndhcmRdKSA9PiB0aGlzLmhhbmRsZUp1bXAoZm9yd2FyZCkpO1xuXG5cdFx0c3VzcGVjdEh0bWwkXG5cdFx0XHQucGlwZShcblx0XHRcdFx0d2l0aExhdGVzdEZyb20oc291cmNlJCwgc3VzcGVjdCQsIGNvbnRlbnRNb2RlJCksXG5cdFx0XHRcdGZpbHRlcigoWywgLCAsIGNvbnRlbnRdKSA9PiBjb250ZW50ID09PSAnaHRtbCcpLFxuXHRcdFx0XHRmaWx0ZXIoKFssIHNvdXJjZV0pID0+ICFzb3VyY2UuaHRtbCB8fCAhc291cmNlLmh0bWwudmFsdWUpXG5cdFx0XHQpXG5cdFx0XHQuc3Vic2NyaWJlKChbbWF0Y2gsIHNvdXJjZSwgc3VzcGVjdF0pID0+IHRoaXMuaGFuZGxlQnJvYWRjYXN0KG1hdGNoLCBzb3VyY2UsIHN1c3BlY3QucmVzdWx0LCAnaHRtbCcpKTtcblx0fVxuXHQvKipcblx0ICogSGFuZGxlIGEgbWF0Y2ggY2xpY2sgdGhhdCB3YXMgYnJvYWRjYXN0ZWQgYnkgdGhlIHN1c3BlY3QgdGV4dCBoZWxwZXJcblx0ICogQHBhcmFtIGVsZW0gdGhlIGJyb2FkY2FzdGVkIGVsZW1lbnRcblx0ICogQHBhcmFtIHN1c3BlY3QgdGhlIHN1c3BlY3RlZCBzY2FuIHJlc3VsdFxuXHQgKi9cblx0aGFuZGxlQnJvYWRjYXN0KG1hdGNoOiBNYXRjaCwgc291cmNlOiBTY2FuU291cmNlLCBzdXNwZWN0OiBTY2FuUmVzdWx0LCBjb250ZW50TW9kZTogQ29udGVudE1vZGUpIHtcblx0XHRjb25zdCBbLCBzdGFydF0gPSBoZWxwZXJzLmZpbmRSZXNwZWN0aXZlTWF0Y2gobWF0Y2gsIHN1c3BlY3RbY29udGVudE1vZGVdLmNvbXBhcmlzb24sIGZhbHNlKTtcblx0XHRjb25zdCBwYWdlID0gaGVscGVycy5maW5kUmVzcGVjdGl2ZVBhZ2Uoc3RhcnQsIHNvdXJjZS50ZXh0LnBhZ2VzLnN0YXJ0UG9zaXRpb24pO1xuXHRcdGlmIChwYWdlID09PSB0aGlzLmhvc3QuY3VycmVudFBhZ2UpIHtcblx0XHRcdGNvbnN0IGNvbXAgPSB0aGlzLmNoaWxkcmVuLmZpbmQoaXRlbSA9PiBpdGVtLm1hdGNoLnN0YXJ0ID09PSBzdGFydCk7XG5cdFx0XHRpZiAoY29tcCA9PT0gbnVsbCkge1xuXHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ01hdGNoIGNvbXBvbmVudCB3YXMgbm90IGZvdW5kIGluIHZpZXcnKTtcblx0XHRcdH1cblx0XHRcdHRoaXMuaGlnaGxpZ2h0U2VydmljZS50ZXh0TWF0Y2hDbGlja2VkKHsgZWxlbTogY29tcCwgYnJvYWRjYXN0OiBmYWxzZSwgb3JpZ2luOiAnc291cmNlJyB9KTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhpcy5jaGlsZHJlbi5jaGFuZ2VzLnBpcGUodGFrZSgxKSkuc3Vic2NyaWJlKCgpID0+IHtcblx0XHRcdFx0Y29uc3QgY29tcCA9IHRoaXMuY2hpbGRyZW4uZmluZChpdGVtID0+IGl0ZW0ubWF0Y2guc3RhcnQgPT09IHN0YXJ0KTtcblx0XHRcdFx0aWYgKGNvbXAgPT09IG51bGwpIHtcblx0XHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ01hdGNoIGNvbXBvbmVudCB3YXMgbm90IGZvdW5kIGluIHZpZXcnKTtcblx0XHRcdFx0fVxuXHRcdFx0XHR0aGlzLmhpZ2hsaWdodFNlcnZpY2UudGV4dE1hdGNoQ2xpY2tlZCh7IGVsZW06IGNvbXAsIGJyb2FkY2FzdDogZmFsc2UsIG9yaWdpbjogJ3NvdXJjZScgfSk7XG5cdFx0XHR9KTtcblx0XHRcdHRoaXMuaG9zdC5jdXJyZW50UGFnZSA9IHBhZ2U7XG5cdFx0fVxuXHR9XG5cdC8qKlxuXHQgKiBIYW5kbGVzIHRoZSBqdW1wIGxvZ2ljXG5cdCAqIEBwYXJhbSBmb3J3YXJkIHRoZSBkaXJlY3Rpb24gb2YgdGhlIGp1bXBcblx0ICovXG5cdGhhbmRsZUp1bXAoZm9yd2FyZDogYm9vbGVhbikge1xuXHRcdGlmICh0aGlzLmNhbkp1bXBJbkN1cnJlbnRQYWdlKGZvcndhcmQpKSB7XG5cdFx0XHRjb25zdCBjb21wb25lbnRzID0gdGhpcy5jaGlsZHJlbi50b0FycmF5KCk7XG5cdFx0XHRjb25zdCBuZXh0SW5kZXggPSB0aGlzLmN1cnJlbnQgPyBjb21wb25lbnRzLmluZGV4T2YodGhpcy5jdXJyZW50KSArIChmb3J3YXJkID8gMSA6IC0xKSA6IDA7XG5cdFx0XHR0aGlzLmhpZ2hsaWdodFNlcnZpY2UudGV4dE1hdGNoQ2xpY2tlZCh7IGVsZW06IGNvbXBvbmVudHNbbmV4dEluZGV4XSwgYnJvYWRjYXN0OiB0cnVlLCBvcmlnaW46ICdzb3VyY2UnIH0pO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRjb25zdCBwYWdlID0gZm9yd2FyZFxuXHRcdFx0XHQ/IGhlbHBlcnMuZmluZE5leHRQYWdlV2l0aE1hdGNoKHRoaXMuaG9zdC50ZXh0TWF0Y2hlcywgdGhpcy5ob3N0LmN1cnJlbnRQYWdlKVxuXHRcdFx0XHQ6IGhlbHBlcnMuZmluZFByZXZQYWdlV2l0aE1hdGNoKHRoaXMuaG9zdC50ZXh0TWF0Y2hlcywgdGhpcy5ob3N0LmN1cnJlbnRQYWdlKTtcblx0XHRcdGlmICh0aGlzLmhvc3QuY3VycmVudFBhZ2UgIT09IHBhZ2UpIHtcblx0XHRcdFx0dGhpcy5oaWdobGlnaHRTZXJ2aWNlLnRleHRNYXRjaENsaWNrZWQoeyBlbGVtOiB0aGlzLmN1cnJlbnQsIGJyb2FkY2FzdDogdHJ1ZSwgb3JpZ2luOiAnc291cmNlJyB9KTtcblx0XHRcdFx0dGhpcy5jaGlsZHJlbi5jaGFuZ2VzLnBpcGUodGFrZSgxKSkuc3Vic2NyaWJlKCgpID0+IHtcblx0XHRcdFx0XHRjb25zdCBjb21wID0gZm9yd2FyZCA/IHRoaXMuY2hpbGRyZW4uZmlyc3QgOiB0aGlzLmNoaWxkcmVuLmxhc3Q7XG5cdFx0XHRcdFx0dGhpcy5oaWdobGlnaHRTZXJ2aWNlLnRleHRNYXRjaENsaWNrZWQoeyBlbGVtOiBjb21wLCBicm9hZGNhc3Q6IHRydWUsIG9yaWdpbjogJ3NvdXJjZScgfSk7XG5cdFx0XHRcdH0pO1xuXHRcdFx0XHR0aGlzLmhvc3QuY3VycmVudFBhZ2UgPSBwYWdlO1xuXHRcdFx0fVxuXHRcdH1cblx0fVxuXG5cdC8qKlxuXHQgKiBDaGVja3Mgd2hldGhlciBpdCBpcyBwb3NzaWJsZSB0byBqdW1wIGZvcndhcmQvYmFja3dhcmQgaW4gdGhlIGN1cnJlbnQgcGFnZVxuXHQgKiBAcGFyYW0gZm9yd2FyZCB0aGUgZGlyZWN0aW9uIG9mIHRoZSBqdW1wXG5cdCAqL1xuXHRjYW5KdW1wSW5DdXJyZW50UGFnZShmb3J3YXJkOiBib29sZWFuKTogYm9vbGVhbiB7XG5cdFx0aWYgKHRoaXMuY3VycmVudCkge1xuXHRcdFx0cmV0dXJuIGZvcndhcmQgPyB0aGlzLmN1cnJlbnQgIT09IHRoaXMuY2hpbGRyZW4ubGFzdCA6IHRoaXMuY3VycmVudCAhPT0gdGhpcy5jaGlsZHJlbi5maXJzdDtcblx0XHR9IGVsc2Uge1xuXHRcdFx0cmV0dXJuIHRoaXMuY2hpbGRyZW4ubGVuZ3RoID4gMDtcblx0XHR9XG5cdH1cblxuXHQvKipcblx0ICogTGlmZS1jeWNsZSBtZXRob2Rcblx0ICogZW1wdHkgZm9yIGB1bnRpbERlc3Ryb3lgIHJ4anMgb3BlcmF0b3Jcblx0ICovXG5cdG5nT25EZXN0cm95KCkge31cbn1cbiJdfQ==