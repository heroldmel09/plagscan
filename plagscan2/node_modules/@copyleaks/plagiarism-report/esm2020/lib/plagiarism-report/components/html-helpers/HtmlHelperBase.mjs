import { HostBinding, HostListener, Directive } from '@angular/core';
import { ExcludeReason, MatchType } from '../../models';
import { EXCLUDE_MESSAGE } from '../../utils/constants';
import iframeStyle from './iframe-styles';
import * as i0 from "@angular/core";
import * as i1 from "../../services/report.service";
import * as i2 from "../../services/copyleaks-translate.service";
// tslint:disable-next-line: directive-class-suffix
export class HtmlHelperBase {
    constructor(renderer, element, reportService, translateService) {
        this.renderer = renderer;
        this.element = element;
        this.reportService = reportService;
        this.translateService = translateService;
        this.EXCLUDE_MESSAGE = EXCLUDE_MESSAGE;
        /** sets the seamsless attribute to the iframe */
        this.seamless = true;
        const css = renderer.createElement('style');
        css.textContent = iframeStyle;
        this.style = css.outerHTML;
        if (this.translateService) {
            const translations = this.translateService.translations;
            if (translations && translations.SCAN_SETTINGS && translations.SCAN_SETTINGS.OMITTED) {
                this.EXCLUDE_MESSAGE = {
                    1: translations.SCAN_SETTINGS.OMITTED.QUOTATIONS,
                    2: translations.SCAN_SETTINGS.OMITTED.REFERENCES,
                    5: translations.SCAN_SETTINGS.OMITTED.HTML_TEMPLATES,
                    6: translations.SCAN_SETTINGS.OMITTED.TABLES_OF_CONTENT,
                    7: translations.SCAN_SETTINGS.OMITTED.SOURCE_CODE_COMMENTS,
                    0: translations.SCAN_SETTINGS.OMITTED.SENSITIVE_DATA,
                    8: translations.SCAN_SETTINGS.OMITTED.PARTIAL_SCAN,
                    9: translations.SCAN_SETTINGS.OMITTED.CITATIONS,
                };
            }
        }
    }
    /**
     * Handles PostMessage events, making sure its from the correct iframe.
     * @param event the default PostMessage event
     */
    onFrameMessage(event) {
        const { source, data } = event;
        if (source !== this.frame) {
            return;
        }
        const pmevent = data;
        switch (pmevent.type) {
            case 'match-select':
                this.handleMatchSelect(pmevent);
                break;
            case 'upgrade-plan':
                this.handleUpgradePlanEvent();
                break;
            case 'match-warn':
                console.warn('match not found');
                break;
            default:
                console.error('unknown event', pmevent);
        }
    }
    /**
     * Handles the 'upgrade-plan' event
     */
    handleUpgradePlanEvent() {
        this.reportService.upgradePlanEvent();
    }
    get frame() {
        return this.element.nativeElement.contentWindow;
    }
    /**
     * Send a message to the iframe using PostMessage API
     * @param data the data to post
     */
    messageFrame(data) {
        this.frame && this.frame.postMessage(data, '*');
    }
    /**
     * Set the iframe srcdoc html to the given html string
     * @param html the html string
     */
    setHtml(html) {
        this.renderer.setAttribute(this.element.nativeElement, 'srcdoc', html + this.style + this.script);
    }
    /**
     * highlight a single match in the iframe
     * @param index the index of the match to mark
     */
    markSingleMatchInFrame(index) {
        this.messageFrame({ type: 'match-select', index });
    }
    /**
     * Render list of matches in the iframe's HTML
     * @param matches the matches to render
     */
    renderMatches(matches) {
        this.matches = matches;
        const html = matches.reduceRight((prev, curr, i) => {
            let slice = this.html?.substring(curr.start, curr.end);
            switch (curr.type) {
                case MatchType.excluded:
                    if (curr.reason === ExcludeReason.PartialScan) {
                        slice = `<span exclude-partial-scan data-type="${curr.type}" data-index="${i}" title="${this.EXCLUDE_MESSAGE[curr.reason]}">${slice}</span>`;
                    }
                    else {
                        slice = `<span exclude title="${this.EXCLUDE_MESSAGE[curr.reason]}">${slice}</span>`;
                    }
                    break;
                case MatchType.none:
                    break;
                default:
                    slice = `<span match data-type="${curr.type}" data-index="${i}" data-gid="${curr.gid}">${slice}</span>`;
                    break;
            }
            return slice ? slice?.concat(prev) : '';
        }, '');
        this.renderer.setAttribute(this.element.nativeElement, 'srcdoc', html + this.style + this.script);
    }
}
HtmlHelperBase.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.3.3", ngImport: i0, type: HtmlHelperBase, deps: [{ token: i0.Renderer2 }, { token: i0.ElementRef }, { token: i1.ReportService }, { token: i2.CopyleaksTranslateService }], target: i0.ɵɵFactoryTarget.Directive });
HtmlHelperBase.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "13.3.3", type: HtmlHelperBase, host: { listeners: { "window:message": "onFrameMessage($event)" }, properties: { "attr.seamless": "this.seamless" } }, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.3.3", ngImport: i0, type: HtmlHelperBase, decorators: [{
            type: Directive
        }], ctorParameters: function () { return [{ type: i0.Renderer2 }, { type: i0.ElementRef }, { type: i1.ReportService }, { type: i2.CopyleaksTranslateService }]; }, propDecorators: { seamless: [{
                type: HostBinding,
                args: ['attr.seamless']
            }], onFrameMessage: [{
                type: HostListener,
                args: ['window:message', ['$event']]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSHRtbEhlbHBlckJhc2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9wbGFnaWFyaXNtLXJlcG9ydC9zcmMvbGliL3BsYWdpYXJpc20tcmVwb3J0L2NvbXBvbmVudHMvaHRtbC1oZWxwZXJzL0h0bWxIZWxwZXJCYXNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBYyxXQUFXLEVBQUUsWUFBWSxFQUFhLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM1RixPQUFPLEVBQUUsYUFBYSxFQUEyQixTQUFTLEVBQW9CLE1BQU0sY0FBYyxDQUFDO0FBQ25HLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUN4RCxPQUFPLFdBQVcsTUFBTSxpQkFBaUIsQ0FBQzs7OztBQUsxQyxtREFBbUQ7QUFDbkQsTUFBTSxPQUFnQixjQUFjO0lBYW5DLFlBQ1csUUFBbUIsRUFDbkIsT0FBc0MsRUFDdEMsYUFBNEIsRUFDNUIsZ0JBQTJDO1FBSDNDLGFBQVEsR0FBUixRQUFRLENBQVc7UUFDbkIsWUFBTyxHQUFQLE9BQU8sQ0FBK0I7UUFDdEMsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFDNUIscUJBQWdCLEdBQWhCLGdCQUFnQixDQUEyQjtRQWhCOUMsb0JBQWUsR0FBRyxlQUFlLENBQUM7UUFTMUMsaURBQWlEO1FBQ1YsYUFBUSxHQUFHLElBQUksQ0FBQztRQVF0RCxNQUFNLEdBQUcsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBcUIsQ0FBQztRQUNoRSxHQUFHLENBQUMsV0FBVyxHQUFHLFdBQVcsQ0FBQztRQUM5QixJQUFJLENBQUMsS0FBSyxHQUFHLEdBQUcsQ0FBQyxTQUFTLENBQUM7UUFDM0IsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7WUFDMUIsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFlBQVksQ0FBQztZQUN4RCxJ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QkFBZ0IsRUFBRSxDQUFDLFFBQVEsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEVsZW1lbnRSZWYsIEhvc3RCaW5kaW5nLCBIb3N0TGlzdGVuZXIsIFJlbmRlcmVyMiwgRGlyZWN0aXZlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBFeGNsdWRlUmVhc29uLCBNYXRjaCwgTWF0Y2hTZWxlY3RFdmVudCwgTWF0Y2hUeXBlLCBQb3N0TWVzc2FnZUV2ZW50IH0gZnJvbSAnLi4vLi4vbW9kZWxzJztcbmltcG9ydCB7IEVYQ0xVREVfTUVTU0FHRSB9IGZyb20gJy4uLy4uL3V0aWxzL2NvbnN0YW50cyc7XG5pbXBvcnQgaWZyYW1lU3R5bGUgZnJvbSAnLi9pZnJhbWUtc3R5bGVzJztcbmltcG9ydCB7IENvcHlsZWFrc1RyYW5zbGF0ZVNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9jb3B5bGVha3MtdHJhbnNsYXRlLnNlcnZpY2UnO1xuaW1wb3J0IHsgUmVwb3J0U2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL3JlcG9ydC5zZXJ2aWNlJztcblxuQERpcmVjdGl2ZSgpXG4vLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IGRpcmVjdGl2ZS1jbGFzcy1zdWZmaXhcbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBIdG1sSGVscGVyQmFzZSB7XG5cdHByaXZhdGUgRVhDTFVERV9NRVNTQUdFID0gRVhDTFVERV9NRVNTQUdFO1xuXHQvKiogdGhlIG9yaWdpbmFsIGh0bWwgKi9cblx0cHJvdGVjdGVkIGh0bWw6IHN0cmluZztcblx0LyoqIHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGUgZXh0ZXJuYWwgY3NzIHRoYXQgd2lsbCBiZSBpbnNlcnRlZCB0byB0aGUgZnJhbWUgKi9cblx0cHJvdGVjdGVkIHN0eWxlOiBzdHJpbmc7XG5cdC8qKiBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIGV4dHJuYWwganMgdGhhdCB3aWxsIGJlIGluc2VydGVkIHRvIHRoZSBmcm1hZSAqL1xuXHRwcm90ZWN0ZWQgc2NyaXB0OiBzdHJpbmc7XG5cdC8qKiB0aGUgbWF0Y2hlcyB0byBwcm9jZXNzICovXG5cdHByb3RlY3RlZCBtYXRjaGVzOiBNYXRjaFtdO1xuXHQvKiogc2V0cyB0aGUgc2VhbXNsZXNzIGF0dHJpYnV0ZSB0byB0aGUgaWZyYW1lICovXG5cdEBIb3N0QmluZGluZygnYXR0ci5zZWFtbGVzcycpIHJlYWRvbmx5IHNlYW1sZXNzID0gdHJ1ZTtcblxuXHRjb25zdHJ1Y3Rvcihcblx0XHRwcm90ZWN0ZWQgcmVuZGVyZXI6IFJlbmRlcmVyMixcblx0XHRwcm90ZWN0ZWQgZWxlbWVudDogRWxlbWVudFJlZjxIVE1MSUZyYW1lRWxlbWVudD4sXG5cdFx0cHJvdGVjdGVkIHJlcG9ydFNlcnZpY2U6IFJlcG9ydFNlcnZpY2UsXG5cdFx0cHJvdGVjdGVkIHRyYW5zbGF0ZVNlcnZpY2U6IENvcHlsZWFrc1RyYW5zbGF0ZVNlcnZpY2Vcblx0KSB7XG5cdFx0Y29uc3QgY3NzID0gcmVuZGVyZXIuY3JlYXRlRWxlbWVudCgnc3R5bGUnKSBhcyBIVE1MU3R5bGVFbGVtZW50O1xuXHRcdGNzcy50ZXh0Q29udGVudCA9IGlmcmFtZVN0eWxlO1xuXHRcdHRoaXMuc3R5bGUgPSBjc3Mub3V0ZXJIVE1MO1xuXHRcdGlmICh0aGlzLnRyYW5zbGF0ZVNlcnZpY2UpIHtcblx0XHRcdGNvbnN0IHRyYW5zbGF0aW9ucyA9IHRoaXMudHJhbnNsYXRlU2VydmljZS50cmFuc2xhdGlvbnM7XG5cdFx0XHRpZiAodHJhbnNsYXRpb25zICYmIHRyYW5zbGF0aW9ucy5TQ0FOX1NFVFRJTkdTICYmIHRyYW5zbGF0aW9ucy5TQ0FOX1NFVFRJTkdTLk9NSVRURUQpIHtcblx0XHRcdFx0dGhpcy5FWENMVURFX01FU1NBR0UgPSB7XG5cdFx0XHRcdFx0MTogdHJhbnNsYXRpb25zLlNDQU5fU0VUVElOR1MuT01JVFRFRC5RVU9UQVRJT05TLFxuXHRcdFx0XHRcdDI6IHRyYW5zbGF0aW9ucy5TQ0FOX1NFVFRJTkdTLk9NSVRURUQuUkVGRVJFTkNFUyxcblx0XHRcdFx0XHQ1OiB0cmFuc2xhdGlvbnMuU0NBTl9TRVRUSU5HUy5PTUlUVEVELkhUTUxfVEVNUExBVEVTLFxuXHRcdFx0XHRcdDY6IHRyYW5zbGF0aW9ucy5TQ0FOX1NFVFRJTkdTLk9NSVRURUQuVEFCTEVTX09GX0NPTlRFTlQsXG5cdFx0XHRcdFx0NzogdHJhbnNsYXRpb25zLlNDQU5fU0VUVElOR1MuT01JVFRFRC5TT1VSQ0VfQ09ERV9DT01NRU5UUyxcblx0XHRcdFx0XHQwOiB0cmFuc2xhdGlvbnMuU0NBTl9TRVRUSU5HUy5PTUlUVEVELlNFTlNJVElWRV9EQVRBLFxuXHRcdFx0XHRcdDg6IHRyYW5zbGF0aW9ucy5TQ0FOX1NFVFRJTkdTLk9NSVRURUQuUEFSVElBTF9TQ0FOLFxuXHRcdFx0XHRcdDk6IHRyYW5zbGF0aW9ucy5TQ0FOX1NFVFRJTkdTLk9NSVRURUQuQ0lUQVRJT05TLFxuXHRcdFx0XHR9O1xuXHRcdFx0fVxuXHRcdH1cblx0fVxuXHQvKipcblx0ICogSGFuZGxlcyB0aGUgYG1hdGNoLXNlbGVjdGAgZXZlbnRcblx0ICogQHBhcmFtIGV2ZW50IHRoZSBldmVudCBvYmplY3QgY29udGFpbmluZyB0aGUgbWF0Y2ggYGluZGV4YFxuXHQgKi9cblx0YWJzdHJhY3QgaGFuZGxlTWF0Y2hTZWxlY3QoZXZlbnQ6IE1hdGNoU2VsZWN0RXZlbnQpOiB2b2lkO1xuXG5cdC8qKlxuXHQgKiBIYW5kbGVzIFBvc3RNZXNzYWdlIGV2ZW50cywgbWFraW5nIHN1cmUgaXRzIGZyb20gdGhlIGNvcnJlY3QgaWZyYW1lLlxuXHQgKiBAcGFyYW0gZXZlbnQgdGhlIGRlZmF1bHQgUG9zdE1lc3NhZ2UgZXZlbnRcblx0ICovXG5cdEBIb3N0TGlzdGVuZXIoJ3dpbmRvdzptZXNzYWdlJywgWyckZXZlbnQnXSlcblx0b25GcmFtZU1lc3NhZ2UoZXZlbnQpIHtcblx0XHRjb25zdCB7IHNvdXJjZSwgZGF0YSB9ID0gZXZlbnQ7XG5cdFx0aWYgKHNvdXJjZSAhPT0gdGhpcy5mcmFtZSkge1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblx0XHRjb25zdCBwbWV2ZW50ID0gZGF0YSBhcyBQb3N0TWVzc2FnZUV2ZW50O1xuXHRcdHN3aXRjaCAocG1ldmVudC50eXBlKSB7XG5cdFx0XHRjYXNlICdtYXRjaC1zZWxlY3QnOlxuXHRcdFx0XHR0aGlzLmhhbmRsZU1hdGNoU2VsZWN0KHBtZXZlbnQpO1xuXHRcdFx0XHRicmVhaztcblx0XHRcdGNhc2UgJ3VwZ3JhZGUtcGxhbic6XG5cdFx0XHRcdHRoaXMuaGFuZGxlVXBncmFkZVBsYW5FdmVudCgpO1xuXHRcdFx0XHRicmVhaztcblx0XHRcdGNhc2UgJ21hdGNoLXdhcm4nOlxuXHRcdFx0XHRjb25zb2xlLndhcm4oJ21hdGNoIG5vdCBmb3VuZCcpO1xuXHRcdFx0XHRicmVhaztcblx0XHRcdGRlZmF1bHQ6XG5cdFx0XHRcdGNvbnNvbGUuZXJyb3IoJ3Vua25vd24gZXZlbnQnLCBwbWV2ZW50KTtcblx0XHR9XG5cdH1cblx0LyoqXG5cdCAqIEhhbmRsZXMgdGhlICd1cGdyYWRlLXBsYW4nIGV2ZW50XG5cdCAqL1xuXHRoYW5kbGVVcGdyYWRlUGxhbkV2ZW50KCkge1xuXHRcdHRoaXMucmVwb3J0U2VydmljZS51cGdyYWRlUGxhbkV2ZW50KCk7XG5cdH1cblxuXHRwcm90ZWN0ZWQgZ2V0IGZyYW1lKCkge1xuXHRcdHJldHVybiB0aGlzLmVsZW1lbnQubmF0aXZlRWxlbWVudC5jb250ZW50V2luZG93O1xuXHR9XG5cblx0LyoqXG5cdCAqIFNlbmQgYSBtZXNzYWdlIHRvIHRoZSBpZnJhbWUgdXNpbmcgUG9zdE1lc3NhZ2UgQVBJXG5cdCAqIEBwYXJhbSBkYXRhIHRoZSBkYXRhIHRvIHBvc3Rcblx0ICovXG5cdHByb3RlY3RlZCBtZXNzYWdlRnJhbWUoZGF0YTogYW55KSB7XG5cdFx0dGhpcy5mcmFtZSAmJiB0aGlzLmZyYW1lLnBvc3RNZXNzYWdlKGRhdGEsICcqJyk7XG5cdH1cblxuXHQvKipcblx0ICogU2V0IHRoZSBpZnJhbWUgc3JjZG9jIGh0bWwgdG8gdGhlIGdpdmVuIGh0bWwgc3RyaW5nXG5cdCAqIEBwYXJhbSBodG1sIHRoZSBodG1sIHN0cmluZ1xuXHQgKi9cblx0cHJvdGVjdGVkIHNldEh0bWwoaHRtbDogc3RyaW5nKSB7XG5cdFx0dGhpcy5yZW5kZXJlci5zZXRBdHRyaWJ1dGUodGhpcy5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQsICdzcmNkb2MnLCBodG1sICsgdGhpcy5zdHlsZSArIHRoaXMuc2NyaXB0KTtcblx0fVxuXG5cdC8qKlxuXHQgKiBoaWdobGlnaHQgYSBzaW5nbGUgbWF0Y2ggaW4gdGhlIGlmcmFtZVxuXHQgKiBAcGFyYW0gaW5kZXggdGhlIGluZGV4IG9mIHRoZSBtYXRjaCB0byBtYXJrXG5cdCAqL1xuXHRwcm90ZWN0ZWQgbWFya1NpbmdsZU1hdGNoSW5GcmFtZShpbmRleDogbnVtYmVyKSB7XG5cdFx0dGhpcy5tZXNzYWdlRnJhbWUoeyB0eXBlOiAnbWF0Y2gtc2VsZWN0JywgaW5kZXggfSBhcyBNYXRjaFNlbGVjdEV2ZW50KTtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZW5kZXIgbGlzdCBvZiBtYXRjaGVzIGluIHRoZSBpZnJhbWUncyBIVE1MXG5cdCAqIEBwYXJhbSBtYXRjaGVzIHRoZSBtYXRjaGVzIHRvIHJlbmRlclxuXHQgKi9cblx0cHJvdGVjdGVkIHJlbmRlck1hdGNoZXMobWF0Y2hlczogTWF0Y2hbXSkge1xuXHRcdHRoaXMubWF0Y2hlcyA9IG1hdGNoZXM7XG5cdFx0Y29uc3QgaHRtbCA9IG1hdGNoZXMucmVkdWNlUmlnaHQoKHByZXY6IHN0cmluZywgY3VycjogTWF0Y2gsIGk6IG51bWJlcikgPT4ge1xuXHRcdFx0bGV0IHNsaWNlID0gdGhpcy5odG1sPy5zdWJzdHJpbmcoY3Vyci5zdGFydCwgY3Vyci5lbmQpO1xuXHRcdFx0c3dpdGNoIChjdXJyLnR5cGUpIHtcblx0XHRcdFx0Y2FzZSBNYXRjaFR5cGUuZXhjbHVkZWQ6XG5cdFx0XHRcdFx0aWYgKGN1cnIucmVhc29uID09PSBFeGNsdWRlUmVhc29uLlBhcnRpYWxTY2FuKSB7XG5cdFx0XHRcdFx0XHRzbGljZSA9IGA8c3BhbiBleGNsdWRlLXBhcnRpYWwtc2NhbiBkYXRhLXR5cGU9XCIke2N1cnIudHlwZX1cIiBkYXRhLWluZGV4PVwiJHtpfVwiIHRpdGxlPVwiJHtcblx0XHRcdFx0XHRcdFx0dGhpcy5FWENMVURFX01FU1NBR0VbY3Vyci5yZWFzb25dXG5cdFx0XHRcdFx0XHR9XCI+JHtzbGljZX08L3NwYW4+YDtcblx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0c2xpY2UgPSBgPHNwYW4gZXhjbHVkZSB0aXRsZT1cIiR7dGhpcy5FWENMVURFX01FU1NBR0VbY3Vyci5yZWFzb25dfVwiPiR7c2xpY2V9PC9zcGFuPmA7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHRjYXNlIE1hdGNoVHlwZS5ub25lOlxuXHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHRkZWZhdWx0OlxuXHRcdFx0XHRcdHNsaWNlID0gYDxzcGFuIG1hdGNoIGRhdGEtdHlwZT1cIiR7Y3Vyci50eXBlfVwiIGRhdGEtaW5kZXg9XCIke2l9XCIgZGF0YS1naWQ9XCIke2N1cnIuZ2lkfVwiPiR7c2xpY2V9PC9zcGFuPmA7XG5cdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHR9XG5cdFx0XHRyZXR1cm4gc2xpY2UgPyBzbGljZT8uY29uY2F0KHByZXYpIDogJyc7XG5cdFx0fSwgJycpO1xuXHRcdHRoaXMucmVuZGVyZXIuc2V0QXR0cmlidXRlKHRoaXMuZWxlbWVudC5uYXRpdmVFbGVtZW50LCAnc3JjZG9jJywgaHRtbCArIHRoaXMuc3R5bGUgKyB0aGlzLnNjcmlwdCk7XG5cdH1cbn1cbiJdfQ==