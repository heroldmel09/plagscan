import { ContentChildren, Directive, Input } from '@angular/core';
import { filter, take, withLatestFrom } from 'rxjs/operators';
import { untilDestroy } from '../../../shared/operators/untilDestroy';
import * as helpers from '../../utils/highlight-helpers';
import { MatchComponent } from '../match/match.component';
import * as i0 from "@angular/core";
import * as i1 from "../../services/highlight.service";
import * as i2 from "../../services/report.service";
export class SuspectTextHelperDirective {
    constructor(highlightService, reportService) {
        this.highlightService = highlightService;
        this.reportService = reportService;
    }
    /**
     * Handle a match click that was broadcasted by the source text helper
     * @param elem the broadcasted element
     * @param suspect the suspected scan result
     * @param contentMode content mode of the broadcasting match
     */
    handleBroadcast(match, suspect, contentMode) {
        const [, start] = helpers.findRespectiveMatch(match, suspect[contentMode].comparison, true);
        const page = helpers.findRespectivePage(start, suspect.text.pages.startPosition);
        if (page === this.host.currentPage) {
            const comp = this.children.find(item => item.match.start === start);
            if (comp === null) {
                throw new Error('Match component was not found in view');
            }
            this.highlightService.textMatchClicked({ elem: comp, broadcast: false, origin: 'suspect' });
        }
        else {
            this.children.changes.pipe(take(1)).subscribe(() => {
                const comp = this.children.find(item => item.match.start === start);
                if (comp === null) {
                    throw new Error('Match component was not found in view');
                }
                this.highlightService.textMatchClicked({ elem: comp, broadcast: false, origin: 'suspect' });
            });
            this.host.currentPage = page;
        }
    }
    /**
     * Life-cycle method
     * - listen to text match clicks from `source`
     */
    ngAfterContentInit() {
        const { suspectResult$: suspect$, contentMode$ } = this.reportService;
        const { textMatchClick$, sourceHtml$ } = this.highlightService;
        textMatchClick$
            .pipe(untilDestroy(this), filter(ev => ev.origin === 'source' && ev.broadcast), withLatestFrom(suspect$))
            .subscribe(([{ elem }, suspect]) => {
            if (elem) {
                this.handleBroadcast(elem.match, suspect.result, 'text');
            }
        });
        sourceHtml$
            .pipe(withLatestFrom(suspect$, contentMode$), filter(([, , content]) => content === 'html'), filter(([, suspect]) => suspect && suspect.result && !suspect.result.html.value))
            .subscribe(([match, suspect]) => this.handleBroadcast(match, suspect.result, 'html'));
    }
    /**
     * Life-cycle method
     * empty for `untilDestroy` rxjs operator
     */
    ngOnDestroy() { }
}
SuspectTextHelperDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.3.3", ngImport: i0, type: SuspectTextHelperDirective, deps: [{ token: i1.HighlightService }, { token: i2.ReportService }], target: i0.ɵɵFactoryTarget.Directive });
SuspectTextHelperDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "13.3.3", type: SuspectTextHelperDirective, selector: "[crSuspectTextHelper]", inputs: { host: "host" }, queries: [{ propertyName: "children", predicate: MatchComponent }], ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.3.3", ngImport: i0, type: SuspectTextHelperDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: '[crSuspectTextHelper]',
                }]
        }], ctorParameters: function () { return [{ type: i1.HighlightService }, { type: i2.ReportService }]; }, propDecorators: { host: [{
                type: Input
            }], children: [{
                type: ContentChildren,
                args: [MatchComponent]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3VzcGVjdC10ZXh0LWhlbHBlci5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9wbGFnaWFyaXNtLXJlcG9ydC9zcmMvbGliL3BsYWdpYXJpc20tcmVwb3J0L2NvbXBvbmVudHMvdGV4dC1oZWxwZXJzL3N1c3BlY3QtdGV4dC1oZWxwZXIuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBb0IsZUFBZSxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQXdCLE1BQU0sZUFBZSxDQUFDO0FBQzFHLE9BQU8sRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLGNBQWMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzlELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSx3Q0FBd0MsQ0FBQztBQUl0RSxPQUFPLEtBQUssT0FBTyxNQUFNLCtCQUErQixDQUFDO0FBQ3pELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQzs7OztBQUsxRCxNQUFNLE9BQU8sMEJBQTBCO0lBRXRDLFlBQW9CLGdCQUFrQyxFQUFVLGFBQTRCO1FBQXhFLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFBVSxrQkFBYSxHQUFiLGFBQWEsQ0FBZTtJQUFHLENBQUM7SUFLaEc7Ozs7O09BS0c7SUFDSCxlQUFlLENBQUMsS0FBWSxFQUFFLE9BQW1CLEVBQUUsV0FBd0I7UUFDMUUsTUFBTSxDQUFDLEVBQUUsS0FBSyxDQUFDLEdBQUcsT0FBTyxDQUFDLG1CQUFtQixDQUFDLEtBQUssRUFBRSxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQzVGLE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDakYsSUFBSSxJQUFJLEtBQUssSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUU7WUFDbkMsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssS0FBSyxLQUFLLENBQUMsQ0FBQztZQUNwRSxJQUFJLElBQUksS0FBSyxJQUFJLEVBQUU7Z0JBQ2xCLE1BQU0sSUFBSSxLQUFLLENBQUMsdUNBQXVDLENBQUMsQ0FBQzthQUN6RDtZQUNELElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQztTQUM1RjthQUFNO1lBQ04sSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUU7Z0JBQ2xELE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLEtBQUssS0FBSyxDQUFDLENBQUM7Z0JBQ3BFLElBQUksSUFBSSxLQUFLLElBQUksRUFBRTtvQkFDbEIsTUFBTSxJQUFJLEtBQUssQ0FBQyx1Q0FBdUMsQ0FBQyxDQUFDO2lCQUN6RDtnQkFDRCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsZ0JBQWdCLENBQUMsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUM7WUFDN0YsQ0FBQyxDQUFDLENBQUM7WUFDSCxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7U0FDN0I7SUFDRixDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsa0JBQWtCO1FBQ2pCLE1BQU0sRUFBRSxjQUFjLEVBQUUsUUFBUSxFQUFFLFlBQVksRUFBRSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUM7UUFDdEUsTUFBTSxFQUFFLGVBQWUsRUFBRSxXQUFXLEVBQUUsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUM7UUFDL0QsZUFBZTthQUNiLElBQUksQ0FDSixZQUFZLENBQUMsSUFBSSxDQUFDLEVBQ2xCLE1BQU0sQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEtBQUssUUFBUSxJQUFJLEVBQUUsQ0FBQyxTQUFTLENBQUMsRUFDcEQsY0FBYyxDQUFDLFFBQVEsQ0FBQyxDQUN4QjthQUNBLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLEVBQUUsRUFBRSxPQUFPLENBQUMsRUFBRSxFQUFFO1lBQ2xDLElBQUksSUFBSSxFQUFFO2dCQUNULElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxPQUFPLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDO2FBQ3pEO1FBQ0YsQ0FBQyxDQUFDLENBQUM7UUFFSixXQUFXO2FBQ1QsSUFBSSxDQUNKLGNBQWMsQ0FBQyxRQUFRLEVBQUUsWUFBWSxDQUFDLEVBQ3RDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxBQUFELEVBQUcsT0FBTyxDQUFDLEVBQUUsRUFBRSxDQUFDLE9BQU8sS0FBSyxNQUFNLENBQUMsRUFDN0MsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxFQUFFLEVBQUUsQ0FBQyxPQUFPLElBQUksT0FBTyxDQUFDLE1BQU0sSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUNoRjthQUNBLFNBQVMsQ0FBQyxDQUFDLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLEtBQUssRUFBRSxPQUFPLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUM7SUFDeEYsQ0FBQztJQUNEOzs7T0FHRztJQUNILFdBQVcsS0FBSSxDQUFDOzt1SEFqRUosMEJBQTBCOzJHQUExQiwwQkFBMEIsZ0hBSXJCLGNBQWM7MkZBSm5CLDBCQUEwQjtrQkFIdEMsU0FBUzttQkFBQztvQkFDVixRQUFRLEVBQUUsdUJBQXVCO2lCQUNqQzttSUFFZ0IsSUFBSTtzQkFBbkIsS0FBSztnQkFJRSxRQUFRO3NCQURmLGVBQWU7dUJBQUMsY0FBYyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFmdGVyQ29udGVudEluaXQsIENvbnRlbnRDaGlsZHJlbiwgRGlyZWN0aXZlLCBJbnB1dCwgT25EZXN0cm95LCBRdWVyeUxpc3QgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGZpbHRlciwgdGFrZSwgd2l0aExhdGVzdEZyb20gfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyB1bnRpbERlc3Ryb3kgfSBmcm9tICcuLi8uLi8uLi9zaGFyZWQvb3BlcmF0b3JzL3VudGlsRGVzdHJveSc7XG5pbXBvcnQgeyBDb250ZW50TW9kZSwgTWF0Y2gsIFNjYW5SZXN1bHQgfSBmcm9tICcuLi8uLi9tb2RlbHMnO1xuaW1wb3J0IHsgSGlnaGxpZ2h0U2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL2hpZ2hsaWdodC5zZXJ2aWNlJztcbmltcG9ydCB7IFJlcG9ydFNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9yZXBvcnQuc2VydmljZSc7XG5pbXBvcnQgKiBhcyBoZWxwZXJzIGZyb20gJy4uLy4uL3V0aWxzL2hpZ2hsaWdodC1oZWxwZXJzJztcbmltcG9ydCB7IE1hdGNoQ29tcG9uZW50IH0gZnJvbSAnLi4vbWF0Y2gvbWF0Y2guY29tcG9uZW50JztcblxuQERpcmVjdGl2ZSh7XG5cdHNlbGVjdG9yOiAnW2NyU3VzcGVjdFRleHRIZWxwZXJdJyxcbn0pXG5leHBvcnQgY2xhc3MgU3VzcGVjdFRleHRIZWxwZXJEaXJlY3RpdmUgaW1wbGVtZW50cyBBZnRlckNvbnRlbnRJbml0LCBPbkRlc3Ryb3kge1xuXHRASW5wdXQoKSBwdWJsaWMgaG9zdDogeyBjdXJyZW50UGFnZTogbnVtYmVyIH07XG5cdGNvbnN0cnVjdG9yKHByaXZhdGUgaGlnaGxpZ2h0U2VydmljZTogSGlnaGxpZ2h0U2VydmljZSwgcHJpdmF0ZSByZXBvcnRTZXJ2aWNlOiBSZXBvcnRTZXJ2aWNlKSB7fVxuXG5cdEBDb250ZW50Q2hpbGRyZW4oTWF0Y2hDb21wb25lbnQpXG5cdHByaXZhdGUgY2hpbGRyZW46IFF1ZXJ5TGlzdDxNYXRjaENvbXBvbmVudD47XG5cblx0LyoqXG5cdCAqIEhhbmRsZSBhIG1hdGNoIGNsaWNrIHRoYXQgd2FzIGJyb2FkY2FzdGVkIGJ5IHRoZSBzb3VyY2UgdGV4dCBoZWxwZXJcblx0ICogQHBhcmFtIGVsZW0gdGhlIGJyb2FkY2FzdGVkIGVsZW1lbnRcblx0ICogQHBhcmFtIHN1c3BlY3QgdGhlIHN1c3BlY3RlZCBzY2FuIHJlc3VsdFxuXHQgKiBAcGFyYW0gY29udGVudE1vZGUgY29udGVudCBtb2RlIG9mIHRoZSBicm9hZGNhc3RpbmcgbWF0Y2hcblx0ICovXG5cdGhhbmRsZUJyb2FkY2FzdChtYXRjaDogTWF0Y2gsIHN1c3BlY3Q6IFNjYW5SZXN1bHQsIGNvbnRlbnRNb2RlOiBDb250ZW50TW9kZSkge1xuXHRcdGNvbnN0IFssIHN0YXJ0XSA9IGhlbHBlcnMuZmluZFJlc3BlY3RpdmVNYXRjaChtYXRjaCwgc3VzcGVjdFtjb250ZW50TW9kZV0uY29tcGFyaXNvbiwgdHJ1ZSk7XG5cdFx0Y29uc3QgcGFnZSA9IGhlbHBlcnMuZmluZFJlc3BlY3RpdmVQYWdlKHN0YXJ0LCBzdXNwZWN0LnRleHQucGFnZXMuc3RhcnRQb3NpdGlvbik7XG5cdFx0aWYgKHBhZ2UgPT09IHRoaXMuaG9zdC5jdXJyZW50UGFnZSkge1xuXHRcdFx0Y29uc3QgY29tcCA9IHRoaXMuY2hpbGRyZW4uZmluZChpdGVtID0+IGl0ZW0ubWF0Y2guc3RhcnQgPT09IHN0YXJ0KTtcblx0XHRcdGlmIChjb21wID09PSBudWxsKSB7XG5cdFx0XHRcdHRocm93IG5ldyBFcnJvcignTWF0Y2ggY29tcG9uZW50IHdhcyBub3QgZm91bmQgaW4gdmlldycpO1xuXHRcdFx0fVxuXHRcdFx0dGhpcy5oaWdobGlnaHRTZXJ2aWNlLnRleHRNYXRjaENsaWNrZWQoeyBlbGVtOiBjb21wLCBicm9hZGNhc3Q6IGZhbHNlLCBvcmlnaW46ICdzdXNwZWN0JyB9KTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhpcy5jaGlsZHJlbi5jaGFuZ2VzLnBpcGUodGFrZSgxKSkuc3Vic2NyaWJlKCgpID0+IHtcblx0XHRcdFx0Y29uc3QgY29tcCA9IHRoaXMuY2hpbGRyZW4uZmluZChpdGVtID0+IGl0ZW0ubWF0Y2guc3RhcnQgPT09IHN0YXJ0KTtcblx0XHRcdFx0aWYgKGNvbXAgPT09IG51bGwpIHtcblx0XHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ01hdGNoIGNvbXBvbmVudCB3YXMgbm90IGZvdW5kIGluIHZpZXcnKTtcblx0XHRcdFx0fVxuXHRcdFx0XHR0aGlzLmhpZ2hsaWdodFNlcnZpY2UudGV4dE1hdGNoQ2xpY2tlZCh7IGVsZW06IGNvbXAsIGJyb2FkY2FzdDogZmFsc2UsIG9yaWdpbjogJ3N1c3BlY3QnIH0pO1xuXHRcdFx0fSk7XG5cdFx0XHR0aGlzLmhvc3QuY3VycmVudFBhZ2UgPSBwYWdlO1xuXHRcdH1cblx0fVxuXG5cdC8qKlxuXHQgKiBMaWZlLWN5Y2xlIG1ldGhvZFxuXHQgKiAtIGxpc3RlbiB0byB0ZXh0IG1hdGNoIGNsaWNrcyBmcm9tIGBzb3VyY2VgXG5cdCAqL1xuXHRuZ0FmdGVyQ29udGVudEluaXQoKSB7XG5cdFx0Y29uc3QgeyBzdXNwZWN0UmVzdWx0JDogc3VzcGVjdCQsIGNvbnRlbnRNb2RlJCB9ID0gdGhpcy5yZXBvcnRTZXJ2aWNlO1xuXHRcdGNvbnN0IHsgdGV4dE1hdGNoQ2xpY2skLCBzb3VyY2VIdG1sJCB9ID0gdGhpcy5oaWdobGlnaHRTZXJ2aWNlO1xuXHRcdHRleHRNYXRjaENsaWNrJFxuXHRcdFx0LnBpcGUoXG5cdFx0XHRcdHVudGlsRGVzdHJveSh0aGlzKSxcblx0XHRcdFx0ZmlsdGVyKGV2ID0+IGV2Lm9yaWdpbiA9PT0gJ3NvdXJjZScgJiYgZXYuYnJvYWRjYXN0KSxcblx0XHRcdFx0d2l0aExhdGVzdEZyb20oc3VzcGVjdCQpXG5cdFx0XHQpXG5cdFx0XHQuc3Vic2NyaWJlKChbeyBlbGVtIH0sIHN1c3BlY3RdKSA9PiB7XG5cdFx0XHRcdGlmIChlbGVtKSB7XG5cdFx0XHRcdFx0dGhpcy5oYW5kbGVCcm9hZGNhc3QoZWxlbS5tYXRjaCwgc3VzcGVjdC5yZXN1bHQsICd0ZXh0Jyk7XG5cdFx0XHRcdH1cblx0XHRcdH0pO1xuXG5cdFx0c291cmNlSHRtbCRcblx0XHRcdC5waXBlKFxuXHRcdFx0XHR3aXRoTGF0ZXN0RnJvbShzdXNwZWN0JCwgY29udGVudE1vZGUkKSxcblx0XHRcdFx0ZmlsdGVyKChbLCAsIGNvbnRlbnRdKSA9PiBjb250ZW50ID09PSAnaHRtbCcpLFxuXHRcdFx0XHRmaWx0ZXIoKFssIHN1c3BlY3RdKSA9PiBzdXNwZWN0ICYmIHN1c3BlY3QucmVzdWx0ICYmICFzdXNwZWN0LnJlc3VsdC5odG1sLnZhbHVlKVxuXHRcdFx0KVxuXHRcdFx0LnN1YnNjcmliZSgoW21hdGNoLCBzdXNwZWN0XSkgPT4gdGhpcy5oYW5kbGVCcm9hZGNhc3QobWF0Y2gsIHN1c3BlY3QucmVzdWx0LCAnaHRtbCcpKTtcblx0fVxuXHQvKipcblx0ICogTGlmZS1jeWNsZSBtZXRob2Rcblx0ICogZW1wdHkgZm9yIGB1bnRpbERlc3Ryb3lgIHJ4anMgb3BlcmF0b3Jcblx0ICovXG5cdG5nT25EZXN0cm95KCkge31cbn1cbiJdfQ==