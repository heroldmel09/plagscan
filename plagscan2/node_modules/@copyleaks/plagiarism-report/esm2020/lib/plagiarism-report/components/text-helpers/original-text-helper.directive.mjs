import { ContentChildren, Directive, Input } from '@angular/core';
import { distinctUntilChanged, filter, take, withLatestFrom } from 'rxjs/operators';
import { untilDestroy } from '../../../shared/operators/untilDestroy';
import * as helpers from '../../utils/highlight-helpers';
import { MatchComponent } from '../match/match.component';
import * as i0 from "@angular/core";
import * as i1 from "../../services/report.service";
import * as i2 from "../../services/highlight.service";
export class OriginalTextHelperDirective {
    constructor(reportService, highlightService) {
        this.reportService = reportService;
        this.highlightService = highlightService;
    }
    /**
     * Handles the jump logic
     * @param forward the direction of the jump
     */
    handleJump(forward) {
        if (this.canJumpInCurrentPage(forward)) {
            const components = this.children.toArray();
            const nextIndex = this.current ? components.indexOf(this.current) + (forward ? 1 : -1) : 0;
            this.highlightService.textMatchClicked({ elem: components[nextIndex], broadcast: true, origin: 'original' });
        }
        else {
            const page = (forward ? helpers.findNextPageWithMatch : helpers.findPrevPageWithMatch)(this.host.textMatches, this.host.currentPage);
            if (this.host.currentPage !== page) {
                this.children.changes.pipe(take(1)).subscribe(() => {
                    const comp = forward ? this.children.first : this.children.last;
                    this.highlightService.textMatchClicked({ elem: comp, broadcast: true, origin: 'original' });
                });
                this.host.currentPage = page;
            }
        }
    }
    /**
     * Checks whether it is possible to jump forward/backward in the current page
     * @param forward the direction of the jump
     */
    canJumpInCurrentPage(forward) {
        if (this.current) {
            return forward ? this.current !== this.children.last : this.current !== this.children.first;
        }
        else {
            return this.children.length > 0;
        }
    }
    /**
     * Life-cycle method
     * - subscribe to text jump clicks
     * - subscribe to original text selected match state
     */
    ngAfterContentInit() {
        const { contentMode$, viewMode$ } = this.reportService;
        const { jump$, originalText$, textMatchClick$ } = this.highlightService;
        originalText$.pipe(untilDestroy(this)).subscribe(value => (this.current = value));
        jump$
            .pipe(untilDestroy(this), withLatestFrom(viewMode$, contentMode$), filter(([, view, content]) => view === 'one-to-many' && content === 'text'))
            .subscribe(([forward]) => this.handleJump(forward));
        textMatchClick$
            .pipe(distinctUntilChanged(), untilDestroy(this), withLatestFrom(viewMode$, contentMode$), filter(([textMatchClickEvent, view, content]) => textMatchClickEvent && view === 'one-to-many' && content === 'text'))
            .subscribe(([textMatchClickEvent, ,]) => {
            this.lastSelectedOriginalTextMatch = textMatchClickEvent;
        });
        viewMode$
            .pipe(distinctUntilChanged(), untilDestroy(this), withLatestFrom(contentMode$), filter(([view, content]) => this.lastSelectedOriginalTextMatch && view === 'one-to-many' && content === 'text'))
            .subscribe(_ => {
            setTimeout(() => {
                const start = this.lastSelectedOriginalTextMatch?.elem?.match?.start;
                const end = this.lastSelectedOriginalTextMatch?.elem?.match?.end;
                const comp = this.children.find(item => item.match.start === start && item.match.end === end);
                if (comp === null) {
                    throw new Error('Match component was not found in view');
                }
                this.highlightService.textMatchClicked({ elem: comp, broadcast: false, origin: 'original' });
            }, 100);
        });
    }
    /**
     * Life-cycle method
     * empty for `untilDestroy` rxjs operator
     */
    ngOnDestroy() { }
}
OriginalTextHelperDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.3.3", ngImport: i0, type: OriginalTextHelperDirective, deps: [{ token: i1.ReportService }, { token: i2.HighlightService }], target: i0.ɵɵFactoryTarget.Directive });
OriginalTextHelperDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "13.3.3", type: OriginalTextHelperDirective, selector: "[crOriginalTextHelper]", inputs: { host: "host" }, queries: [{ propertyName: "children", predicate: MatchComponent }], ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.3.3", ngImport: i0, type: OriginalTextHelperDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: '[crOriginalTextHelper]',
                }]
        }], ctorParameters: function () { return [{ type: i1.ReportService }, { type: i2.HighlightService }]; }, propDecorators: { host: [{
                type: Input
            }], children: [{
                type: ContentChildren,
                args: [MatchComponent]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3JpZ2luYWwtdGV4dC1oZWxwZXIuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvcGxhZ2lhcmlzbS1yZXBvcnQvc3JjL2xpYi9wbGFnaWFyaXNtLXJlcG9ydC9jb21wb25lbnRzL3RleHQtaGVscGVycy9vcmlnaW5hbC10ZXh0LWhlbHBlci5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFvQixlQUFlLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBd0IsTUFBTSxlQUFlLENBQUM7QUFDMUcsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsY0FBYyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDcEYsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHdDQUF3QyxDQUFDO0FBR3RFLE9BQU8sS0FBSyxPQUFPLE1BQU0sK0JBQStCLENBQUM7QUFDekQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLDBCQUEwQixDQUFDOzs7O0FBSzFELE1BQU0sT0FBTywyQkFBMkI7SUFHdkMsWUFBb0IsYUFBNEIsRUFBVSxnQkFBa0M7UUFBeEUsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFBVSxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO0lBQUcsQ0FBQztJQU1oRzs7O09BR0c7SUFDSCxVQUFVLENBQUMsT0FBZ0I7UUFDMUIsSUFBSSxJQUFJLENBQUMsb0JBQW9CLENBQUMsT0FBTyxDQUFDLEVBQUU7WUFDdkMsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUMzQyxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDM0YsSUFBSSxDQUFDLGdCQUFnQixDQUFDLGdCQUFnQixDQUFDLEVBQUUsSUFBSSxFQUFFLFVBQVUsQ0FBQyxTQUFTLENBQUMsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsQ0FBQyxDQUFDO1NBQzdHO2FBQU07WUFDTixNQUFNLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLHFCQUFxQixDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMscUJBQXFCLENBQUMsQ0FDckYsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQ3JCLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUNyQixDQUFDO1lBQ0YsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsS0FBSyxJQUFJLEVBQUU7Z0JBQ25DLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFO29CQUNsRCxNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQztvQkFDaEUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLGdCQUFnQixDQUFDLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsQ0FBQyxDQUFDO2dCQUM3RixDQUFDLENBQUMsQ0FBQztnQkFDSCxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7YUFDN0I7U0FDRDtJQUNGLENBQUM7SUFFRDs7O09BR0c7SUFDSCxvQkFBb0IsQ0FBQyxPQUFnQjtRQUNwQyxJQUFJLElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDakIsT0FBTyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLEtBQUssSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLEtBQUssSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUM7U0FDNUY7YUFBTTtZQUNOLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO1NBQ2hDO0lBQ0YsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxrQkFBa0I7UUFDakIsTUFBTSxFQUFFLFlBQVksRUFBRSxTQUFTLEVBQUUsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDO1FBQ3ZELE1BQU0sRUFBRSxLQUFLLEVBQUUsYUFBYSxFQUFFLGVBQWUsRUFBRSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQztRQUN4RSxhQUFhLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBRWxGLEtBQUs7YUFDSCxJQUFJLENBQ0osWUFBWSxDQUFDLElBQUksQ0FBQyxFQUNsQixjQUFjLENBQUMsU0FBUyxFQUFFLFlBQVksQ0FBQyxFQUN2QyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLEtBQUssYUFBYSxJQUFJLE9BQU8sS0FBSyxNQUFNLENBQUMsQ0FDM0U7YUFDQSxTQUFTLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFFckQsZUFBZTthQUNiLElBQUksQ0FDSixvQkFBb0IsRUFBRSxFQUN0QixZQUFZLENBQUMsSUFBSSxDQUFDLEVBQ2xCLGNBQWMsQ0FBQyxTQUFTLEVBQUUsWUFBWSxDQUFDLEVBQ3ZDLE1BQU0sQ0FDTCxDQUFDLENBQUMsbUJBQW1CLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQyxFQUFFLEVBQUUsQ0FBQyxtQkFBbUIsSUFBSSxJQUFJLEtBQUssYUFBYSxJQUFJLE9BQU8sS0FBSyxNQUFNLENBQzdHLENBQ0Q7YUFDQSxTQUFTLENBQUMsQ0FBQyxDQUFDLG1CQUFtQixFQUFFLEFBQUQsRUFBRyxFQUFFLEVBQUU7WUFDdkMsSUFBSSxDQUFDLDZCQUE2QixHQUFHLG1CQUFtQixDQUFDO1FBQzFELENBQUMsQ0FBQyxDQUFDO1FBRUosU0FBUzthQUNQLElBQUksQ0FDSixvQkFBb0IsRUFBRSxFQUN0QixZQUFZLENBQUMsSUFBSSxDQUFDLEVBQ2xCLGNBQWMsQ0FBQyxZQUFZLENBQUMsRUFDNUIsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyw2QkFBNkIsSUFBSSxJQUFJLEtBQUssYUFBYSxJQUFJLE9BQU8sS0FBSyxNQUFNLENBQUMsQ0FDL0c7YUFDQSxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDZCxVQUFVLENBQUMsR0FBRyxFQUFFO2dCQUNmLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyw2QkFBNkIsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQztnQkFDckUsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLDZCQUE2QixFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsR0FBRyxDQUFDO2dCQUNqRSxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxLQUFLLEtBQUssSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsS0FBSyxHQUFHLENBQUMsQ0FBQztnQkFDOUYsSUFBSSxJQUFJLEtBQUssSUFBSSxFQUFFO29CQUNsQixNQUFNLElBQUksS0FBSyxDQUFDLHVDQUF1QyxDQUFDLENBQUM7aUJBQ3pEO2dCQUNELElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLENBQUMsQ0FBQztZQUM5RixDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDVCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7O09BR0c7SUFDSCxXQUFXLEtBQUksQ0FBQzs7d0hBcEdKLDJCQUEyQjs0R0FBM0IsMkJBQTJCLGlIQUt0QixjQUFjOzJGQUxuQiwyQkFBMkI7a0JBSHZDLFNBQVM7bUJBQUM7b0JBQ1YsUUFBUSxFQUFFLHdCQUF3QjtpQkFDbEM7bUlBRWdCLElBQUk7c0JBQW5CLEtBQUs7Z0JBS0UsUUFBUTtzQkFEZixlQUFlO3VCQUFDLGNBQWMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBZnRlckNvbnRlbnRJbml0LCBDb250ZW50Q2hpbGRyZW4sIERpcmVjdGl2ZSwgSW5wdXQsIE9uRGVzdHJveSwgUXVlcnlMaXN0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgZmlsdGVyLCB0YWtlLCB3aXRoTGF0ZXN0RnJvbSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IHVudGlsRGVzdHJveSB9IGZyb20gJy4uLy4uLy4uL3NoYXJlZC9vcGVyYXRvcnMvdW50aWxEZXN0cm95JztcbmltcG9ydCB7IEhpZ2hsaWdodFNlcnZpY2UsIFRleHRNYXRjaEhpZ2hsaWdodEV2ZW50IH0gZnJvbSAnLi4vLi4vc2VydmljZXMvaGlnaGxpZ2h0LnNlcnZpY2UnO1xuaW1wb3J0IHsgUmVwb3J0U2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL3JlcG9ydC5zZXJ2aWNlJztcbmltcG9ydCAqIGFzIGhlbHBlcnMgZnJvbSAnLi4vLi4vdXRpbHMvaGlnaGxpZ2h0LWhlbHBlcnMnO1xuaW1wb3J0IHsgTWF0Y2hDb21wb25lbnQgfSBmcm9tICcuLi9tYXRjaC9tYXRjaC5jb21wb25lbnQnO1xuXG5ARGlyZWN0aXZlKHtcblx0c2VsZWN0b3I6ICdbY3JPcmlnaW5hbFRleHRIZWxwZXJdJyxcbn0pXG5leHBvcnQgY2xhc3MgT3JpZ2luYWxUZXh0SGVscGVyRGlyZWN0aXZlIGltcGxlbWVudHMgQWZ0ZXJDb250ZW50SW5pdCwgT25EZXN0cm95IHtcblx0QElucHV0KCkgcHVibGljIGhvc3Q6IHsgdGV4dE1hdGNoZXM6IGFueTsgY3VycmVudFBhZ2U6IG51bWJlciB9O1xuXHRwcml2YXRlIGxhc3RTZWxlY3RlZE9yaWdpbmFsVGV4dE1hdGNoOiBUZXh0TWF0Y2hIaWdobGlnaHRFdmVudDtcblx0Y29uc3RydWN0b3IocHJpdmF0ZSByZXBvcnRTZXJ2aWNlOiBSZXBvcnRTZXJ2aWNlLCBwcml2YXRlIGhpZ2hsaWdodFNlcnZpY2U6IEhpZ2hsaWdodFNlcnZpY2UpIHt9XG5cblx0QENvbnRlbnRDaGlsZHJlbihNYXRjaENvbXBvbmVudClcblx0cHJpdmF0ZSBjaGlsZHJlbjogUXVlcnlMaXN0PE1hdGNoQ29tcG9uZW50Pjtcblx0cHJpdmF0ZSBjdXJyZW50OiBNYXRjaENvbXBvbmVudDtcblxuXHQvKipcblx0ICogSGFuZGxlcyB0aGUganVtcCBsb2dpY1xuXHQgKiBAcGFyYW0gZm9yd2FyZCB0aGUgZGlyZWN0aW9uIG9mIHRoZSBqdW1wXG5cdCAqL1xuXHRoYW5kbGVKdW1wKGZvcndhcmQ6IGJvb2xlYW4pIHtcblx0XHRpZiAodGhpcy5jYW5KdW1wSW5DdXJyZW50UGFnZShmb3J3YXJkKSkge1xuXHRcdFx0Y29uc3QgY29tcG9uZW50cyA9IHRoaXMuY2hpbGRyZW4udG9BcnJheSgpO1xuXHRcdFx0Y29uc3QgbmV4dEluZGV4ID0gdGhpcy5jdXJyZW50ID8gY29tcG9uZW50cy5pbmRleE9mKHRoaXMuY3VycmVudCkgKyAoZm9yd2FyZCA/IDEgOiAtMSkgOiAwO1xuXHRcdFx0dGhpcy5oaWdobGlnaHRTZXJ2aWNlLnRleHRNYXRjaENsaWNrZWQoeyBlbGVtOiBjb21wb25lbnRzW25leHRJbmRleF0sIGJyb2FkY2FzdDogdHJ1ZSwgb3JpZ2luOiAnb3JpZ2luYWwnIH0pO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRjb25zdCBwYWdlID0gKGZvcndhcmQgPyBoZWxwZXJzLmZpbmROZXh0UGFnZVdpdGhNYXRjaCA6IGhlbHBlcnMuZmluZFByZXZQYWdlV2l0aE1hdGNoKShcblx0XHRcdFx0dGhpcy5ob3N0LnRleHRNYXRjaGVzLFxuXHRcdFx0XHR0aGlzLmhvc3QuY3VycmVudFBhZ2Vcblx0XHRcdCk7XG5cdFx0XHRpZiAodGhpcy5ob3N0LmN1cnJlbnRQYWdlICE9PSBwYWdlKSB7XG5cdFx0XHRcdHRoaXMuY2hpbGRyZW4uY2hhbmdlcy5waXBlKHRha2UoMSkpLnN1YnNjcmliZSgoKSA9PiB7XG5cdFx0XHRcdFx0Y29uc3QgY29tcCA9IGZvcndhcmQgPyB0aGlzLmNoaWxkcmVuLmZpcnN0IDogdGhpcy5jaGlsZHJlbi5sYXN0O1xuXHRcdFx0XHRcdHRoaXMuaGlnaGxpZ2h0U2VydmljZS50ZXh0TWF0Y2hDbGlja2VkKHsgZWxlbTogY29tcCwgYnJvYWRjYXN0OiB0cnVlLCBvcmlnaW46ICdvcmlnaW5hbCcgfSk7XG5cdFx0XHRcdH0pO1xuXHRcdFx0XHR0aGlzLmhvc3QuY3VycmVudFBhZ2UgPSBwYWdlO1xuXHRcdFx0fVxuXHRcdH1cblx0fVxuXG5cdC8qKlxuXHQgKiBDaGVja3Mgd2hldGhlciBpdCBpcyBwb3NzaWJsZSB0byBqdW1wIGZvcndhcmQvYmFja3dhcmQgaW4gdGhlIGN1cnJlbnQgcGFnZVxuXHQgKiBAcGFyYW0gZm9yd2FyZCB0aGUgZGlyZWN0aW9uIG9mIHRoZSBqdW1wXG5cdCAqL1xuXHRjYW5KdW1wSW5DdXJyZW50UGFnZShmb3J3YXJkOiBib29sZWFuKSB7XG5cdFx0aWYgKHRoaXMuY3VycmVudCkge1xuXHRcdFx0cmV0dXJuIGZvcndhcmQgPyB0aGlzLmN1cnJlbnQgIT09IHRoaXMuY2hpbGRyZW4ubGFzdCA6IHRoaXMuY3VycmVudCAhPT0gdGhpcy5jaGlsZHJlbi5maXJzdDtcblx0XHR9IGVsc2Uge1xuXHRcdFx0cmV0dXJuIHRoaXMuY2hpbGRyZW4ubGVuZ3RoID4gMDtcblx0XHR9XG5cdH1cblxuXHQvKipcblx0ICogTGlmZS1jeWNsZSBtZXRob2Rcblx0ICogLSBzdWJzY3JpYmUgdG8gdGV4dCBqdW1wIGNsaWNrc1xuXHQgKiAtIHN1YnNjcmliZSB0byBvcmlnaW5hbCB0ZXh0IHNlbGVjdGVkIG1hdGNoIHN0YXRlXG5cdCAqL1xuXHRuZ0FmdGVyQ29udGVudEluaXQoKSB7XG5cdFx0Y29uc3QgeyBjb250ZW50TW9kZSQsIHZpZXdNb2RlJCB9ID0gdGhpcy5yZXBvcnRTZXJ2aWNlO1xuXHRcdGNvbnN0IHsganVtcCQsIG9yaWdpbmFsVGV4dCQsIHRleHRNYXRjaENsaWNrJCB9ID0gdGhpcy5oaWdobGlnaHRTZXJ2aWNlO1xuXHRcdG9yaWdpbmFsVGV4dCQucGlwZSh1bnRpbERlc3Ryb3kodGhpcykpLnN1YnNjcmliZSh2YWx1ZSA9PiAodGhpcy5jdXJyZW50ID0gdmFsdWUpKTtcblxuXHRcdGp1bXAkXG5cdFx0XHQucGlwZShcblx0XHRcdFx0dW50aWxEZXN0cm95KHRoaXMpLFxuXHRcdFx0XHR3aXRoTGF0ZXN0RnJvbSh2aWV3TW9kZSQsIGNvbnRlbnRNb2RlJCksXG5cdFx0XHRcdGZpbHRlcigoWywgdmlldywgY29udGVudF0pID0+IHZpZXcgPT09ICdvbmUtdG8tbWFueScgJiYgY29udGVudCA9PT0gJ3RleHQnKVxuXHRcdFx0KVxuXHRcdFx0LnN1YnNjcmliZSgoW2ZvcndhcmRdKSA9PiB0aGlzLmhhbmRsZUp1bXAoZm9yd2FyZCkpO1xuXG5cdFx0dGV4dE1hdGNoQ2xpY2skXG5cdFx0XHQucGlwZShcblx0XHRcdFx0ZGlzdGluY3RVbnRpbENoYW5nZWQoKSxcblx0XHRcdFx0dW50aWxEZXN0cm95KHRoaXMpLFxuXHRcdFx0XHR3aXRoTGF0ZXN0RnJvbSh2aWV3TW9kZSQsIGNvbnRlbnRNb2RlJCksXG5cdFx0XHRcdGZpbHRlcihcblx0XHRcdFx0XHQoW3RleHRNYXRjaENsaWNrRXZlbnQsIHZpZXcsIGNvbnRlbnRdKSA9PiB0ZXh0TWF0Y2hDbGlja0V2ZW50ICYmIHZpZXcgPT09ICdvbmUtdG8tbWFueScgJiYgY29udGVudCA9PT0gJ3RleHQnXG5cdFx0XHRcdClcblx0XHRcdClcblx0XHRcdC5zdWJzY3JpYmUoKFt0ZXh0TWF0Y2hDbGlja0V2ZW50LCAsXSkgPT4ge1xuXHRcdFx0XHR0aGlzLmxhc3RTZWxlY3RlZE9yaWdpbmFsVGV4dE1hdGNoID0gdGV4dE1hdGNoQ2xpY2tFdmVudDtcblx0XHRcdH0pO1xuXG5cdFx0dmlld01vZGUkXG5cdFx0XHQucGlwZShcblx0XHRcdFx0ZGlzdGluY3RVbnRpbENoYW5nZWQoKSxcblx0XHRcdFx0dW50aWxEZXN0cm95KHRoaXMpLFxuXHRcdFx0XHR3aXRoTGF0ZXN0RnJvbShjb250ZW50TW9kZSQpLFxuXHRcdFx0XHRmaWx0ZXIoKFt2aWV3LCBjb250ZW50XSkgPT4gdGhpcy5sYXN0U2VsZWN0ZWRPcmlnaW5hbFRleHRNYXRjaCAmJiB2aWV3ID09PSAnb25lLXRvLW1hbnknICYmIGNvbnRlbnQgPT09ICd0ZXh0Jylcblx0XHRcdClcblx0XHRcdC5zdWJzY3JpYmUoXyA9PiB7XG5cdFx0XHRcdHNldFRpbWVvdXQoKCkgPT4ge1xuXHRcdFx0XHRcdGNvbnN0IHN0YXJ0ID0gdGhpcy5sYXN0U2VsZWN0ZWRPcmlnaW5hbFRleHRNYXRjaD8uZWxlbT8ubWF0Y2g/LnN0YXJ0O1xuXHRcdFx0XHRcdGNvbnN0IGVuZCA9IHRoaXMubGFzdFNlbGVjdGVkT3JpZ2luYWxUZXh0TWF0Y2g/LmVsZW0/Lm1hdGNoPy5lbmQ7XG5cdFx0XHRcdFx0Y29uc3QgY29tcCA9IHRoaXMuY2hpbGRyZW4uZmluZChpdGVtID0+IGl0ZW0ubWF0Y2guc3RhcnQgPT09IHN0YXJ0ICYmIGl0ZW0ubWF0Y2guZW5kID09PSBlbmQpO1xuXHRcdFx0XHRcdGlmIChjb21wID09PSBudWxsKSB7XG5cdFx0XHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ01hdGNoIGNvbXBvbmVudCB3YXMgbm90IGZvdW5kIGluIHZpZXcnKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0dGhpcy5oaWdobGlnaHRTZXJ2aWNlLnRleHRNYXRjaENsaWNrZWQoeyBlbGVtOiBjb21wLCBicm9hZGNhc3Q6IGZhbHNlLCBvcmlnaW46ICdvcmlnaW5hbCcgfSk7XG5cdFx0XHRcdH0sIDEwMCk7XG5cdFx0XHR9KTtcblx0fVxuXG5cdC8qKlxuXHQgKiBMaWZlLWN5Y2xlIG1ldGhvZFxuXHQgKiBlbXB0eSBmb3IgYHVudGlsRGVzdHJveWAgcnhqcyBvcGVyYXRvclxuXHQgKi9cblx0bmdPbkRlc3Ryb3koKSB7fVxufVxuIl19